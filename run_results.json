{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v5.json", "dbt_version": "1.7.10", "generated_at": "2024-07-04T08:43:23.634026Z", "invocation_id": "2c12eeb0-f010-4344-b8f0-af9e353020ee", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.537956Z", "completed_at": "2024-07-04T08:31:43.546151Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.547355Z", "completed_at": "2024-07-04T08:31:43.547368Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.01160740852355957, "adapter_response": {}, "message": null, "failures": null, "unique_id": "analysis.makeopendata.multiple_agg_per_cp", "compiled": true, "compiled_code": "-- Les departements et les r\u00e9gions sont donn\u00e9es par commune\n-- Il existe plusieurs codes postaux pour une commune et plusieurs communes pour un code postal\n-- Il convient de v\u00e9rifier que pour un code postal donn\u00e9, apr\u00e8s fusion avec la table communes,\n-- Il n'y a pas qu'un seul arrondissement, un seul d\u00e9partement et une seule r\u00e9gion\nwith merged_data as (\n    select\n        LPAD(CAST(cp.code_postal AS TEXT), 5, '0') as code_postal,\n        -- cc.\"ARR\" as code_arrondissement,\n        cc.departement as code_departement,\n        cc.region as code_region\n    from \"defaultdb\".\"sources\".\"cog_poste\" cp\n    inner join \"defaultdb\".\"sources\".\"cog_communes\" cc on cp.code_commune_insee = cc.\"COM\" and cc.\"TYPECOM\" = 'COM'\n    -- Remplacer par left join \u00e0 l'inclusions des territoire d'outre mer TOM \n    -- Puisque les codes communes ne sont pas renseign\u00e9s pour ces territoires dans codes_geographiques_communes\n    -- La R\u00e9union est une region d'outre, mais pas un territoire d'outre mer, d\u00e8s lors elle est incluse dans les codes_geographiques_communes\n),\n\ncounts as (\n    select \n        code_postal,\n        --count(distinct code_arrondissement) as num_arr,\n        count(distinct code_departement) as num_dep,\n        count(distinct code_region) as num_reg\n    from merged_data\n    group by code_postal\n)\n\nselect *\nfrom counts\nwhere num_dep > 1 or num_reg > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.550878Z", "completed_at": "2024-07-04T08:31:43.553652Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.554814Z", "completed_at": "2024-07-04T08:31:43.554820Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006103038787841797, "adapter_response": {}, "message": null, "failures": null, "unique_id": "analysis.makeopendata.multiple_com_per_cp", "compiled": true, "compiled_code": "--- Montre les codes postaux qui ont plusieurs codes communes\n\nSELECT code_postal, ARRAY_AGG(DISTINCT code_commune_insee) as communes\nFROM \"defaultdb\".\"sources\".\"cog_poste\" \nGROUP BY code_postal\nHAVING COUNT(DISTINCT code_commune_insee) > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.558227Z", "completed_at": "2024-07-04T08:31:43.560992Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.562111Z", "completed_at": "2024-07-04T08:31:43.562116Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006013631820678711, "adapter_response": {}, "message": null, "failures": null, "unique_id": "analysis.makeopendata.multiple_cp_per_com", "compiled": true, "compiled_code": "--- Montre les communes qui ont plusieurs codes postaux\n\nSELECT code_commune_insee, ARRAY_AGG(DISTINCT code_postal) as postal_codes\nFROM \"defaultdb\".\"sources\".\"cog_poste\" \nGROUP BY code_commune_insee\nHAVING COUNT(DISTINCT code_postal) > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.565540Z", "completed_at": "2024-07-04T08:31:43.568442Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.569569Z", "completed_at": "2024-07-04T08:31:43.569576Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006178140640258789, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.fake_knn_data", "compiled": true, "compiled_code": "-- Pour tester la fonction knn, nous devons cr\u00e9er une table avec des donn\u00e9es fictives \n-- (impossible de faire des tests unitaires sur des donn\u00e9es qui ne sont pas dans une table). \n-- cr\u00e9e une fausse table avec id, latitude, longitude, et valeur columns\n-- S'assurer que le calcul ne se fait pas sur l'objet de la table\n\n\n\nWITH fake_knn_table AS (\n    SELECT 1 AS id, 43.7 AS latitude, 3.832 AS longitude, 100 AS valeur UNION ALL -- (3, 2) --> (200 + 300) / 2 = 250\n    SELECT 3,       43.7,             3.830,              200 UNION ALL -- (1, 2) --> (100 + 300) / 2 = 200\n    SELECT 2,       43.7,             3.831,              300 UNION ALL -- (1, 3) --> (100 + 200) / 2 = 150\n    SELECT 4,       43.7,             3.839,              400 UNION ALL -- (6, 1) --> (500 + 100) / 2 = 300\n    SELECT 6,       43.7,             3.838,              500  -- (4, 1) --> (400 + 100) / 2 = 250\n)\n\n\nselect * from fake_knn_table", "relation_name": "\"defaultdb\".\"prep\".\"fake_knn_data\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.573105Z", "completed_at": "2024-07-04T08:31:43.578231Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.579424Z", "completed_at": "2024-07-04T08:31:43.579430Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008573770523071289, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.geo_communes", "compiled": true, "compiled_code": "\n\nwith filtre_cog_communes as (\n    -- Filter out non-commune rows here to avoid confusion of filtering in the main query\n    select * \n    from \"defaultdb\".\"sources\".\"cog_communes\" as cog_communes     \n    where cog_communes.type in ('commune-actuelle', 'arrondissement-municipal')\n\n),denomalise_cog as (\n    select\n        LPAD(CAST(filtre_cog_communes.code as TEXT), 5, '0') as code_commune,\n        filtre_cog_communes.nom as nom_commune,\n        filtre_cog_communes.arrondissement as code_arrondissement,\n        filtre_cog_communes.departement as code_departement,\n        filtre_cog_communes.region as code_region,\n        \"codesPostaux\" as codes_postaux,\n        filtre_cog_communes.population as population,\n        filtre_cog_communes.zone as code_zone,\n        \n        cog_arrondissements.nom as nom_arrondissement,\n        cog_departements.nom as nom_departement,\n        cog_regions.nom as nom_region\n\n    from filtre_cog_communes\n    left join \"defaultdb\".\"sources\".\"cog_arrondissements\"  cog_arrondissements on cog_arrondissements.code = filtre_cog_communes.arrondissement\n    left join \"defaultdb\".\"sources\".\"cog_departements\"  cog_departements on cog_departements.code = filtre_cog_communes.departement\n    left join \"defaultdb\".\"sources\".\"cog_regions\"  cog_regions on cog_regions.code = filtre_cog_communes.region  \n    \n), geopoints as (\n    select DISTINCT\n        LPAD(CAST(cog_poste.code_commune_insee AS TEXT), 5, '0') as code_commune,\n        CAST(SPLIT_PART(cog_poste._geopoint, ',', 1) AS FLOAT) as commune_latitude,\n        CAST(SPLIT_PART(cog_poste._geopoint, ',', 2) AS FLOAT) as commune_longitude\n    from \"defaultdb\".\"sources\".\"cog_poste\"  as cog_poste\n)\n\nselect\n    denomalise_cog.*,\n    geopoints.commune_latitude,\n    geopoints.commune_longitude\nfrom denomalise_cog\nleft join geopoints on denomalise_cog.code_commune = geopoints.code_commune", "relation_name": "\"defaultdb\".\"prep\".\"geo_communes\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.583034Z", "completed_at": "2024-07-04T08:31:43.586572Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.587733Z", "completed_at": "2024-07-04T08:31:43.587739Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007044553756713867, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.geo_postaux", "compiled": true, "compiled_code": "\n\nwith format_cog_poste as (\n    select DISTINCT\n        LPAD(CAST(code_postal AS TEXT), 5, '0') as code_postal,\n        CASE \n            WHEN SUBSTRING(LPAD(CAST(code_postal AS TEXT), 5, '0') for 3) IN ('200', '201') THEN '2A'\n            WHEN SUBSTRING(LPAD(CAST(code_postal AS TEXT), 5, '0') for 1) = '2' THEN '2B'\n            ELSE SUBSTRING(LPAD(CAST(code_postal AS TEXT), 5, '0') for 2)\n        END as code_departement\n    from \"defaultdb\".\"sources\".\"cog_poste\" as cog_poste\n),\n\njoin_departements as (\n    select \n        format_cog_poste.*,\n        cog_departements.nom as nom_departement,\n        cog_departements.region as code_region\n    from format_cog_poste\n    left join \"defaultdb\".\"sources\".\"cog_departements\" cog_departements on format_cog_poste.code_departement = cog_departements.code\n),\n\njoin_regions as (\n    select \n        join_departements.*,\n        cog_regions.nom as nom_region\n    from join_departements\n    left join \"defaultdb\".\"sources\".\"cog_regions\" cog_regions on join_departements.code_region = cog_regions.code\n)\n\nselect *\nfrom join_regions", "relation_name": "\"defaultdb\".\"prep\".\"geo_postaux\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.591285Z", "completed_at": "2024-07-04T08:31:43.594229Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.595410Z", "completed_at": "2024-07-04T08:31:43.595416Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006389141082763672, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.geo_postaux_communes", "compiled": true, "compiled_code": "\n\nwith unique_codes_communes_postaux as (\n    select DISTINCT\n        LPAD(CAST(code_postal AS TEXT), 5, '0') as code_postal,\n        code_commune_insee\n    from \"defaultdb\".\"sources\".\"cog_poste\" as cog_poste\n)\n\nselect *\nfrom unique_codes_communes_postaux", "relation_name": "\"defaultdb\".\"prep\".\"geo_postaux_communes\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.598947Z", "completed_at": "2024-07-04T08:31:43.604715Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.605882Z", "completed_at": "2024-07-04T08:31:43.605889Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009124517440795898, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.grouper_mutations", "compiled": true, "compiled_code": "-- Filtres nature transaction et nature bien :\n-- Il convient aussi de garder que les vente (explure les VEFA et les \u00e9changes)\n-- Et que les transactions qui concernent au moins un appartement et les maisons\n\n-- Filtres sur les surfaces et trautement des pi\u00e8ces :\n-- Il convient de garder que les transactions qui concernent des biens de plus de 9m2 \n-- Le nombre de pi\u00e8ces est souvent mal renseign\u00e9, il convient de le corriger en fonction de la surface\n\n-- Filtres sur les prix :\n-- Il convient de garder que les transactions dont le prix au metre carr\u00e9 n'est pas 50% de plus que ses 10 plus proches voisins\n\n-- Donn\u00e9es par mutation : \n-- Les donn\u00e9es DVF sont initilement pr\u00e9sent\u00e9es sous forme d'une ligne par mutation (transaction)\n-- Une mutation peut concerner plusieurs biens\n-- Le prix est le prix total de la mutation, il apparait sur les biens concern\u00e9s\n\n\n\nWITH source_dvf AS (\n    select * from \"defaultdb\".\"sources\".\"dvf_2023\" as dvf_2023\n),\nfiltrer_dvf AS (\n    \n    SELECT \n        id_mutation,\n        CAST(valeur_fonciere AS FLOAT) as valeur_fonciere,\n        CAST(longitude AS FLOAT) as longitude,\n        CAST(latitude AS FLOAT) as latitude,\n        CAST(nombre_pieces_principales AS NUMERIC) as nombre_pieces_principales,\n        CAST(surface_reelle_bati AS NUMERIC) as surface_reelle_bati,\n        type_local,\n        LPAD(CAST(code_postal AS TEXT), 5, '0') as code_postal,\n        code_commune\n    FROM \n        source_dvf \n     WHERE \n        EXISTS (\n            SELECT 1\n            FROM source_dvf d1\n            WHERE d1.id_mutation = source_dvf.id_mutation AND d1.type_local IN ('Appartement', 'Maison')\n        ) AND\n        NOT EXISTS (\n            SELECT 1\n            FROM source_dvf d2\n            WHERE d2.id_mutation = source_dvf.id_mutation AND d2.nature_mutation != 'Vente'\n        )\n\n),\naggreger_dvf AS (\n    \n    SELECT \n        id_mutation,\n        SUM(CAST(surface_reelle_bati AS numeric)) AS total_surface,\n        SUM(CAST(nombre_pieces_principales AS numeric)) AS total_pieces\n    FROM \n        filtrer_dvf\n    GROUP BY \n        id_mutation\n\n),\nbien_principal_dvf AS (\n    \n    SELECT *\n    FROM (\n        SELECT \n            *,\n            ROW_NUMBER() OVER (\n                PARTITION BY id_mutation\n                ORDER BY \n                    CASE WHEN type_local = 'Maison' THEN 1\n                         WHEN type_local = 'Appartement' THEN 2\n                         ELSE 3\n                    END,\n                    surface_reelle_bati DESC\n            ) AS rang\n        FROM \n            filtrer_dvf\n    ) subquery\n    WHERE\n        rang = 1\n\n)\n\nSELECT \n    bien_principal_dvf.id_mutation,\n    bien_principal_dvf.valeur_fonciere,\n    bien_principal_dvf.longitude,\n    bien_principal_dvf.latitude,\n    aggreger_dvf.total_pieces,\n    aggreger_dvf.total_surface,\n    bien_principal_dvf.type_local,\n    bien_principal_dvf.code_postal,\n    bien_principal_dvf.code_commune\nFROM \n    bien_principal_dvf\nJOIN \n    aggreger_dvf ON aggreger_dvf.id_mutation = bien_principal_dvf.id_mutation", "relation_name": "\"defaultdb\".\"prep\".\"grouper_mutations\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.609521Z", "completed_at": "2024-07-04T08:31:43.610827Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.611964Z", "completed_at": "2024-07-04T08:31:43.611968Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.004579782485961914, "adapter_response": {}, "message": null, "failures": null, "unique_id": "seed.makeopendata.logement_2020_demographie_codes", "compiled": null, "compiled_code": null, "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.615444Z", "completed_at": "2024-07-04T08:31:43.616719Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.617849Z", "completed_at": "2024-07-04T08:31:43.617854Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.004568815231323242, "adapter_response": {}, "message": null, "failures": null, "unique_id": "seed.makeopendata.logement_2020_habitat_codes", "compiled": null, "compiled_code": null, "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.621411Z", "completed_at": "2024-07-04T08:31:43.624361Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.625497Z", "completed_at": "2024-07-04T08:31:43.625501Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006391763687133789, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_one_arr", "compiled": true, "compiled_code": "-- Test qu'il n'ya pas de doublons dans la table des codes g\u00e9ographiques des arrondissements\n\nWITH counts as (\n    select \n        cog_arrondissements.code,\n        count(*) as num_arr\n    from \"defaultdb\".\"sources\".\"cog_arrondissements\"  as cog_arrondissements \n    group by cog_arrondissements.code\n)\n\nselect *\nfrom counts\nwhere num_arr > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.628936Z", "completed_at": "2024-07-04T08:31:43.631747Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.632858Z", "completed_at": "2024-07-04T08:31:43.632863Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006000041961669922, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_one_com", "compiled": true, "compiled_code": "-- Une commune peut avoir plusieurs types\n-- COM\tCommune / COMA\tCommune associ\u00e9e / COMD\tCommune d\u00e9l\u00e9gu\u00e9e / ARM\tArrondissement municipal\n-- Les COM sont celles existantes, les autres types sont des legacy de fusions ou disparitions de communes\n\nWITH counts as (\n    select \n        cog_communes.code,\n        count(*) as num_com\n    from \"defaultdb\".\"sources\".\"cog_communes\"  as cog_communes\n    where cog_communes.type = 'commune-actuelle'\n    group by cog_communes.code\n)\n\nselect *\nfrom counts\nwhere num_com > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.636256Z", "completed_at": "2024-07-04T08:31:43.639017Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.640121Z", "completed_at": "2024-07-04T08:31:43.640126Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.005945682525634766, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_one_dep", "compiled": true, "compiled_code": "-- Test qu'il n'ya pas de doublons dans la table des codes g\u00e9ographiques des departements\n\nWITH counts as (\n    select \n        cog_departements.code,\n        count(*) as num_dep\n    from \"defaultdb\".\"sources\".\"cog_departements\" as cog_departements\n    group by cog_departements.code\n)\n\nselect *\nfrom counts\nwhere num_dep > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.643487Z", "completed_at": "2024-07-04T08:31:43.646476Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.647582Z", "completed_at": "2024-07-04T08:31:43.647586Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006190299987792969, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_one_gps_com", "compiled": true, "compiled_code": "-- https://www.data.gouv.fr/fr/datasets/base-officielle-des-codes-postaux/\n-- Mention que : contient en plus les coordonn\u00e9es des centro\u00efdes des communes est \u00e9galement disponible.\n-- V\u00e9rifions que les coordonn\u00e9es des centro\u00efdes sont bien uniques pour chaque commune\n\n\n\nwith source as (\n    SELECT code_commune_insee, COUNT(DISTINCT _geopoint) as geopoint_count\n    FROM \"defaultdb\".\"sources\".\"cog_poste\" as cog_poste\n    GROUP BY code_commune_insee\n)\n\nselect *\nfrom source\nwhere geopoint_count > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.650950Z", "completed_at": "2024-07-04T08:31:43.653875Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.655043Z", "completed_at": "2024-07-04T08:31:43.655048Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006194114685058594, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_one_price_mutation", "compiled": true, "compiled_code": "-- Dans le fichier source de dvf, les mutations apparaissent sur plusieurs ligne\n-- Il s'agit des transactions multiventes (un appartement dans une ligne et une maison dans une autre)\n-- Il s'agit donc de v\u00e9rifier que chaque mutation, donc dans les lignes o\u00f9 elle apparait, il n'a qu'une seule valeur fonci\u00e8re\n\nWITH mutation_values AS (\n    SELECT \n        id_mutation,\n        code_commune,\n        code_postal,\n        latitude,\n        longitude,\n        valeur_fonciere\n    FROM \n        \"defaultdb\".\"sources\".\"dvf_2023\" as dvf_2023\n),\n\nmutation_value_counts AS (\n    SELECT \n        id_mutation,\n        COUNT(DISTINCT valeur_fonciere) AS distinct_fonciere_count\n    FROM \n        mutation_values\n    GROUP BY \n        id_mutation\n)\n\nSELECT \n    id_mutation,\n    distinct_fonciere_count\nFROM \n    mutation_value_counts\nWHERE \n    distinct_fonciere_count > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.658424Z", "completed_at": "2024-07-04T08:31:43.662717Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.663816Z", "completed_at": "2024-07-04T08:31:43.663820Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007493734359741211, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_one_reg", "compiled": true, "compiled_code": "-- Test qu'il n'ya pas de doublons dans la table des codes g\u00e9ographiques des r\u00e9gions\n\nWITH counts as (\n    select \n        cog_regions.code,\n        count(*) as num_reg\n    from \"defaultdb\".\"sources\".\"cog_regions\" as cog_regions\n    group by cog_regions.code\n)\n\nselect *\nfrom counts\nwhere num_reg > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.667158Z", "completed_at": "2024-07-04T08:31:43.712384Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.713540Z", "completed_at": "2024-07-04T08:31:43.713546Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.048536062240600586, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.effectif_tout_departement_egal_some_region", "compiled": true, "compiled_code": "-- Teste que l'entr\u00e9e 'Tout d\u00e9partement' dans libelle de departement reporte le total des effectifs de tous les d\u00e9partements\n\n\nWITH sommes_par_departement AS (\n    SELECT \n        annee, \n        profession_sante, \n        libelle_region, \n        SUM(cast(effectif as numeric)) AS effectif_total_calcule\n    FROM \"defaultdb\".\"sources\".\"professionels_sante\"\n    WHERE libelle_departement != 'Tout departement'\n    GROUP BY annee, profession_sante, libelle_region\n),\n\t\ntout_departement AS (\n    SELECT \n        annee, \n        profession_sante, \n        libelle_region, \n        CAST(effectif as numeric) AS tout_departement_effectif\n    FROM \"defaultdb\".\"sources\".\"professionels_sante\"\n    WHERE libelle_departement = 'Tout departement'\n)\n\t\nSELECT \n    sommes_par_departement.effectif_total_calcule, \n    tout_departement.tout_departement_effectif\nFROM sommes_par_departement\nLEFT JOIN tout_departement \n    ON sommes_par_departement.annee = tout_departement.annee \n    AND sommes_par_departement.profession_sante = tout_departement.profession_sante \n    AND sommes_par_departement.libelle_region = tout_departement.libelle_region\nWHERE sommes_par_departement.effectif_total_calcule != tout_departement.tout_departement_effectif", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.717028Z", "completed_at": "2024-07-04T08:31:43.722678Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:43.723811Z", "completed_at": "2024-07-04T08:31:43.723816Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008872509002685547, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.test_knn", "compiled": true, "compiled_code": "-- depends_on: \"defaultdb\".\"prep\".\"fake_knn_data\"\n\n-- Define expected values\nWITH expected AS (\n    SELECT 1 AS id, 250 AS expected_valeur UNION ALL\n    SELECT 3,       200 UNION ALL\n    SELECT 2,       150 UNION ALL\n    SELECT 4,       300 UNION ALL\n    SELECT 6,       250\n),\n\n-- Calculate knn for each row in the fake table\ncomputed AS (\n    \nWITH knn AS (\n    SELECT \n        a.id AS id,\n        AVG(b.valeur) AS mean_knn_value\n    FROM \n        \"defaultdb\".\"prep\".\"fake_knn_data\" a\n        JOIN LATERAL (\n            SELECT valeur\n            FROM \"defaultdb\".\"prep\".\"fake_knn_data\"\n            WHERE id != a.id\n            ORDER BY ST_SetSRID(ST_MakePoint(a.longitude, a.latitude), 4326) <-> ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)\n            LIMIT 2\n        ) b ON TRUE\n    GROUP BY a.id\n)\n\nSELECT \n    a.*,\n    b.mean_knn_value\nFROM \n    \"defaultdb\".\"prep\".\"fake_knn_data\" a\n    JOIN knn b ON a.id = b.id\n\n)\n\n-- Compare computed and expected values\nSELECT \n    computed.id, \n    computed.mean_knn_value AS computed_valeur, \n    expected.expected_valeur\nFROM \n    computed\n    JOIN expected ON computed.id = expected.id\nWHERE\n    computed.mean_knn_value != expected.expected_valeur", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:43.727238Z", "completed_at": "2024-07-04T08:31:45.334386Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:45.335668Z", "completed_at": "2024-07-04T08:31:45.335676Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 1.6982522010803223, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.aggeger_effectifs_sante_departement_2022", "compiled": true, "compiled_code": "\n\nwith aggreger_effectif_sante_unpivot as (\n\tselect \n\t\tregion,\n\t\tlibelle_region,\n\t\tdepartement,\n\t\tlibelle_departement,\n\t\tprofession_sante,\n\t\tsum(cast(effectif as numeric)) as effectif\n\tFROM \"defaultdb\".\"sources\".\"professionels_sante\"\n\twhere (annee = '2022') and (libelle_departement != 'Tout d\u00e9partement')  and (libelle_departement != 'FRANCE')\n\tgroup by region, departement, libelle_region, libelle_departement, profession_sante\n),\naggreger_effectif_sante_departements as (\n\tselect \n\t\tregion,\n\t\tlibelle_region,\n\t\tdepartement,\n\t\tlibelle_departement,\n\t\t\n  \n    sum(\n      \n      case\n      when profession_sante = 'Stomatologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Stomatologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Anesth\u00e9sistes-r\u00e9animateurs'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Anesth\u00e9sistes-r\u00e9animateurs\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Autres m\u00e9decins'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Autres m\u00e9decins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Cardiologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Cardiologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Chirurgiens'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Chirurgiens\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Chirurgiens-dentistes (hors sp\u00e9cialistes d''orthop\u00e9die dento-faciale - ODF)'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Chirurgiens-dentistes (hors sp\u00e9cialistes d'orthop\u00e9die dento-faciale - ODF)\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Chirurgiens-dentistes sp\u00e9cialistes d''orthop\u00e9die dento-faciale (ODF)'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Chirurgiens-dentistes sp\u00e9cialistes d'orthop\u00e9die dento-faciale (ODF)\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Dermatologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Dermatologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Endocrinologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Endocrinologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Ensemble des auxiliaires m\u00e9dicaux'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Ensemble des auxiliaires m\u00e9dicaux\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Ensemble des chirurgiens-dentistes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Ensemble des chirurgiens-dentistes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Ensemble des m\u00e9decins'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Ensemble des m\u00e9decins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Ensemble des m\u00e9decins g\u00e9n\u00e9ralistes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Ensemble des m\u00e9decins g\u00e9n\u00e9ralistes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Ensemble des m\u00e9decins sp\u00e9cialistes (hors g\u00e9n\u00e9ralistes)'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Ensemble des m\u00e9decins sp\u00e9cialistes (hors g\u00e9n\u00e9ralistes)\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Gyn\u00e9cologues m\u00e9dicaux et obst\u00e9triciens'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Gyn\u00e9cologues m\u00e9dicaux et obst\u00e9triciens\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'H\u00e9pato-gastro-ent\u00e9rologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"H\u00e9pato-gastro-ent\u00e9rologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Infirmiers'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Infirmiers\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Masseurs-kin\u00e9sith\u00e9rapeutes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Masseurs-kin\u00e9sith\u00e9rapeutes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'M\u00e9decins g\u00e9n\u00e9ralistes \u00e0 expertise particuli\u00e8re (MEP)'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"M\u00e9decins g\u00e9n\u00e9ralistes \u00e0 expertise particuli\u00e8re (MEP)\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'M\u00e9decins g\u00e9n\u00e9ralistes (hors m\u00e9decins \u00e0 expertise particuli\u00e8re - MEP)'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"M\u00e9decins g\u00e9n\u00e9ralistes (hors m\u00e9decins \u00e0 expertise particuli\u00e8re - MEP)\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'M\u00e9decins nucl\u00e9aires'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"M\u00e9decins nucl\u00e9aires\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'M\u00e9decins pathologistes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"M\u00e9decins pathologistes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Rhumatologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Rhumatologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Sages-femmes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Sages-femmes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'N\u00e9phrologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"N\u00e9phrologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Neurologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Neurologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Ophtalmologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Ophtalmologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Orthophonistes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Orthophonistes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Orthoptistes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Orthoptistes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Oto-rhino-laryngologistes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Oto-rhino-laryngologistes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'P\u00e9diatres'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"P\u00e9diatres\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'P\u00e9dicures-podologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"P\u00e9dicures-podologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Pneumologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Pneumologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Psychiatres'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Psychiatres\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Radiologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Radiologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Radioth\u00e9rapeutes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Radioth\u00e9rapeutes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'M\u00e9decins vasculaires'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"M\u00e9decins vasculaires\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Allergologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Allergologues\"\n      \n    \n    \n  \n\n  \tFROM aggreger_effectif_sante_unpivot\n\tgroup by region, libelle_region, departement, libelle_departement\n),\ninfos_par_departement as (\n\tselect \n\t\tcode_departement,\n\t\tsum(cast(population as numeric)) as population_departement,\n\t\tavg(commune_latitude) as latitude_centre_departement,\n\t\tavg(commune_longitude) as longitude_centre_departement\n\tfrom \"defaultdb\".\"prep\".\"geo_communes\"\n\tgroup by code_departement\n)\n\nselect \n\taggreger_effectif_sante_departements.*,\n\tinfos_par_departement.population_departement,\n\tinfos_par_departement.latitude_centre_departement,\n\tinfos_par_departement.longitude_centre_departement\nfrom aggreger_effectif_sante_departements\nleft join infos_par_departement \non aggreger_effectif_sante_departements.departement = infos_par_departement.code_departement", "relation_name": "\"defaultdb\".\"prep\".\"aggeger_effectifs_sante_departement_2022\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:45.427230Z", "completed_at": "2024-07-04T08:31:45.430951Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:45.432076Z", "completed_at": "2024-07-04T08:31:45.432081Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0072345733642578125, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_geo_communes_number", "compiled": true, "compiled_code": "--- Le nombre officiel de communes est de 35029 soit\n--- zone = metro & drom est de 34935 en 2024\n--- i.e. france metropole et departement d'outre mer\n--- https://www.collectivites-locales.gouv.fr/bulletin-dinformation-statistique-bis-de-la-dgcl\n--- PLUS zone = com  est 94 \n--- i.e. collectivit\u00e9 d'outre mer\n--- Plus 45 communes municipales (Paris, Lyon, Marseille)\n\n\n\nwith source as (\n    SELECT COUNT(DISTINCT code_commune) as commune_count\n    FROM \"defaultdb\".\"prep\".\"geo_communes\"\n)\n\nselect *\nfrom source\nwhere commune_count != 35074", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:45.435526Z", "completed_at": "2024-07-04T08:31:45.438567Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:45.439683Z", "completed_at": "2024-07-04T08:31:45.439687Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006291866302490234, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.asset_geo_communes_distinct", "compiled": true, "compiled_code": "--- V\u00e9rifie que les communes du mod\u00e8le sont distinctes\n\n\n\nwith counts as (\n    SELECT code_commune, COUNT(*) as num_com\n    FROM \"defaultdb\".\"prep\".\"geo_communes\"\n    GROUP BY code_commune\n)\n\nselect *\nfrom counts\nwhere num_com > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:45.443120Z", "completed_at": "2024-07-04T08:31:45.454387Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:45.455561Z", "completed_at": "2024-07-04T08:31:45.455566Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.014640092849731445, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_geo_communes_code_commune.12ca32dbb5", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect code_commune\nfrom \"defaultdb\".\"prep\".\"geo_communes\"\nwhere code_commune is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:45.459068Z", "completed_at": "2024-07-04T08:31:45.466464Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:45.467694Z", "completed_at": "2024-07-04T08:31:45.467699Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.01083993911743164, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_geo_communes_code_commune.b822eae2cf", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    code_commune as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prep\".\"geo_communes\"\nwhere code_commune is not null\ngroup by code_commune\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:45.471158Z", "completed_at": "2024-07-04T08:31:45.474104Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:45.475275Z", "completed_at": "2024-07-04T08:31:45.475280Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00631403923034668, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_geo_postaux_distinct", "compiled": true, "compiled_code": "--- V\u00e9rifie que les codes postaux du mod\u00e8le sont distincts\n\n\n\nwith counts as (\n    SELECT code_postal, COUNT(*) as num_cp\n    FROM \"defaultdb\".\"prep\".\"geo_postaux\"\n    GROUP BY code_postal\n)\n\nselect *\nfrom counts\nwhere num_cp > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:45.478741Z", "completed_at": "2024-07-04T08:31:45.482666Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:45.483802Z", "completed_at": "2024-07-04T08:31:45.483806Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007253408432006836, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_geo_postaux_code_postal.f3f26546c2", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect code_postal\nfrom \"defaultdb\".\"prep\".\"geo_postaux\"\nwhere code_postal is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:45.487421Z", "completed_at": "2024-07-04T08:31:45.491230Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:45.492347Z", "completed_at": "2024-07-04T08:31:45.492352Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0072879791259765625, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_geo_postaux_code_postal.11a7ce8c7a", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    code_postal as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prep\".\"geo_postaux\"\nwhere code_postal is not null\ngroup by code_postal\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:45.495814Z", "completed_at": "2024-07-04T08:31:45.499788Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:45.500947Z", "completed_at": "2024-07-04T08:31:45.500951Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0073091983795166016, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_grouper_mutations_id_mutation.0834c40ce5", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect id_mutation\nfrom \"defaultdb\".\"prep\".\"grouper_mutations\"\nwhere id_mutation is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:45.504453Z", "completed_at": "2024-07-04T08:31:45.508263Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:45.509399Z", "completed_at": "2024-07-04T08:31:45.509403Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007042884826660156, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_grouper_mutations_id_mutation.167a98860e", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    id_mutation as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prep\".\"grouper_mutations\"\nwhere id_mutation is not null\ngroup by id_mutation\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:45.512828Z", "completed_at": "2024-07-04T08:31:46.563000Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:46.564204Z", "completed_at": "2024-07-04T08:31:46.564211Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 1.0541846752166748, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.decoder_demographie", "compiled": true, "compiled_code": "\n\nWITH logement AS (\n    select * from \"defaultdb\".\"sources\".\"logement_2020\"\n),\ndecode_logement AS (\n    \n  \n  \n\n  \n\n  \n\n  \n\n  SELECT\n    \n      \n      \n      \n      \n            \n      \n        \"INP65M\" as \"personnes_plus_65_ans_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INP24M\" as \"personnes_moins_24_ans_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"TPM\"\n          \n            WHEN '1' THEN 'temps_complet'\n          \n            WHEN '2' THEN 'temps_partiel'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'sans_objet_sans_emploi'\n          \n        END as \"temps_travail_pr\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"TACTM\"\n          \n            WHEN '11' THEN 'actifs_ayant_emploi'\n          \n            WHEN '12' THEN 'chomeurs'\n          \n            WHEN '21' THEN 'retraites_ou_preretraites'\n          \n            WHEN '22' THEN 'eleves'\n          \n            WHEN '24' THEN 'femmes_ou_hommes_au_foyer'\n          \n            WHEN '25' THEN 'autres_inactifs'\n          \n            WHEN 'YY' THEN 'hors_residence_principale'\n          \n        END as \"type_activite_pr\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"DIPLM\"\n          \n            WHEN '01' THEN 'pas_scolarite_ou_arret_avant_fin_primaire'\n          \n            WHEN '02' THEN 'aucdiplome_et_scolarite_interrompue_a_fin_primaire_ou_avant_fin_college'\n          \n            WHEN '03' THEN 'aucdiplome_et_scolarite_jusqu_a_fin_college_ou_au_dela'\n          \n            WHEN '11' THEN 'cep_certificat_d_etudes_primaires'\n          \n            WHEN '12' THEN 'bepc_brevet_elementaire_brevet_des_colleges_dnb'\n          \n            WHEN '13' THEN 'cap_bep_ou_diplome_niveau_equivalent'\n          \n            WHEN '14' THEN 'baccalaureat_general_ou_technologique_brevet_superieur_capacite_en_droit_daeu_eseu'\n          \n            WHEN '15' THEN 'baccalaureat_professionnel_brevet_professionnel_technicien_ou_d_enseignement_diplome_equivalent'\n          \n            WHEN '16' THEN 'bts_dut_deug_deust_diplome_sante_ou_social_niveau_bac+2_diplome_equivalent'\n          \n            WHEN '17' THEN 'licence_licence_pro_maitrise_diplome_equivalent_niveau_bac+3_ou_bac+4'\n          \n            WHEN '18' THEN 'master_dea_dess_diplome_granecole_niveau_bac+5_doctorat_sante'\n          \n            WHEN '19' THEN 'doctorat_recherche_hors_sante'\n          \n            WHEN 'YY' THEN 'hors_residence_principale'\n          \n        END as \"diplome_pr\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"INAIM\"\n          \n            WHEN '1' THEN 'dans_le_departement_residence_actuelle'\n          \n            WHEN '2' THEN 'dans_autre_departement_region_residence_actuelle'\n          \n            WHEN '3' THEN 'hors_region_residence_actuelle_en_metropole'\n          \n            WHEN '4' THEN 'hors_region_residence_actuelle_dom'\n          \n            WHEN '5' THEN 'hors_region_residence_actuelle_tom_com'\n          \n            WHEN '6' THEN 'a_l_etranger'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n        END as \"lieu_naissance_pr\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"SEXEM\"\n          \n            WHEN '1' THEN 'hommes'\n          \n            WHEN '2' THEN 'femmes'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n        END as \"sexe_pr\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INPER2\" as \"personnes_feminin_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INP19M\" as \"personnes_moins_19_ans_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"EMPLM\"\n          \n            WHEN '11' THEN 'en_contrat_d_apprentissage_ou_professionnalisation'\n          \n            WHEN '12' THEN 'places_par_agence_d_interim'\n          \n            WHEN '13' THEN 'emplois_aides_contrat_unique_d_insertion'\n          \n            WHEN '14' THEN 'stagiaires_remuneres_en_entreprise'\n          \n            WHEN '15' THEN 'autres_emplois_a_duree_limitee'\n          \n            WHEN '16' THEN 'emplois_sans_limite_duree'\n          \n            WHEN '21' THEN 'non_salaries_independants'\n          \n            WHEN '22' THEN 'non_salaries_employeurs'\n          \n            WHEN '23' THEN 'non_salaries_aides_familiaux'\n          \n            WHEN 'YY' THEN 'hors_residence_principale'\n          \n            WHEN 'ZZ' THEN 'sans_objet_sans_emploi'\n          \n        END as \"condition_empoi_pr\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"RECHM\"\n          \n            WHEN '0' THEN 'ne_recherche_pas_d_emploi'\n          \n            WHEN '1' THEN 'cherche_emploi_depuis_moins_an'\n          \n            WHEN '2' THEN 'cherche_emploi_depuis_plus_an'\n          \n            WHEN '9' THEN 'non_declare_inactif'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'sans_objet_en_emploi'\n          \n        END as \"anciennete_recherche_emploi_pr\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"TRANSM\"\n          \n            WHEN '1' THEN 'pas_transport'\n          \n            WHEN '2' THEN 'marche_a_pied_ou_rollers_patinette'\n          \n            WHEN '3' THEN 'velo_y_compris_a_assistance_electrique'\n          \n            WHEN '4' THEN 'deux_roues_motorise'\n          \n            WHEN '5' THEN 'voiture_camion_fourgonnette'\n          \n            WHEN '6' THEN 'transports_en_commun'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'sans_objet'\n          \n        END as \"mode_transport_plus_utilise_travail_pr\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"IPONDL\" as \"poids_du_logement\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INPER1\" as \"personnes_masculin_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"STAT_CONJM\"\n          \n            WHEN '1' THEN 'marie_e'\n          \n            WHEN '2' THEN 'pacse_e'\n          \n            WHEN '3' THEN 'en_concubinage_ou_union_libre'\n          \n            WHEN '4' THEN 'veuf_veuve'\n          \n            WHEN '5' THEN 'divorce_e'\n          \n            WHEN '6' THEN 'celibataire'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n        END as \"status_conjugal_pr\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INP60M\" as \"personnes_plus_60_ans_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INP75M\" as \"personnes_plus_75_ans_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"ILETUDM\"\n          \n            WHEN '1' THEN 'dans_commresidence_actuelle'\n          \n            WHEN '2' THEN 'dans_autre_commdepartement_residence'\n          \n            WHEN '3' THEN 'dans_autre_departement_region_residence'\n          \n            WHEN '4' THEN 'hors_region_residence_actuelle_en_metropole'\n          \n            WHEN '5' THEN 'hors_region_residence_actuelle_dom'\n          \n            WHEN '6' THEN 'hors_region_residence_actuelle_com'\n          \n            WHEN '7' THEN 'a_l_etranger'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'sans_objet_pas_d_inscription_etablissement_d_enseignement'\n          \n        END as \"lieu_etudes_pr\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INPER\" as \"personnes_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"VOIT\"\n          \n            WHEN '0' THEN 'aucvoiture'\n          \n            WHEN '1' THEN 'une_seule_voiture'\n          \n            WHEN '2' THEN 'deux_voitures'\n          \n            WHEN '3' THEN 'trois_voitures_ou_plus'\n          \n            WHEN 'X' THEN 'logement_ordinaire_inoccupe'\n          \n        END as \"nombre_voitures_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"COMMUNE\" as \"code_commune_insee\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INPAM\" as \"personnes_actives_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"STOCD\"\n          \n            WHEN '00' THEN 'logement_ordinaire_inoccupe'\n          \n            WHEN '10' THEN 'proprietaire'\n          \n            WHEN '21' THEN 'locataire_ou_sous_locataire_logement_loue_vinon_hlm'\n          \n            WHEN '22' THEN 'locataire_ou_sous_locataire_logement_loue_vihlm'\n          \n            WHEN '23' THEN 'locataire_ou_sous_locataire_logement_loue_meuble_ou_d_chambre_d_hotel'\n          \n            WHEN '30' THEN 'loge_gratuitement'\n          \n        END as \"status\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"IMMIM\"\n          \n            WHEN '1' THEN 'immigres'\n          \n            WHEN '2' THEN 'non_immigres'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n        END as \"situation_immigration_pr\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"AGEMEN8\"\n          \n            WHEN '00' THEN 'moins_15_ans'\n          \n            WHEN '15' THEN '15_a_19_ans'\n          \n            WHEN '20' THEN '20_a_24_ans'\n          \n            WHEN '25' THEN '25_a_39_ans'\n          \n            WHEN '40' THEN '40_a_54_ans'\n          \n            WHEN '55' THEN '55_a_64_ans'\n          \n            WHEN '65' THEN '65_a_79_ans'\n          \n            WHEN '80' THEN '80_ans_ou_plus'\n          \n            WHEN 'YY' THEN 'hors_residence_principale'\n          \n        END as \"age_regroupe_pr_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INP3M\" as \"personnes_moins_3_ans_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"REGION\"\n          \n            WHEN '01' THEN 'guadeloupe'\n          \n            WHEN '02' THEN 'martinique'\n          \n            WHEN '03' THEN 'guyane'\n          \n            WHEN '04' THEN 'la_reunion'\n          \n            WHEN '11' THEN 'ile_france'\n          \n            WHEN '24' THEN 'centre_val_loire'\n          \n            WHEN '27' THEN 'bourgogne_franche_comte'\n          \n            WHEN '28' THEN 'normandie'\n          \n            WHEN '32' THEN 'hauts_france'\n          \n            WHEN '44' THEN 'grand_est'\n          \n            WHEN '52' THEN 'pays_loire'\n          \n            WHEN '53' THEN 'bretagne'\n          \n            WHEN '75' THEN 'nouvelle_aquitaine'\n          \n            WHEN '76' THEN 'occitanie'\n          \n            WHEN '84' THEN 'auvergne_rhone_alpes'\n          \n            WHEN '93' THEN 'provence_alpes_cote_d_azur'\n          \n            WHEN '94' THEN 'corse'\n          \n        END as \"region_residence\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INEEM\" as \"personnes_scolarise_plus_14_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INP17M\" as \"personnes_moins_17_ans_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INP5M\" as \"personnes_moins_5_ans_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INP15M\" as \"personnes_moins_15_ans_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INP11M\" as \"personnes_moins_11_ans_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INPOM\" as \"personnes_actives_ayant_emploi_menage\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"ILTM\"\n          \n            WHEN '1' THEN 'dans_commresidence_actuelle'\n          \n            WHEN '2' THEN 'dans_autre_commdepartement_residence'\n          \n            WHEN '3' THEN 'dans_autre_departement_region_residence'\n          \n            WHEN '4' THEN 'hors_region_residence_actuelle_en_metropole'\n          \n            WHEN '5' THEN 'hors_region_residence_actuelle_dom'\n          \n            WHEN '6' THEN 'hors_region_residence_actuelle_com'\n          \n            WHEN '7' THEN 'a_l_etranger'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'sans_objet_sans_emploi'\n          \n        END as \"lieu_travail_pr\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"IRANM\"\n          \n            WHEN '1' THEN 'dans_le_meme_logement'\n          \n            WHEN '2' THEN 'dans_autre_logement_meme_commune'\n          \n            WHEN '3' THEN 'dans_autre_commdepartement'\n          \n            WHEN '4' THEN 'dans_autre_departement_region'\n          \n            WHEN '5' THEN 'hors_region_residence_actuelle_en_metropole'\n          \n            WHEN '6' THEN 'hors_region_residence_actuelle_dom'\n          \n            WHEN '7' THEN 'hors_region_residence_actuelle_tom_com'\n          \n            WHEN '8' THEN 'a_l_etranger_l_union_europeenne_28_pays_membres'\n          \n            WHEN '9' THEN 'a_l_etranger_hors_union_europeenne'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n        END as \"residence_annee_avant_pr\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"INPSM\" as \"personnes_scolarisees_menage\"\n      \n      \n      \n      \n    \n  FROM logement\n\n)\n\nSELECT \n    *\nFROM \n    decode_logement", "relation_name": "\"defaultdb\".\"prep\".\"decoder_demographie\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:46.568533Z", "completed_at": "2024-07-04T08:31:47.669148Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:47.670403Z", "completed_at": "2024-07-04T08:31:47.670410Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 1.1047019958496094, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.decoder_habitat", "compiled": true, "compiled_code": "\n\nWITH logement AS (\n    select * from \"defaultdb\".\"sources\".\"logement_2020\"\n),\ndecode_logement AS (\n    \n  \n  \n\n  \n\n  \n\n  \n\n  SELECT\n    \n      \n      \n      \n      \n            \n      \n        CASE \"CMBL\"\n          \n            WHEN '1' THEN 'chauffage_urbain'\n          \n            WHEN '2' THEN 'gaz_ville_ou_reseau'\n          \n            WHEN '3' THEN 'fioul_mazout'\n          \n            WHEN '4' THEN 'electricite'\n          \n            WHEN '5' THEN 'gaz_en_bouteilles_ou_en_citerne'\n          \n            WHEN '6' THEN 'autre'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'logement_ordinaire_dom'\n          \n        END as \"combustible_principal_logement__metro\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"ASCEN\"\n          \n            WHEN '1' THEN 'avec_ascenseur'\n          \n            WHEN '2' THEN 'sans_ascenseur'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n        END as \"desserte_ascensseur\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"GARL\"\n          \n            WHEN '1' THEN 'avec_emplacement_s_stationnement'\n          \n            WHEN '2' THEN 'sans_emplacement_stationnement'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n        END as \"emplacement_stationnement_reserve\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"CHFL\"\n          \n            WHEN '1' THEN 'chauffage_central_collectif_y_compris_chauffage_urbain'\n          \n            WHEN '2' THEN 'chauffage_central_individuel_avec_chaudiere_propre_au_logement'\n          \n            WHEN '3' THEN 'chauffage_tout_electrique'\n          \n            WHEN '4' THEN 'autre_moyen_chauffage'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'logement_ordinaire_dom'\n          \n        END as \"chauffage_central_logement__metro\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"IPONDL\" as \"poids_du_logement\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"HLML\"\n          \n            WHEN '1' THEN 'logement_appartenant_a_organisme_hlm'\n          \n            WHEN '2' THEN 'logement_n_appartenant_pas_a_organisme_hlm'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n        END as \"logement_hml\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"EGOUL\"\n          \n            WHEN '1' THEN 'raccordement_au_reseau_d_egouts'\n          \n            WHEN '2' THEN 'raccordement_a_fosse_septique'\n          \n            WHEN '3' THEN 'raccordement_a_puisard'\n          \n            WHEN '4' THEN 'evacuation_des_eaux_usees_a_meme_le_sol'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'logement_ordinaire_france_metropolitaine'\n          \n        END as \"mode_evacuation_eaux_usagers__dom\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"CATL\"\n          \n            WHEN '1' THEN 'residences_principales'\n          \n            WHEN '2' THEN 'logements_occasionnels'\n          \n            WHEN '3' THEN 'residences_secondaires'\n          \n            WHEN '4' THEN 'logements_vacants'\n          \n        END as \"categorie_logement\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"ANEMR\"\n          \n            WHEN '00' THEN 'moins_2_ans'\n          \n            WHEN '01' THEN 'de_2_a_4_ans'\n          \n            WHEN '02' THEN 'de_5_a_9_ans'\n          \n            WHEN '03' THEN 'de_10_a_19_ans'\n          \n            WHEN '04' THEN 'de_20_a_29_ans'\n          \n            WHEN '05' THEN 'de_30_a_39_ans'\n          \n            WHEN '06' THEN 'de_40_a_49_ans'\n          \n            WHEN '07' THEN 'de_50_a_59_ans'\n          \n            WHEN '08' THEN 'de_60_a_69_ans'\n          \n            WHEN '09' THEN '70_ans_ou_plus'\n          \n            WHEN '99' THEN 'logement_ordinaire_inoccupe'\n          \n        END as \"aciennete_regroupe_ammenagement_logement\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"AEMMR\"\n          \n            WHEN '0' THEN 'logement_ordinaire_inoccupe'\n          \n            WHEN '2' THEN 'emmenagement_entre_1900_et_1919'\n          \n            WHEN '3' THEN 'emmenagement_entre_1920_et_1939'\n          \n            WHEN '4' THEN 'emmenagement_entre_1940_et_1959'\n          \n            WHEN '5' THEN 'emmenagement_entre_1960_et_1969'\n          \n            WHEN '6' THEN 'emmenagement_entre_1970_et_1979'\n          \n            WHEN '7' THEN 'emmenagement_entre_1980_et_1989'\n          \n            WHEN '8' THEN 'emmenagement_entre_1990_et_1999'\n          \n            WHEN '9' THEN 'emmenagement_apres_1999'\n          \n        END as \"annee_regroupe_ammenagement_logement\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"COMMUNE\" as \"code_commune_insee\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"CHAU\"\n          \n            WHEN '1' THEN 'presence_moyen_chauffage'\n          \n            WHEN '2' THEN 'absence_moyen_chauffage'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'logement_ordinaire_france_metropolitaine'\n          \n        END as \"chauffage_logement__dom\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"SURF\"\n          \n            WHEN '1' THEN 'moins_30'\n          \n            WHEN '2' THEN 'de_30_a_moins_40'\n          \n            WHEN '3' THEN 'de_40_a_moins_60'\n          \n            WHEN '4' THEN 'de_60_a_moins_80'\n          \n            WHEN '5' THEN 'de_80_a_moins_100'\n          \n            WHEN '6' THEN 'de_100_a_moins_120'\n          \n            WHEN '7' THEN '120_ou_plus'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n        END as \"superficie_logement\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"EAU\"\n          \n            WHEN '1' THEN 'eau_froiseulement'\n          \n            WHEN '2' THEN 'eau_froiet_chaude'\n          \n            WHEN '3' THEN 'aucpoint_d_eau_a_l_interieur_logement'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'logement_ordinaire_france_metropolitaine'\n          \n        END as \"eau_potabke_interieur_logement__dom\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"METRODOM\"\n          \n            WHEN 'D' THEN 'dom'\n          \n            WHEN 'M' THEN 'france_metropolitaine'\n          \n        END as \"residence_metropole_ou_dom\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"ELEC\"\n          \n            WHEN '1' THEN 'avec_electricite'\n          \n            WHEN '2' THEN 'sans_electricite'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'logement_ordinaire_france_metropolitaine'\n          \n        END as \"electricite_logement__dom\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"CLIM\"\n          \n            WHEN '1' THEN 'avec_piece_climatisee'\n          \n            WHEN '2' THEN 'sans_piece_climatisee'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'logement_ordinaire_france_metropolitaine'\n          \n        END as \"min_une_piece_climatise__dom\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        \"NBPI\" as \"nombre_pieces_logement\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"BAIN\"\n          \n            WHEN '1' THEN 'avec_baignoire_ou_douche'\n          \n            WHEN '2' THEN 'sans_baignoire_ni_douche'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'logement_ordinaire_france_metropolitaine'\n          \n        END as \"baignoire_ou_douche__dom\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"REGION\"\n          \n            WHEN '01' THEN 'guadeloupe'\n          \n            WHEN '02' THEN 'martinique'\n          \n            WHEN '03' THEN 'guyane'\n          \n            WHEN '04' THEN 'la_reunion'\n          \n            WHEN '11' THEN 'ile_france'\n          \n            WHEN '24' THEN 'centre_val_loire'\n          \n            WHEN '27' THEN 'bourgogne_franche_comte'\n          \n            WHEN '28' THEN 'normandie'\n          \n            WHEN '32' THEN 'hauts_france'\n          \n            WHEN '44' THEN 'grand_est'\n          \n            WHEN '52' THEN 'pays_loire'\n          \n            WHEN '53' THEN 'bretagne'\n          \n            WHEN '75' THEN 'nouvelle_aquitaine'\n          \n            WHEN '76' THEN 'occitanie'\n          \n            WHEN '84' THEN 'auvergne_rhone_alpes'\n          \n            WHEN '93' THEN 'provence_alpes_cote_d_azur'\n          \n            WHEN '94' THEN 'corse'\n          \n        END as \"region_residence\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"CHOS\"\n          \n            WHEN '1' THEN 'presence_chauffe_eau_solaire'\n          \n            WHEN '2' THEN 'absence_chauffe_eau_solaire'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'logement_ordinaire_france_metropolitaine'\n          \n        END as \"chauffe_eau_solaire__dom\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"CUIS\"\n          \n            WHEN '1' THEN 'presence_cuisine_interieure_avec_evier'\n          \n            WHEN '2' THEN 'absence_cuisine_interieure_avec_evier'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'logement_ordinaire_france_metropolitaine'\n          \n        END as \"cuisine_interieur_avec_evier__dom\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"SANI\"\n          \n            WHEN '0' THEN 'ni_baignoire'\n          \n            WHEN '1' THEN 'baignoire_ou_douche_hors_piece_reservee'\n          \n            WHEN '2' THEN 'salle_s_bains_avec_douche_ou_baignoire'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'logement_ordinaire_dom'\n          \n        END as \"installation_sanitaires__metro\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"DEROU\"\n          \n            WHEN '0' THEN 'aucdeux_roues_a_moteur'\n          \n            WHEN '1' THEN 'un_seul_deux_roues_a_moteur'\n          \n            WHEN '2' THEN 'deux_deux_roues_a_moteur'\n          \n            WHEN '3' THEN 'trois_deux_roues_a_moteur_ou_plus'\n          \n            WHEN 'X' THEN 'logement_ordinaire_inoccupe_dom'\n          \n            WHEN 'Z' THEN 'logement_ordinaire_france_metropolitaine'\n          \n        END as \"nombre_deux_roues_menage__dom\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"BATI\"\n          \n            WHEN '1' THEN 'habitations_fortune'\n          \n            WHEN '2' THEN 'cases_traditionnelles'\n          \n            WHEN '3' THEN 'maisons_ou_immeubles_en_bois'\n          \n            WHEN '4' THEN 'maisons_ou_immeubles_en_dur'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'logement_ordinaire_france_metropolitaine'\n          \n        END as \"aspect_bati__dom\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"SANIDOM\"\n          \n            WHEN '11' THEN 'avec_baignoire_ou_douche_et_avec_wc_a_l_interieur'\n          \n            WHEN '12' THEN 'avec_baignoire_ou_douche_mais_sans_wc_a_l_interieur'\n          \n            WHEN '21' THEN 'sans_baignoire_ni_douche_mais_avec_wc_a_l_interieur'\n          \n            WHEN '22' THEN 'sans_baignoire_ni_douche'\n          \n            WHEN 'YY' THEN 'hors_residence_principale'\n          \n            WHEN 'ZZ' THEN 'logement_ordinaire_france_metropolitaine'\n          \n        END as \"installation_sanitaires__dom\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"WC\"\n          \n            WHEN '1' THEN 'avec_w._c._a_l_interieur_logement'\n          \n            WHEN '2' THEN 'sans_w._c._a_l_interieur_logement'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n            WHEN 'Z' THEN 'logement_ordinaire_france_metropolitaine'\n          \n        END as \"presence_wc_interieur_logement__dom\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"TYPC\"\n          \n            WHEN '1' THEN 'batiment_d_habitation_seul_logement_isole'\n          \n            WHEN '2' THEN 'batiment_d_habitation_seul_logement_jumele_ou_groupe_toute_autre_facon'\n          \n            WHEN '3' THEN 'batiment_d_habitation_2_logements_ou_plus'\n          \n            WHEN '4' THEN 'batiment_a_usage_autre_qu_habitation'\n          \n            WHEN '5' THEN 'construction_provisoire'\n          \n            WHEN 'Y' THEN 'hors_residence_principale'\n          \n        END as \"type_construction\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"ACHL\"\n          \n            WHEN 'A11' THEN 'avant_1919'\n          \n            WHEN 'A12' THEN 'de_1919_a_1945'\n          \n            WHEN 'B11' THEN 'de_1946_a_1970'\n          \n            WHEN 'B12' THEN 'de_1971_a_1990'\n          \n            WHEN 'C100' THEN 'de_1991_a_2005'\n          \n            WHEN 'C106' THEN 'en_2006'\n          \n            WHEN 'C107' THEN 'en_2007'\n          \n            WHEN 'C108' THEN 'en_2008'\n          \n            WHEN 'C109' THEN 'en_2009'\n          \n            WHEN 'C110' THEN 'en_2010'\n          \n            WHEN 'C111' THEN 'en_2011'\n          \n            WHEN 'C112' THEN 'en_2012'\n          \n            WHEN 'C113' THEN 'en_2013'\n          \n            WHEN 'C114' THEN 'en_2014'\n          \n            WHEN 'C115' THEN 'en_2015'\n          \n            WHEN 'C116' THEN 'en_2016'\n          \n            WHEN 'C117' THEN 'en_2017'\n          \n            WHEN 'C2018' THEN 'en_2018_partiel'\n          \n            WHEN 'C2019' THEN 'en_2019_partiel'\n          \n            WHEN 'C2020' THEN 'en_2020_partiel'\n          \n            WHEN 'C2021' THEN 'en_2021_partiel'\n          \n            WHEN 'C2022' THEN 'en_2022_partiel'\n          \n        END as \"achevement_construction_logement\"\n      \n      \n      \n      , \n    \n      \n      \n      \n      \n            \n      \n        CASE \"TYPL\"\n          \n            WHEN '1' THEN 'maison'\n          \n            WHEN '2' THEN 'appartement'\n          \n            WHEN '3' THEN 'logement_foyer'\n          \n            WHEN '4' THEN 'chambre_d_hotel'\n          \n            WHEN '5' THEN 'habitation_fortune'\n          \n            WHEN '6' THEN 'piece_independante_ayant_sa_propre_entree'\n          \n        END as \"type_logement\"\n      \n      \n      \n      \n    \n  FROM logement\n\n)\n\nSELECT \n    *\nFROM \n    decode_logement", "relation_name": "\"defaultdb\".\"prep\".\"decoder_habitat\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:47.674871Z", "completed_at": "2024-07-04T08:31:47.679294Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:47.680446Z", "completed_at": "2024-07-04T08:31:47.680451Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007909536361694336, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_aggeger_effectifs_sante_departement_2022_departement.cc58d5e085", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect departement\nfrom \"defaultdb\".\"prep\".\"aggeger_effectifs_sante_departement_2022\"\nwhere departement is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:47.683935Z", "completed_at": "2024-07-04T08:31:47.688170Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:47.689329Z", "completed_at": "2024-07-04T08:31:47.689333Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0075130462646484375, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_aggeger_effectifs_sante_departement_2022_libelle_departement.baae3ab3e8", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect libelle_departement\nfrom \"defaultdb\".\"prep\".\"aggeger_effectifs_sante_departement_2022\"\nwhere libelle_departement is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:47.692890Z", "completed_at": "2024-07-04T08:31:47.698235Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:47.699443Z", "completed_at": "2024-07-04T08:31:47.699450Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008773326873779297, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_aggeger_effectifs_sante_departement_2022_libelle_region.ad2b5d1f84", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect libelle_region\nfrom \"defaultdb\".\"prep\".\"aggeger_effectifs_sante_departement_2022\"\nwhere libelle_region is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:47.703011Z", "completed_at": "2024-07-04T08:31:47.707141Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:47.708292Z", "completed_at": "2024-07-04T08:31:47.708298Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007437229156494141, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_aggeger_effectifs_sante_departement_2022_region.426bcb46c6", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect region\nfrom \"defaultdb\".\"prep\".\"aggeger_effectifs_sante_departement_2022\"\nwhere region is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:47.711769Z", "completed_at": "2024-07-04T08:31:47.715821Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:47.716979Z", "completed_at": "2024-07-04T08:31:47.716984Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007309913635253906, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_aggeger_effectifs_sante_departement_2022_departement.f929a79113", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    departement as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prep\".\"aggeger_effectifs_sante_departement_2022\"\nwhere departement is not null\ngroup by departement\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:47.720517Z", "completed_at": "2024-07-04T08:31:47.724586Z"}, {"name": "execute", "started_at": "2024-07-04T08:31:47.725903Z", "completed_at": "2024-07-04T08:31:47.725908Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007638216018676758, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_aggeger_effectifs_sante_departement_2022_libelle_departement.79882a7e79", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    libelle_departement as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prep\".\"aggeger_effectifs_sante_departement_2022\"\nwhere libelle_departement is not null\ngroup by libelle_departement\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:31:47.729404Z", "completed_at": "2024-07-04T08:38:23.977269Z"}, {"name": "execute", "started_at": "2024-07-04T08:38:23.978550Z", "completed_at": "2024-07-04T08:38:23.978557Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 396.33876490592957, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.aggreger_demographie_communes", "compiled": true, "compiled_code": "\n\n--- Agr\u00e8ge les donn\u00e9es de la base logement par commune\n--- Colonne par colonne pour ne pas saturer la m\u00e9moire\n--- L'agr\u00e9gration est faite par univot/pivot.\n\n\n\n\nwith communes as (\n    SELECT \n      code_commune_insee,\n      SUM(CAST(poids_du_logement AS numeric)) AS nombre_de_logements\n    FROM \n      \"defaultdb\".\"prep\".\"decoder_demographie\"\n    GROUP BY\n      code_commune_insee\n  ),\n  aggregated as (\n\n    SELECT * \n\n    FROM communes\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_moins_3_ans_menage' as TEXT) as champs,\n      cast(  \n           personnes_moins_3_ans_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_3_ans_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_3_ans_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_3_ans_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_3_ans_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_3_ans_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_3_ans_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_3_ans_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_3_ans_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_3_ans_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_3_ans_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_3_ans_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_3_ans_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_3_ans_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_3_ans_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_3_ans_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_3_ans_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_3_ans_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_3_ans_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_3_ans_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_3_ans_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_moins_11_ans_menage' as TEXT) as champs,\n      cast(  \n           personnes_moins_11_ans_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__13'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__13\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__14'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__14\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_11_ans_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_11_ans_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('residence_annee_avant_pr' as TEXT) as champs,\n      cast(  \n           residence_annee_avant_pr\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'residence_annee_avant_pr__a_l_etranger_hors_union_europeenne'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_annee_avant_pr__a_l_etranger_hors_union_europeenne\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'residence_annee_avant_pr__a_l_etranger_l_union_europeenne_28_pays_membres'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_annee_avant_pr__a_l_etranger_l_union_europeenne_28_pays_membres\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'residence_annee_avant_pr__dans_autre_commdepartement'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_annee_avant_pr__dans_autre_commdepartement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'residence_annee_avant_pr__dans_autre_departement_region'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_annee_avant_pr__dans_autre_departement_region\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'residence_annee_avant_pr__dans_autre_logement_meme_commune'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_annee_avant_pr__dans_autre_logement_meme_commune\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'residence_annee_avant_pr__dans_le_meme_logement'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_annee_avant_pr__dans_le_meme_logement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'residence_annee_avant_pr__hors_region_residence_actuelle_dom'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_annee_avant_pr__hors_region_residence_actuelle_dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'residence_annee_avant_pr__hors_region_residence_actuelle_en_metropole'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_annee_avant_pr__hors_region_residence_actuelle_en_metropole\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'residence_annee_avant_pr__hors_region_residence_actuelle_tom_com'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_annee_avant_pr__hors_region_residence_actuelle_tom_com\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'residence_annee_avant_pr__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_annee_avant_pr__hors_residence_principale\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('status_conjugal_pr' as TEXT) as champs,\n      cast(  \n           status_conjugal_pr\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'status_conjugal_pr__celibataire'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"status_conjugal_pr__celibataire\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'status_conjugal_pr__divorce_e'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"status_conjugal_pr__divorce_e\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'status_conjugal_pr__en_concubinage_ou_union_libre'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"status_conjugal_pr__en_concubinage_ou_union_libre\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'status_conjugal_pr__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"status_conjugal_pr__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'status_conjugal_pr__marie_e'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"status_conjugal_pr__marie_e\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'status_conjugal_pr__pacse_e'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"status_conjugal_pr__pacse_e\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'status_conjugal_pr__veuf_veuve'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"status_conjugal_pr__veuf_veuve\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('sexe_pr' as TEXT) as champs,\n      cast(  \n           sexe_pr\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'sexe_pr__femmes'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"sexe_pr__femmes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'sexe_pr__hommes'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"sexe_pr__hommes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'sexe_pr__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"sexe_pr__hors_residence_principale\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('nombre_voitures_menage' as TEXT) as champs,\n      cast(  \n           nombre_voitures_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_voitures_menage__aucvoiture'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_voitures_menage__aucvoiture\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_voitures_menage__deux_voitures'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_voitures_menage__deux_voitures\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_voitures_menage__logement_ordinaire_inoccupe'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_voitures_menage__logement_ordinaire_inoccupe\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_voitures_menage__trois_voitures_ou_plus'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_voitures_menage__trois_voitures_ou_plus\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_voitures_menage__une_seule_voiture'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_voitures_menage__une_seule_voiture\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_moins_17_ans_menage' as TEXT) as champs,\n      cast(  \n           personnes_moins_17_ans_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__13'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__13\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__14'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__14\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__15'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__15\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__16'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__16\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__17'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__17\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__24'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__24\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_17_ans_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_17_ans_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_actives_ayant_emploi_menage' as TEXT) as champs,\n      cast(  \n           personnes_actives_ayant_emploi_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__13'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__13\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__14'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__14\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__15'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__15\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__16'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__16\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__17'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__17\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__18'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__18\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__19'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__19\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__20'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__20\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__26'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__26\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__41'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__41\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_ayant_emploi_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_ayant_emploi_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('anciennete_recherche_emploi_pr' as TEXT) as champs,\n      cast(  \n           anciennete_recherche_emploi_pr\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'anciennete_recherche_emploi_pr__cherche_emploi_depuis_moins_an'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"anciennete_recherche_emploi_pr__cherche_emploi_depuis_moins_an\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'anciennete_recherche_emploi_pr__cherche_emploi_depuis_plus_an'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"anciennete_recherche_emploi_pr__cherche_emploi_depuis_plus_an\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'anciennete_recherche_emploi_pr__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"anciennete_recherche_emploi_pr__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'anciennete_recherche_emploi_pr__ne_recherche_pas_d_emploi'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"anciennete_recherche_emploi_pr__ne_recherche_pas_d_emploi\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'anciennete_recherche_emploi_pr__non_declare_inactif'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"anciennete_recherche_emploi_pr__non_declare_inactif\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'anciennete_recherche_emploi_pr__sans_objet_en_emploi'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"anciennete_recherche_emploi_pr__sans_objet_en_emploi\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_masculin_menage' as TEXT) as champs,\n      cast(  \n           personnes_masculin_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__13'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__13\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__14'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__14\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__15'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__15\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__16'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__16\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__17'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__17\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__18'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__18\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__19'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__19\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__20'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__20\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__22'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__22\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__26'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__26\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__38'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__38\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_masculin_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_masculin_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_moins_24_ans_menage' as TEXT) as champs,\n      cast(  \n           personnes_moins_24_ans_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__13'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__13\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__14'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__14\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__15'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__15\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__16'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__16\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__17'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__17\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__18'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__18\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__19'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__19\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__20'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__20\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__21'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__21\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__25'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__25\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_24_ans_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_24_ans_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_scolarisees_menage' as TEXT) as champs,\n      cast(  \n           personnes_scolarisees_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__13'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__13\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__14'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__14\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__15'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__15\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__16'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__16\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__25'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__25\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarisees_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarisees_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('status' as TEXT) as champs,\n      cast(  \n           status\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'status__locataire_ou_sous_locataire_logement_loue_meuble_ou_d_chambre_d_hotel'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"status__locataire_ou_sous_locataire_logement_loue_meuble_ou_d_chambre_d_hotel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'status__locataire_ou_sous_locataire_logement_loue_vihlm'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"status__locataire_ou_sous_locataire_logement_loue_vihlm\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'status__locataire_ou_sous_locataire_logement_loue_vinon_hlm'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"status__locataire_ou_sous_locataire_logement_loue_vinon_hlm\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'status__loge_gratuitement'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"status__loge_gratuitement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'status__logement_ordinaire_inoccupe'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"status__logement_ordinaire_inoccupe\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'status__proprietaire'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"status__proprietaire\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_plus_75_ans_menage' as TEXT) as champs,\n      cast(  \n           personnes_plus_75_ans_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_75_ans_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_75_ans_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_75_ans_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_75_ans_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_75_ans_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_75_ans_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_75_ans_menage__18'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_75_ans_menage__18\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_75_ans_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_75_ans_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_75_ans_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_75_ans_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_75_ans_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_75_ans_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_75_ans_menage__48'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_75_ans_menage__48\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_75_ans_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_75_ans_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_75_ans_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_75_ans_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_75_ans_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_75_ans_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_75_ans_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_75_ans_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_75_ans_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_75_ans_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_75_ans_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_75_ans_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_plus_60_ans_menage' as TEXT) as champs,\n      cast(  \n           personnes_plus_60_ans_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__17'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__17\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__19'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__19\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__55'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__55\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_60_ans_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_60_ans_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_moins_19_ans_menage' as TEXT) as champs,\n      cast(  \n           personnes_moins_19_ans_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__13'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__13\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__14'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__14\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__15'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__15\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__16'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__16\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__17'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__17\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__18'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__18\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__19'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__19\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__20'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__20\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__21'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__21\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__22'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__22\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__23'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__23\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__25'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__25\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__41'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__41\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__55'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__55\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_19_ans_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_19_ans_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('condition_empoi_pr' as TEXT) as champs,\n      cast(  \n           condition_empoi_pr\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'condition_empoi_pr__autres_emplois_a_duree_limitee'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"condition_empoi_pr__autres_emplois_a_duree_limitee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'condition_empoi_pr__emplois_aides_contrat_unique_d_insertion'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"condition_empoi_pr__emplois_aides_contrat_unique_d_insertion\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'condition_empoi_pr__emplois_sans_limite_duree'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"condition_empoi_pr__emplois_sans_limite_duree\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'condition_empoi_pr__en_contrat_d_apprentissage_ou_professionnalisation'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"condition_empoi_pr__en_contrat_d_apprentissage_ou_professionnalisation\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'condition_empoi_pr__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"condition_empoi_pr__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'condition_empoi_pr__non_salaries_aides_familiaux'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"condition_empoi_pr__non_salaries_aides_familiaux\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'condition_empoi_pr__non_salaries_employeurs'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"condition_empoi_pr__non_salaries_employeurs\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'condition_empoi_pr__non_salaries_independants'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"condition_empoi_pr__non_salaries_independants\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'condition_empoi_pr__places_par_agence_d_interim'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"condition_empoi_pr__places_par_agence_d_interim\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'condition_empoi_pr__sans_objet_sans_emploi'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"condition_empoi_pr__sans_objet_sans_emploi\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'condition_empoi_pr__stagiaires_remuneres_en_entreprise'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"condition_empoi_pr__stagiaires_remuneres_en_entreprise\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_moins_5_ans_menage' as TEXT) as champs,\n      cast(  \n           personnes_moins_5_ans_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_5_ans_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_5_ans_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_5_ans_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_5_ans_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_5_ans_menage__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_5_ans_menage__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_5_ans_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_5_ans_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_5_ans_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_5_ans_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_5_ans_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_5_ans_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_5_ans_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_5_ans_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_5_ans_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_5_ans_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_5_ans_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_5_ans_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_5_ans_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_5_ans_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_5_ans_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_5_ans_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_5_ans_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_5_ans_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_scolarise_plus_14_menage' as TEXT) as champs,\n      cast(  \n           personnes_scolarise_plus_14_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarise_plus_14_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarise_plus_14_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarise_plus_14_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarise_plus_14_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarise_plus_14_menage__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarise_plus_14_menage__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarise_plus_14_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarise_plus_14_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarise_plus_14_menage__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarise_plus_14_menage__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarise_plus_14_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarise_plus_14_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarise_plus_14_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarise_plus_14_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarise_plus_14_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarise_plus_14_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarise_plus_14_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarise_plus_14_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarise_plus_14_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarise_plus_14_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarise_plus_14_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarise_plus_14_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarise_plus_14_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarise_plus_14_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarise_plus_14_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarise_plus_14_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_scolarise_plus_14_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_scolarise_plus_14_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_actives_menage' as TEXT) as champs,\n      cast(  \n           personnes_actives_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__13'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__13\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__14'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__14\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__15'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__15\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__16'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__16\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__17'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__17\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__18'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__18\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__19'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__19\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__20'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__20\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__26'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__26\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__41'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__41\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_actives_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_actives_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('mode_transport_plus_utilise_travail_pr' as TEXT) as champs,\n      cast(  \n           mode_transport_plus_utilise_travail_pr\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'mode_transport_plus_utilise_travail_pr__deux_roues_motorise'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"mode_transport_plus_utilise_travail_pr__deux_roues_motorise\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'mode_transport_plus_utilise_travail_pr__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"mode_transport_plus_utilise_travail_pr__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'mode_transport_plus_utilise_travail_pr__marche_a_pied_ou_rollers_patinette'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"mode_transport_plus_utilise_travail_pr__marche_a_pied_ou_rollers_patinette\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'mode_transport_plus_utilise_travail_pr__pas_transport'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"mode_transport_plus_utilise_travail_pr__pas_transport\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'mode_transport_plus_utilise_travail_pr__sans_objet'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"mode_transport_plus_utilise_travail_pr__sans_objet\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'mode_transport_plus_utilise_travail_pr__transports_en_commun'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"mode_transport_plus_utilise_travail_pr__transports_en_commun\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'mode_transport_plus_utilise_travail_pr__velo_y_compris_a_assistance_electrique'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"mode_transport_plus_utilise_travail_pr__velo_y_compris_a_assistance_electrique\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'mode_transport_plus_utilise_travail_pr__voiture_camion_fourgonnette'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"mode_transport_plus_utilise_travail_pr__voiture_camion_fourgonnette\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('age_regroupe_pr_menage' as TEXT) as champs,\n      cast(  \n           age_regroupe_pr_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'age_regroupe_pr_menage__15_a_19_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"age_regroupe_pr_menage__15_a_19_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'age_regroupe_pr_menage__20_a_24_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"age_regroupe_pr_menage__20_a_24_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'age_regroupe_pr_menage__25_a_39_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"age_regroupe_pr_menage__25_a_39_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'age_regroupe_pr_menage__40_a_54_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"age_regroupe_pr_menage__40_a_54_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'age_regroupe_pr_menage__55_a_64_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"age_regroupe_pr_menage__55_a_64_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'age_regroupe_pr_menage__65_a_79_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"age_regroupe_pr_menage__65_a_79_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'age_regroupe_pr_menage__80_ans_ou_plus'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"age_regroupe_pr_menage__80_ans_ou_plus\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'age_regroupe_pr_menage__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"age_regroupe_pr_menage__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'age_regroupe_pr_menage__moins_15_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"age_regroupe_pr_menage__moins_15_ans\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('type_activite_pr' as TEXT) as champs,\n      cast(  \n           type_activite_pr\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_activite_pr__actifs_ayant_emploi'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_activite_pr__actifs_ayant_emploi\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_activite_pr__autres_inactifs'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_activite_pr__autres_inactifs\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_activite_pr__chomeurs'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_activite_pr__chomeurs\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_activite_pr__eleves'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_activite_pr__eleves\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_activite_pr__femmes_ou_hommes_au_foyer'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_activite_pr__femmes_ou_hommes_au_foyer\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_activite_pr__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_activite_pr__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_activite_pr__retraites_ou_preretraites'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_activite_pr__retraites_ou_preretraites\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_moins_15_ans_menage' as TEXT) as champs,\n      cast(  \n           personnes_moins_15_ans_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__13'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__13\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__14'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__14\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__15'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__15\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_moins_15_ans_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_moins_15_ans_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('situation_immigration_pr' as TEXT) as champs,\n      cast(  \n           situation_immigration_pr\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'situation_immigration_pr__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"situation_immigration_pr__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'situation_immigration_pr__immigres'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"situation_immigration_pr__immigres\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'situation_immigration_pr__non_immigres'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"situation_immigration_pr__non_immigres\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_feminin_menage' as TEXT) as champs,\n      cast(  \n           personnes_feminin_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__13'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__13\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__14'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__14\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__15'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__15\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__16'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__16\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__17'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__17\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__19'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__19\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__20'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__20\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__39'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__39\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_feminin_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_feminin_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('diplome_pr' as TEXT) as champs,\n      cast(  \n           diplome_pr\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'diplome_pr__aucdiplome_et_scolarite_interrompue_a_fin_primaire_ou_avant_fin_college'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"diplome_pr__aucdiplome_et_scolarite_interrompue_a_fin_primaire_ou_avant_fin_college\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'diplome_pr__aucdiplome_et_scolarite_jusqu_a_fin_college_ou_au_dela'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"diplome_pr__aucdiplome_et_scolarite_jusqu_a_fin_college_ou_au_dela\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'diplome_pr__baccalaureat_general_ou_technologique_brevet_superieur_capacite_en_droit_daeu_eseu'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"diplome_pr__baccalaureat_general_ou_technologique_brevet_superieur_capacite_en_droit_daeu_eseu\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'diplome_pr__baccalaureat_professionnel_brevet_professionnel_technicien_ou_d_enseignement_diplome_equivalent'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"diplome_pr__baccalaureat_professionnel_brevet_professionnel_technicien_ou_d_enseignement_diplome_equivalent\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'diplome_pr__bepc_brevet_elementaire_brevet_des_colleges_dnb'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"diplome_pr__bepc_brevet_elementaire_brevet_des_colleges_dnb\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'diplome_pr__bts_dut_deug_deust_diplome_sante_ou_social_niveau_bac+2_diplome_equivalent'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"diplome_pr__bts_dut_deug_deust_diplome_sante_ou_social_niveau_bac+2_diplome_equivalent\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'diplome_pr__cap_bep_ou_diplome_niveau_equivalent'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"diplome_pr__cap_bep_ou_diplome_niveau_equivalent\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'diplome_pr__cep_certificat_d_etudes_primaires'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"diplome_pr__cep_certificat_d_etudes_primaires\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'diplome_pr__doctorat_recherche_hors_sante'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"diplome_pr__doctorat_recherche_hors_sante\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'diplome_pr__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"diplome_pr__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'diplome_pr__licence_licence_pro_maitrise_diplome_equivalent_niveau_bac+3_ou_bac+4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"diplome_pr__licence_licence_pro_maitrise_diplome_equivalent_niveau_bac+3_ou_bac+4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'diplome_pr__master_dea_dess_diplome_granecole_niveau_bac+5_doctorat_sante'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"diplome_pr__master_dea_dess_diplome_granecole_niveau_bac+5_doctorat_sante\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'diplome_pr__pas_scolarite_ou_arret_avant_fin_primaire'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"diplome_pr__pas_scolarite_ou_arret_avant_fin_primaire\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('lieu_etudes_pr' as TEXT) as champs,\n      cast(  \n           lieu_etudes_pr\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_etudes_pr__a_l_etranger'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_etudes_pr__a_l_etranger\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_etudes_pr__dans_autre_commdepartement_residence'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_etudes_pr__dans_autre_commdepartement_residence\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_etudes_pr__dans_autre_departement_region_residence'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_etudes_pr__dans_autre_departement_region_residence\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_etudes_pr__dans_commresidence_actuelle'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_etudes_pr__dans_commresidence_actuelle\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_etudes_pr__hors_region_residence_actuelle_com'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_etudes_pr__hors_region_residence_actuelle_com\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_etudes_pr__hors_region_residence_actuelle_dom'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_etudes_pr__hors_region_residence_actuelle_dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_etudes_pr__hors_region_residence_actuelle_en_metropole'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_etudes_pr__hors_region_residence_actuelle_en_metropole\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_etudes_pr__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_etudes_pr__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_etudes_pr__sans_objet_pas_d_inscription_etablissement_d_enseignement'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_etudes_pr__sans_objet_pas_d_inscription_etablissement_d_enseignement\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('lieu_naissance_pr' as TEXT) as champs,\n      cast(  \n           lieu_naissance_pr\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_naissance_pr__a_l_etranger'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_naissance_pr__a_l_etranger\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_naissance_pr__dans_autre_departement_region_residence_actuelle'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_naissance_pr__dans_autre_departement_region_residence_actuelle\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_naissance_pr__dans_le_departement_residence_actuelle'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_naissance_pr__dans_le_departement_residence_actuelle\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_naissance_pr__hors_region_residence_actuelle_dom'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_naissance_pr__hors_region_residence_actuelle_dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_naissance_pr__hors_region_residence_actuelle_en_metropole'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_naissance_pr__hors_region_residence_actuelle_en_metropole\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_naissance_pr__hors_region_residence_actuelle_tom_com'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_naissance_pr__hors_region_residence_actuelle_tom_com\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_naissance_pr__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_naissance_pr__hors_residence_principale\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('lieu_travail_pr' as TEXT) as champs,\n      cast(  \n           lieu_travail_pr\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_travail_pr__a_l_etranger'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_travail_pr__a_l_etranger\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_travail_pr__dans_autre_commdepartement_residence'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_travail_pr__dans_autre_commdepartement_residence\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_travail_pr__dans_autre_departement_region_residence'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_travail_pr__dans_autre_departement_region_residence\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_travail_pr__dans_commresidence_actuelle'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_travail_pr__dans_commresidence_actuelle\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_travail_pr__hors_region_residence_actuelle_com'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_travail_pr__hors_region_residence_actuelle_com\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_travail_pr__hors_region_residence_actuelle_dom'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_travail_pr__hors_region_residence_actuelle_dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_travail_pr__hors_region_residence_actuelle_en_metropole'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_travail_pr__hors_region_residence_actuelle_en_metropole\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_travail_pr__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_travail_pr__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'lieu_travail_pr__sans_objet_sans_emploi'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"lieu_travail_pr__sans_objet_sans_emploi\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_plus_65_ans_menage' as TEXT) as champs,\n      cast(  \n           personnes_plus_65_ans_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__0'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__0\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__16'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__16\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__18'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__18\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__55'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__55\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_plus_65_ans_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_plus_65_ans_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('temps_travail_pr' as TEXT) as champs,\n      cast(  \n           temps_travail_pr\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'temps_travail_pr__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"temps_travail_pr__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'temps_travail_pr__sans_objet_sans_emploi'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"temps_travail_pr__sans_objet_sans_emploi\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'temps_travail_pr__temps_complet'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"temps_travail_pr__temps_complet\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'temps_travail_pr__temps_partiel'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"temps_travail_pr__temps_partiel\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('personnes_menage' as TEXT) as champs,\n      cast(  \n           personnes_menage\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_demographie\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__1'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__1\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__13'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__13\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__14'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__14\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__15'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__15\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__16'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__16\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__17'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__17\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__18'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__18\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__19'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__19\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__2'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__20'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__20\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__21'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__21\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__22'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__22\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__23'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__23\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__24'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__24\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__25'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__25\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__26'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__26\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__28'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__28\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__3'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__3\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__34'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__34\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__4'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__41'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__41\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__5'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__55'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__55\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__6'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__6\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__7'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__7\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__8'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__9'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__9\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'personnes_menage__Y'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"personnes_menage__Y\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n  )\n\nSELECT \n    *  \nFROM\n    aggregated", "relation_name": "\"defaultdb\".\"prep\".\"aggreger_demographie_communes\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:38:24.069891Z", "completed_at": "2024-07-04T08:43:23.489495Z"}, {"name": "execute", "started_at": "2024-07-04T08:43:23.490766Z", "completed_at": "2024-07-04T08:43:23.490773Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 299.51096057891846, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.aggreger_habitat_communes", "compiled": true, "compiled_code": "\n\n--- Agr\u00e8ge les donn\u00e9es de la base logement par commune\n--- Colonne par colonne pour ne pas saturer la m\u00e9moire\n--- L'agr\u00e9gration est faite par univot/pivot.\n\n\n\n\nwith communes as (\n    SELECT \n      code_commune_insee,\n      SUM(CAST(poids_du_logement AS numeric)) AS nombre_de_logements\n    FROM \n      \"defaultdb\".\"prep\".\"decoder_habitat\"\n    GROUP BY\n      code_commune_insee\n  ),\n  aggregated as (\n\n    SELECT * \n\n    FROM communes\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('mode_evacuation_eaux_usagers__dom' as TEXT) as champs,\n      cast(  \n           mode_evacuation_eaux_usagers__dom\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'mode_evacuation_eaux_usagers__dom__evacuation_des_eaux_usees_a_meme_le_sol'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"mode_evacuation_eaux_usagers__dom__evacuation_des_eaux_usees_a_meme_le_sol\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'mode_evacuation_eaux_usagers__dom__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"mode_evacuation_eaux_usagers__dom__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'mode_evacuation_eaux_usagers__dom__logement_ordinaire_france_metropolitaine'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"mode_evacuation_eaux_usagers__dom__logement_ordinaire_france_metropolitaine\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'mode_evacuation_eaux_usagers__dom__raccordement_a_fosse_septique'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"mode_evacuation_eaux_usagers__dom__raccordement_a_fosse_septique\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'mode_evacuation_eaux_usagers__dom__raccordement_a_puisard'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"mode_evacuation_eaux_usagers__dom__raccordement_a_puisard\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'mode_evacuation_eaux_usagers__dom__raccordement_au_reseau_d_egouts'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"mode_evacuation_eaux_usagers__dom__raccordement_au_reseau_d_egouts\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('annee_regroupe_ammenagement_logement' as TEXT) as champs,\n      cast(  \n           annee_regroupe_ammenagement_logement\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'annee_regroupe_ammenagement_logement__emmenagement_apres_1999'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"annee_regroupe_ammenagement_logement__emmenagement_apres_1999\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'annee_regroupe_ammenagement_logement__emmenagement_entre_1900_et_1919'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"annee_regroupe_ammenagement_logement__emmenagement_entre_1900_et_1919\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'annee_regroupe_ammenagement_logement__emmenagement_entre_1920_et_1939'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"annee_regroupe_ammenagement_logement__emmenagement_entre_1920_et_1939\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'annee_regroupe_ammenagement_logement__emmenagement_entre_1940_et_1959'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"annee_regroupe_ammenagement_logement__emmenagement_entre_1940_et_1959\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'annee_regroupe_ammenagement_logement__emmenagement_entre_1960_et_1969'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"annee_regroupe_ammenagement_logement__emmenagement_entre_1960_et_1969\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'annee_regroupe_ammenagement_logement__emmenagement_entre_1970_et_1979'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"annee_regroupe_ammenagement_logement__emmenagement_entre_1970_et_1979\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'annee_regroupe_ammenagement_logement__emmenagement_entre_1980_et_1989'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"annee_regroupe_ammenagement_logement__emmenagement_entre_1980_et_1989\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'annee_regroupe_ammenagement_logement__emmenagement_entre_1990_et_1999'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"annee_regroupe_ammenagement_logement__emmenagement_entre_1990_et_1999\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'annee_regroupe_ammenagement_logement__logement_ordinaire_inoccupe'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"annee_regroupe_ammenagement_logement__logement_ordinaire_inoccupe\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('installation_sanitaires__dom' as TEXT) as champs,\n      cast(  \n           installation_sanitaires__dom\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'installation_sanitaires__dom__avec_baignoire_ou_douche_et_avec_wc_a_l_interieur'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"installation_sanitaires__dom__avec_baignoire_ou_douche_et_avec_wc_a_l_interieur\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'installation_sanitaires__dom__avec_baignoire_ou_douche_mais_sans_wc_a_l_interieur'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"installation_sanitaires__dom__avec_baignoire_ou_douche_mais_sans_wc_a_l_interieur\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'installation_sanitaires__dom__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"installation_sanitaires__dom__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'installation_sanitaires__dom__logement_ordinaire_france_metropolitaine'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"installation_sanitaires__dom__logement_ordinaire_france_metropolitaine\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'installation_sanitaires__dom__sans_baignoire_ni_douche'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"installation_sanitaires__dom__sans_baignoire_ni_douche\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'installation_sanitaires__dom__sans_baignoire_ni_douche_mais_avec_wc_a_l_interieur'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"installation_sanitaires__dom__sans_baignoire_ni_douche_mais_avec_wc_a_l_interieur\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('combustible_principal_logement__metro' as TEXT) as champs,\n      cast(  \n           combustible_principal_logement__metro\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'combustible_principal_logement__metro__autre'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"combustible_principal_logement__metro__autre\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'combustible_principal_logement__metro__chauffage_urbain'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"combustible_principal_logement__metro__chauffage_urbain\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'combustible_principal_logement__metro__electricite'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"combustible_principal_logement__metro__electricite\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'combustible_principal_logement__metro__fioul_mazout'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"combustible_principal_logement__metro__fioul_mazout\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'combustible_principal_logement__metro__gaz_en_bouteilles_ou_en_citerne'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"combustible_principal_logement__metro__gaz_en_bouteilles_ou_en_citerne\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'combustible_principal_logement__metro__gaz_ville_ou_reseau'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"combustible_principal_logement__metro__gaz_ville_ou_reseau\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'combustible_principal_logement__metro__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"combustible_principal_logement__metro__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'combustible_principal_logement__metro__logement_ordinaire_dom'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"combustible_principal_logement__metro__logement_ordinaire_dom\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('nombre_pieces_logement' as TEXT) as champs,\n      cast(  \n           nombre_pieces_logement\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__01'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__01\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__02'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__02\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__03'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__03\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__04'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__04\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__05'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__05\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__06'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__06\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__07'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__07\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__08'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__08\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__09'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__09\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__10'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__10\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__11'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__11\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__12'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__12\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__13'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__13\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__14'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__14\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__15'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__15\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__16'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__16\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__17'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__17\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__18'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__18\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__19'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__19\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__20'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__20\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_pieces_logement__YY'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_pieces_logement__YY\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('superficie_logement' as TEXT) as champs,\n      cast(  \n           superficie_logement\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'superficie_logement__120_ou_plus'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"superficie_logement__120_ou_plus\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'superficie_logement__de_100_a_moins_120'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"superficie_logement__de_100_a_moins_120\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'superficie_logement__de_30_a_moins_40'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"superficie_logement__de_30_a_moins_40\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'superficie_logement__de_40_a_moins_60'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"superficie_logement__de_40_a_moins_60\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'superficie_logement__de_60_a_moins_80'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"superficie_logement__de_60_a_moins_80\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'superficie_logement__de_80_a_moins_100'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"superficie_logement__de_80_a_moins_100\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'superficie_logement__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"superficie_logement__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'superficie_logement__moins_30'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"superficie_logement__moins_30\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('nombre_deux_roues_menage__dom' as TEXT) as champs,\n      cast(  \n           nombre_deux_roues_menage__dom\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_deux_roues_menage__dom__aucdeux_roues_a_moteur'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_deux_roues_menage__dom__aucdeux_roues_a_moteur\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_deux_roues_menage__dom__deux_deux_roues_a_moteur'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_deux_roues_menage__dom__deux_deux_roues_a_moteur\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_deux_roues_menage__dom__logement_ordinaire_france_metropolitaine'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_deux_roues_menage__dom__logement_ordinaire_france_metropolitaine\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_deux_roues_menage__dom__logement_ordinaire_inoccupe_dom'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_deux_roues_menage__dom__logement_ordinaire_inoccupe_dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_deux_roues_menage__dom__trois_deux_roues_a_moteur_ou_plus'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_deux_roues_menage__dom__trois_deux_roues_a_moteur_ou_plus\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'nombre_deux_roues_menage__dom__un_seul_deux_roues_a_moteur'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"nombre_deux_roues_menage__dom__un_seul_deux_roues_a_moteur\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('baignoire_ou_douche__dom' as TEXT) as champs,\n      cast(  \n           baignoire_ou_douche__dom\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'baignoire_ou_douche__dom__avec_baignoire_ou_douche'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"baignoire_ou_douche__dom__avec_baignoire_ou_douche\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'baignoire_ou_douche__dom__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"baignoire_ou_douche__dom__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'baignoire_ou_douche__dom__logement_ordinaire_france_metropolitaine'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"baignoire_ou_douche__dom__logement_ordinaire_france_metropolitaine\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'baignoire_ou_douche__dom__sans_baignoire_ni_douche'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"baignoire_ou_douche__dom__sans_baignoire_ni_douche\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('presence_wc_interieur_logement__dom' as TEXT) as champs,\n      cast(  \n           presence_wc_interieur_logement__dom\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'presence_wc_interieur_logement__dom__avec_w._c._a_l_interieur_logement'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"presence_wc_interieur_logement__dom__avec_w._c._a_l_interieur_logement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'presence_wc_interieur_logement__dom__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"presence_wc_interieur_logement__dom__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'presence_wc_interieur_logement__dom__logement_ordinaire_france_metropolitaine'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"presence_wc_interieur_logement__dom__logement_ordinaire_france_metropolitaine\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'presence_wc_interieur_logement__dom__sans_w._c._a_l_interieur_logement'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"presence_wc_interieur_logement__dom__sans_w._c._a_l_interieur_logement\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('chauffage_central_logement__metro' as TEXT) as champs,\n      cast(  \n           chauffage_central_logement__metro\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'chauffage_central_logement__metro__autre_moyen_chauffage'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"chauffage_central_logement__metro__autre_moyen_chauffage\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'chauffage_central_logement__metro__chauffage_central_collectif_y_compris_chauffage_urbain'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"chauffage_central_logement__metro__chauffage_central_collectif_y_compris_chauffage_urbain\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'chauffage_central_logement__metro__chauffage_central_individuel_avec_chaudiere_propre_au_logement'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"chauffage_central_logement__metro__chauffage_central_individuel_avec_chaudiere_propre_au_logement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'chauffage_central_logement__metro__chauffage_tout_electrique'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"chauffage_central_logement__metro__chauffage_tout_electrique\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'chauffage_central_logement__metro__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"chauffage_central_logement__metro__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'chauffage_central_logement__metro__logement_ordinaire_dom'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"chauffage_central_logement__metro__logement_ordinaire_dom\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('electricite_logement__dom' as TEXT) as champs,\n      cast(  \n           electricite_logement__dom\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'electricite_logement__dom__avec_electricite'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"electricite_logement__dom__avec_electricite\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'electricite_logement__dom__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"electricite_logement__dom__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'electricite_logement__dom__logement_ordinaire_france_metropolitaine'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"electricite_logement__dom__logement_ordinaire_france_metropolitaine\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'electricite_logement__dom__sans_electricite'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"electricite_logement__dom__sans_electricite\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('emplacement_stationnement_reserve' as TEXT) as champs,\n      cast(  \n           emplacement_stationnement_reserve\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'emplacement_stationnement_reserve__avec_emplacement_s_stationnement'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emplacement_stationnement_reserve__avec_emplacement_s_stationnement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'emplacement_stationnement_reserve__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emplacement_stationnement_reserve__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'emplacement_stationnement_reserve__sans_emplacement_stationnement'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emplacement_stationnement_reserve__sans_emplacement_stationnement\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('desserte_ascensseur' as TEXT) as champs,\n      cast(  \n           desserte_ascensseur\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'desserte_ascensseur__avec_ascenseur'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"desserte_ascensseur__avec_ascenseur\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'desserte_ascensseur__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"desserte_ascensseur__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'desserte_ascensseur__sans_ascenseur'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"desserte_ascensseur__sans_ascenseur\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('aspect_bati__dom' as TEXT) as champs,\n      cast(  \n           aspect_bati__dom\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'aspect_bati__dom__cases_traditionnelles'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aspect_bati__dom__cases_traditionnelles\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aspect_bati__dom__habitations_fortune'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aspect_bati__dom__habitations_fortune\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aspect_bati__dom__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aspect_bati__dom__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aspect_bati__dom__logement_ordinaire_france_metropolitaine'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aspect_bati__dom__logement_ordinaire_france_metropolitaine\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aspect_bati__dom__maisons_ou_immeubles_en_bois'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aspect_bati__dom__maisons_ou_immeubles_en_bois\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aspect_bati__dom__maisons_ou_immeubles_en_dur'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aspect_bati__dom__maisons_ou_immeubles_en_dur\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('type_logement' as TEXT) as champs,\n      cast(  \n           type_logement\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_logement__appartement'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_logement__appartement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_logement__chambre_d_hotel'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_logement__chambre_d_hotel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_logement__habitation_fortune'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_logement__habitation_fortune\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_logement__logement_foyer'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_logement__logement_foyer\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_logement__maison'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_logement__maison\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_logement__piece_independante_ayant_sa_propre_entree'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_logement__piece_independante_ayant_sa_propre_entree\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('cuisine_interieur_avec_evier__dom' as TEXT) as champs,\n      cast(  \n           cuisine_interieur_avec_evier__dom\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'cuisine_interieur_avec_evier__dom__absence_cuisine_interieure_avec_evier'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"cuisine_interieur_avec_evier__dom__absence_cuisine_interieure_avec_evier\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'cuisine_interieur_avec_evier__dom__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"cuisine_interieur_avec_evier__dom__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'cuisine_interieur_avec_evier__dom__logement_ordinaire_france_metropolitaine'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"cuisine_interieur_avec_evier__dom__logement_ordinaire_france_metropolitaine\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'cuisine_interieur_avec_evier__dom__presence_cuisine_interieure_avec_evier'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"cuisine_interieur_avec_evier__dom__presence_cuisine_interieure_avec_evier\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('type_construction' as TEXT) as champs,\n      cast(  \n           type_construction\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_construction__batiment_a_usage_autre_qu_habitation'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_construction__batiment_a_usage_autre_qu_habitation\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_construction__batiment_d_habitation_2_logements_ou_plus'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_construction__batiment_d_habitation_2_logements_ou_plus\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_construction__batiment_d_habitation_seul_logement_isole'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_construction__batiment_d_habitation_seul_logement_isole\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_construction__batiment_d_habitation_seul_logement_jumele_ou_groupe_toute_autre_facon'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_construction__batiment_d_habitation_seul_logement_jumele_ou_groupe_toute_autre_facon\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_construction__construction_provisoire'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_construction__construction_provisoire\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'type_construction__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"type_construction__hors_residence_principale\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('min_une_piece_climatise__dom' as TEXT) as champs,\n      cast(  \n           min_une_piece_climatise__dom\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'min_une_piece_climatise__dom__avec_piece_climatisee'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"min_une_piece_climatise__dom__avec_piece_climatisee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'min_une_piece_climatise__dom__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"min_une_piece_climatise__dom__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'min_une_piece_climatise__dom__logement_ordinaire_france_metropolitaine'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"min_une_piece_climatise__dom__logement_ordinaire_france_metropolitaine\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'min_une_piece_climatise__dom__sans_piece_climatisee'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"min_une_piece_climatise__dom__sans_piece_climatisee\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('eau_potabke_interieur_logement__dom' as TEXT) as champs,\n      cast(  \n           eau_potabke_interieur_logement__dom\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'eau_potabke_interieur_logement__dom__aucpoint_d_eau_a_l_interieur_logement'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"eau_potabke_interieur_logement__dom__aucpoint_d_eau_a_l_interieur_logement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'eau_potabke_interieur_logement__dom__eau_froiet_chaude'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"eau_potabke_interieur_logement__dom__eau_froiet_chaude\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'eau_potabke_interieur_logement__dom__eau_froiseulement'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"eau_potabke_interieur_logement__dom__eau_froiseulement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'eau_potabke_interieur_logement__dom__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"eau_potabke_interieur_logement__dom__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'eau_potabke_interieur_logement__dom__logement_ordinaire_france_metropolitaine'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"eau_potabke_interieur_logement__dom__logement_ordinaire_france_metropolitaine\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('achevement_construction_logement' as TEXT) as champs,\n      cast(  \n           achevement_construction_logement\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__avant_1919'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__avant_1919\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__de_1919_a_1945'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__de_1919_a_1945\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__de_1946_a_1970'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__de_1946_a_1970\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__de_1971_a_1990'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__de_1971_a_1990\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__de_1991_a_2005'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__de_1991_a_2005\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2006'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2006\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2007'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2007\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2008'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2008\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2009'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2009\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2010'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2010\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2011'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2011\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2012'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2012\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2013'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2013\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2014'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2014\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2015'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2015\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2016'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2016\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2017'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2017\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2018_partiel'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2018_partiel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2019_partiel'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2019_partiel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2020_partiel'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2020_partiel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2021_partiel'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2021_partiel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'achevement_construction_logement__en_2022_partiel'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"achevement_construction_logement__en_2022_partiel\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('chauffe_eau_solaire__dom' as TEXT) as champs,\n      cast(  \n           chauffe_eau_solaire__dom\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'chauffe_eau_solaire__dom__absence_chauffe_eau_solaire'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"chauffe_eau_solaire__dom__absence_chauffe_eau_solaire\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'chauffe_eau_solaire__dom__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"chauffe_eau_solaire__dom__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'chauffe_eau_solaire__dom__logement_ordinaire_france_metropolitaine'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"chauffe_eau_solaire__dom__logement_ordinaire_france_metropolitaine\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'chauffe_eau_solaire__dom__presence_chauffe_eau_solaire'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"chauffe_eau_solaire__dom__presence_chauffe_eau_solaire\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('categorie_logement' as TEXT) as champs,\n      cast(  \n           categorie_logement\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'categorie_logement__logements_occasionnels'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"categorie_logement__logements_occasionnels\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'categorie_logement__logements_vacants'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"categorie_logement__logements_vacants\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'categorie_logement__residences_principales'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"categorie_logement__residences_principales\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'categorie_logement__residences_secondaires'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"categorie_logement__residences_secondaires\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('logement_hml' as TEXT) as champs,\n      cast(  \n           logement_hml\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'logement_hml__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_hml__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'logement_hml__logement_appartenant_a_organisme_hlm'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_hml__logement_appartenant_a_organisme_hlm\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'logement_hml__logement_n_appartenant_pas_a_organisme_hlm'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_hml__logement_n_appartenant_pas_a_organisme_hlm\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('aciennete_regroupe_ammenagement_logement' as TEXT) as champs,\n      cast(  \n           aciennete_regroupe_ammenagement_logement\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'aciennete_regroupe_ammenagement_logement__70_ans_ou_plus'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aciennete_regroupe_ammenagement_logement__70_ans_ou_plus\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aciennete_regroupe_ammenagement_logement__de_10_a_19_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aciennete_regroupe_ammenagement_logement__de_10_a_19_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aciennete_regroupe_ammenagement_logement__de_20_a_29_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aciennete_regroupe_ammenagement_logement__de_20_a_29_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aciennete_regroupe_ammenagement_logement__de_2_a_4_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aciennete_regroupe_ammenagement_logement__de_2_a_4_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aciennete_regroupe_ammenagement_logement__de_30_a_39_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aciennete_regroupe_ammenagement_logement__de_30_a_39_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aciennete_regroupe_ammenagement_logement__de_40_a_49_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aciennete_regroupe_ammenagement_logement__de_40_a_49_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aciennete_regroupe_ammenagement_logement__de_50_a_59_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aciennete_regroupe_ammenagement_logement__de_50_a_59_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aciennete_regroupe_ammenagement_logement__de_5_a_9_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aciennete_regroupe_ammenagement_logement__de_5_a_9_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aciennete_regroupe_ammenagement_logement__de_60_a_69_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aciennete_regroupe_ammenagement_logement__de_60_a_69_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aciennete_regroupe_ammenagement_logement__logement_ordinaire_inoccupe'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aciennete_regroupe_ammenagement_logement__logement_ordinaire_inoccupe\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'aciennete_regroupe_ammenagement_logement__moins_2_ans'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"aciennete_regroupe_ammenagement_logement__moins_2_ans\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('residence_metropole_ou_dom' as TEXT) as champs,\n      cast(  \n           residence_metropole_ou_dom\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'residence_metropole_ou_dom__dom'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_metropole_ou_dom__dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'residence_metropole_ou_dom__france_metropolitaine'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_metropole_ou_dom__france_metropolitaine\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('chauffage_logement__dom' as TEXT) as champs,\n      cast(  \n           chauffage_logement__dom\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'chauffage_logement__dom__absence_moyen_chauffage'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"chauffage_logement__dom__absence_moyen_chauffage\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'chauffage_logement__dom__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"chauffage_logement__dom__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'chauffage_logement__dom__logement_ordinaire_france_metropolitaine'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"chauffage_logement__dom__logement_ordinaire_france_metropolitaine\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'chauffage_logement__dom__presence_moyen_chauffage'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"chauffage_logement__dom__presence_moyen_chauffage\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN (     \n\n\nwith unpivoted as (\n      \n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n\n    select\n        code_commune_insee,\n        poids_du_logement,\n\n      cast('installation_sanitaires__metro' as TEXT) as champs,\n      cast(  \n           installation_sanitaires__metro\n             \n           as varchar) as valeur\n\n    from \"defaultdb\".\"prep\".\"decoder_habitat\"\n\n    \n\n), \nconcatenated as (\n        \n    SELECT\n        code_commune_insee,\n        poids_du_logement,\n        champs,\n        valeur,\n        champs || '__' || valeur AS champs__valeur\n    FROM\n        unpivoted\n\n),\ndeduplicated as (\n        \n    SELECT\n        code_commune_insee,\n        champs,\n        champs__valeur,\n        SUM(CAST(poids_du_logement as NUMERIC)) as population_par_commune_champs_valeur\n    FROM\n        concatenated\n    GROUP BY\n        code_commune_insee,\n        champs__valeur,\n        champs\n\n),\npivoted as (\n        \n\n\n\n\n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs__valeur = 'installation_sanitaires__metro__baignoire_ou_douche_hors_piece_reservee'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"installation_sanitaires__metro__baignoire_ou_douche_hors_piece_reservee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'installation_sanitaires__metro__hors_residence_principale'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"installation_sanitaires__metro__hors_residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'installation_sanitaires__metro__logement_ordinaire_dom'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"installation_sanitaires__metro__logement_ordinaire_dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'installation_sanitaires__metro__ni_baignoire'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"installation_sanitaires__metro__ni_baignoire\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs__valeur = 'installation_sanitaires__metro__salle_s_bains_avec_douche_ou_baignoire'\n        then population_par_commune_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"installation_sanitaires__metro__salle_s_bains_avec_douche_ou_baignoire\"\n      \n    \n    \n  \n\n    from \n        deduplicated\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n )\n      USING (code_commune_insee)\n\n    \n\n  )\n\nSELECT \n    *  \nFROM\n    aggregated", "relation_name": "\"defaultdb\".\"prep\".\"aggreger_habitat_communes\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:43:23.582137Z", "completed_at": "2024-07-04T08:43:23.585824Z"}, {"name": "execute", "started_at": "2024-07-04T08:43:23.587014Z", "completed_at": "2024-07-04T08:43:23.587019Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007164955139160156, "adapter_response": {}, "message": null, "failures": null, "unique_id": "analysis.makeopendata.sanity_check_demographie", "compiled": true, "compiled_code": "-- V\u00e9rifier que certaines quantit\u00e9s sont conformes par rapport aux dossier de l'INSEE\n-- Par exemple Montpellier, code commune 34172\n\nselect \n\tstatus_conjugal_pr__celibataire / (nombre_de_logements - status_conjugal_pr__hors_residence_principale) as proportions_celibataires,\n\tstatus_conjugal_pr__divorce_e / (nombre_de_logements - status_conjugal_pr__hors_residence_principale) as proportions_divorce,\n\tstatus_conjugal_pr__en_concubinage_ou_union_libre / (nombre_de_logements - status_conjugal_pr__hors_residence_principale) as proportions_concubinage_union_libre,\n\tstatus_conjugal_pr__marie_e / (nombre_de_logements - status_conjugal_pr__hors_residence_principale) as proportions_marie,\n\tstatus_conjugal_pr__pacse_e / (nombre_de_logements - status_conjugal_pr__hors_residence_principale) as proportions_pacse,\n\tstatus_conjugal_pr__veuf_veuve / (nombre_de_logements - status_conjugal_pr__hors_residence_principale) as proportions_veuf\nfrom \"defaultdb\".\"prep\".\"aggreger_demographie_communes\"\nwhere code_commune_insee = '34172'\n\n-- proportions_celibataires, proportions_divorce, proportions_concubinage_union_libre, proportions_marie, proportions_pacse, proportions_veuf\n-- 0.45271001407013124149\t0.11121578101415645350\t0.10832617037363749454\t0.23182251308921670739\t0.03850035728419874230\t0.05742516416865936078\n\n-- Semblables aux chiffres de l'INSEE pour Montpellier \n-- FAMG4 : https://www.insee.fr/fr/statistiques/2011101?geo=COM-34172#consulter-sommaire\n\n-- Ici hypoth\u00e8se qu'un m\u00e9nage = un logement hors r\u00e9sidence de grandeur. Pas forc\u00e9ment le cas.\n-- A appronfondir : https://www.insee.fr/fr/information/2383177", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:43:23.590490Z", "completed_at": "2024-07-04T08:43:23.594712Z"}, {"name": "execute", "started_at": "2024-07-04T08:43:23.595873Z", "completed_at": "2024-07-04T08:43:23.595877Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0075261592864990234, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_aggreger_demographie_communes_code_commune_insee.93bafe8c43", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect code_commune_insee\nfrom \"defaultdb\".\"prep\".\"aggreger_demographie_communes\"\nwhere code_commune_insee is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:43:23.599381Z", "completed_at": "2024-07-04T08:43:23.603323Z"}, {"name": "execute", "started_at": "2024-07-04T08:43:23.604483Z", "completed_at": "2024-07-04T08:43:23.604487Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0072765350341796875, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_aggreger_demographie_communes_code_commune_insee.e9ea688474", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    code_commune_insee as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prep\".\"aggreger_demographie_communes\"\nwhere code_commune_insee is not null\ngroup by code_commune_insee\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:43:23.608036Z", "completed_at": "2024-07-04T08:43:23.612658Z"}, {"name": "execute", "started_at": "2024-07-04T08:43:23.613783Z", "completed_at": "2024-07-04T08:43:23.613788Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007884025573730469, "adapter_response": {}, "message": null, "failures": null, "unique_id": "analysis.makeopendata.sanity_check_habitat", "compiled": true, "compiled_code": "-- V\u00e9rifier que certaines quantit\u00e9s sont conformes par rapport aux dossier de l'INSEE\n-- Par exemple Montpellier, code commune 34172\n\nselect \n\tnombre_de_logements,\n\ttype_logement__appartement,\n\ttype_logement__maison\nfrom \"defaultdb\".\"prep\".\"aggreger_habitat_communes\"\nwhere code_commune_insee = '34172'\n\n-- Nombre_de_logements, type_logement__appartement,type_logement__maison\n-- 177110.492716640209757\t153388.053005437629254\t20926.742388919034265\n\n\n-- Les m\u00eames que les chiffres de l'INSEE pour Montpellier\n-- https://www.insee.fr/fr/statistiques/2011101?geo=COM-34172#consulter-sommaire", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:43:23.617227Z", "completed_at": "2024-07-04T08:43:23.621081Z"}, {"name": "execute", "started_at": "2024-07-04T08:43:23.622223Z", "completed_at": "2024-07-04T08:43:23.622227Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0071260929107666016, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_aggreger_habitat_communes_code_commune_insee.cb97ce64fb", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect code_commune_insee\nfrom \"defaultdb\".\"prep\".\"aggreger_habitat_communes\"\nwhere code_commune_insee is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-07-04T08:43:23.625722Z", "completed_at": "2024-07-04T08:43:23.629489Z"}, {"name": "execute", "started_at": "2024-07-04T08:43:23.630658Z", "completed_at": "2024-07-04T08:43:23.630662Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007055759429931641, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_aggreger_habitat_communes_code_commune_insee.4e49975331", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    code_commune_insee as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prep\".\"aggreger_habitat_communes\"\nwhere code_commune_insee is not null\ngroup by code_commune_insee\nhaving count(*) > 1\n\n\n", "relation_name": null}], "elapsed_time": 701.9749450683594, "args": {"version_check": true, "log_path": "/home/runner/work/make-open-data/make-open-data/logs", "indirect_selection": "eager", "show_resource_report": false, "select": [], "print": true, "use_colors": true, "favor_state": false, "send_anonymous_usage_stats": true, "exclude": [], "empty_catalog": false, "profiles_dir": ".", "macro_debugging": false, "printer_width": 80, "vars": {}, "log_level_file": "debug", "static_parser": true, "partial_parse_file_diff": true, "log_format_file": "debug", "log_format": "default", "write_json": true, "use_colors_file": true, "quiet": false, "invocation_command": "dbt docs generate", "populate_cache": true, "compile": true, "introspect": true, "partial_parse": true, "project_dir": "/home/runner/work/make-open-data/make-open-data", "warn_error_options": {"include": [], "exclude": []}, "log_file_max_bytes": 10485760, "defer": false, "cache_selected_only": false, "log_level": "info", "which": "generate", "strict_mode": false, "static": false, "enable_legacy_logger": false}}