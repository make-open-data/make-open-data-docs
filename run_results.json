{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v5.json", "dbt_version": "1.7.10", "generated_at": "2024-09-23T21:33:29.150023Z", "invocation_id": "df5f9182-3a10-4de1-a41c-4a4376887c97", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.409331Z", "completed_at": "2024-09-23T21:32:48.417098Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.418295Z", "completed_at": "2024-09-23T21:32:48.418308Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.011191844940185547, "adapter_response": {}, "message": null, "failures": null, "unique_id": "analysis.makeopendata.multiple_agg_per_cp", "compiled": true, "compiled_code": "-- Les departements et les r\u00e9gions sont donn\u00e9es par commune\n-- Il existe plusieurs codes postaux pour une commune et plusieurs communes pour un code postal\n-- Il convient de v\u00e9rifier que pour un code postal donn\u00e9, apr\u00e8s fusion avec la table communes,\n-- Il n'y a pas qu'un seul arrondissement, un seul d\u00e9partement et une seule r\u00e9gion\nwith merged_data as (\n    select\n        LPAD(CAST(cp.code_postal AS TEXT), 5, '0') as code_postal,\n        -- cc.\"ARR\" as code_arrondissement,\n        cc.departement as code_departement,\n        cc.region as code_region\n    from \"defaultdb\".\"sources\".\"cog_poste\" cp\n    inner join \"defaultdb\".\"sources\".\"cog_communes\" cc on cp.code_commune_insee = cc.\"COM\" and cc.\"TYPECOM\" = 'COM'\n    -- Remplacer par left join \u00e0 l'inclusions des territoire d'outre mer TOM \n    -- Puisque les codes communes ne sont pas renseign\u00e9s pour ces territoires dans codes_geographiques_communes\n    -- La R\u00e9union est une region d'outre, mais pas un territoire d'outre mer, d\u00e8s lors elle est incluse dans les codes_geographiques_communes\n),\n\ncounts as (\n    select \n        code_postal,\n        --count(distinct code_arrondissement) as num_arr,\n        count(distinct code_departement) as num_dep,\n        count(distinct code_region) as num_reg\n    from merged_data\n    group by code_postal\n)\n\nselect *\nfrom counts\nwhere num_dep > 1 or num_reg > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.421828Z", "completed_at": "2024-09-23T21:32:48.424680Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.425826Z", "completed_at": "2024-09-23T21:32:48.425831Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006137371063232422, "adapter_response": {}, "message": null, "failures": null, "unique_id": "analysis.makeopendata.multiple_com_per_cp", "compiled": true, "compiled_code": "--- Montre les codes postaux qui ont plusieurs codes communes\n\nSELECT code_postal, ARRAY_AGG(DISTINCT code_commune_insee) as communes\nFROM \"defaultdb\".\"sources\".\"cog_poste\" \nGROUP BY code_postal\nHAVING COUNT(DISTINCT code_commune_insee) > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.429281Z", "completed_at": "2024-09-23T21:32:48.432051Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.433198Z", "completed_at": "2024-09-23T21:32:48.433203Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006061077117919922, "adapter_response": {}, "message": null, "failures": null, "unique_id": "analysis.makeopendata.multiple_cp_per_com", "compiled": true, "compiled_code": "--- Montre les communes qui ont plusieurs codes postaux\n\nSELECT code_commune_insee, ARRAY_AGG(DISTINCT code_postal) as postal_codes\nFROM \"defaultdb\".\"sources\".\"cog_poste\" \nGROUP BY code_commune_insee\nHAVING COUNT(DISTINCT code_postal) > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.436661Z", "completed_at": "2024-09-23T21:32:48.440590Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.441761Z", "completed_at": "2024-09-23T21:32:48.441769Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007261753082275391, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.fake_knn_data", "compiled": true, "compiled_code": "-- Pour tester la fonction knn, nous devons cr\u00e9er une table avec des donn\u00e9es fictives \n-- (impossible de faire des tests unitaires sur des donn\u00e9es qui ne sont pas dans une table). \n-- cr\u00e9e une fausse table avec id, latitude, longitude, et valeur columns\n-- S'assurer que le calcul ne se fait pas sur l'objet de la table\n\n\n\nWITH fake_knn_table AS (\n    SELECT 1 AS id, ST_SetSRID(ST_MakePoint(43.7, 3.832), 4326) AS geopoint, 100 AS valeur UNION ALL -- (3, 2) --> (200 + 300) / 2 = 250\n    SELECT 3,       ST_SetSRID(ST_MakePoint(43.7, 3.830), 4326),             200 UNION ALL -- (1, 2) --> (100 + 300) / 2 = 200\n    SELECT 2,       ST_SetSRID(ST_MakePoint(43.7, 3.831), 4326),             300 UNION ALL -- (1, 3) --> (100 + 200) / 2 = 150\n    SELECT 4,       ST_SetSRID(ST_MakePoint(43.7, 3.839), 4326),             400 UNION ALL -- (6, 1) --> (500 + 100) / 2 = 300\n    SELECT 6,       ST_SetSRID(ST_MakePoint(43.7, 3.838), 4326),             500  -- (4, 1) --> (400 + 100) / 2 = 250\n)\n\n\nselect * from fake_knn_table", "relation_name": "\"defaultdb\".\"prepare\".\"fake_knn_data\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.445343Z", "completed_at": "2024-09-23T21:32:48.449500Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.450689Z", "completed_at": "2024-09-23T21:32:48.450695Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00751495361328125, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.infos_communes", "compiled": true, "compiled_code": "\n\nwith filtre_cog_communes as (\n    -- Filter out non-commune rows here to avoid confusion of filtering in the main query\n    select * \n    from \"defaultdb\".\"sources\".\"cog_communes\" as cog_communes     \n    where cog_communes.type in ('commune-actuelle', 'arrondissement-municipal')\n\n),denomalise_cog as (\n    select\n        LPAD(CAST(filtre_cog_communes.code as TEXT), 5, '0') as code_commune,\n        filtre_cog_communes.nom as nom_commune,\n        filtre_cog_communes.arrondissement as code_arrondissement,\n        filtre_cog_communes.departement as code_departement,\n        filtre_cog_communes.region as code_region,\n        \"codesPostaux\" as codes_postaux,\n        filtre_cog_communes.population as population,\n        filtre_cog_communes.zone as code_zone,\n        \n        cog_arrondissements.nom as nom_arrondissement,\n        cog_departements.nom as nom_departement,\n        cog_regions.nom as nom_region\n\n    from filtre_cog_communes\n    left join \"defaultdb\".\"sources\".\"cog_arrondissements\"  cog_arrondissements on cog_arrondissements.code = filtre_cog_communes.arrondissement\n    left join \"defaultdb\".\"sources\".\"cog_departements\"  cog_departements on cog_departements.code = filtre_cog_communes.departement\n    left join \"defaultdb\".\"sources\".\"cog_regions\"  cog_regions on cog_regions.code = filtre_cog_communes.region  \n    \n), gps as (\n    select DISTINCT\n        LPAD(CAST(cog_poste.code_commune_insee AS TEXT), 5, '0') as code_commune,\n        CAST(SPLIT_PART(cog_poste._geopoint, ',', 1) AS FLOAT) as commune_latitude,\n        CAST(SPLIT_PART(cog_poste._geopoint, ',', 2) AS FLOAT) as commune_longitude\n    from \"defaultdb\".\"sources\".\"cog_poste\"  as cog_poste\n)\n\nselect\n    denomalise_cog.*,\n    gps.commune_latitude,\n    gps.commune_longitude,\n    ST_SetSRID(ST_MakePoint(gps.commune_latitude, gps.commune_longitude), 4326) as commune_centre_geopoint\nfrom denomalise_cog\nleft join gps on denomalise_cog.code_commune = gps.code_commune", "relation_name": "\"defaultdb\".\"prepare\".\"infos_communes\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.454372Z", "completed_at": "2024-09-23T21:32:48.457943Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.459125Z", "completed_at": "2024-09-23T21:32:48.459131Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0069501399993896484, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.infos_postes", "compiled": true, "compiled_code": "\n\nwith format_cog_poste as (\n    select DISTINCT\n        LPAD(CAST(code_postal AS TEXT), 5, '0') as code_postal,\n        CASE \n\n            WHEN SUBSTRING(LPAD(CAST(code_postal AS TEXT), 5, '0') for 3) IN ('200', '201') THEN '2A'\n            WHEN SUBSTRING(LPAD(CAST(code_postal AS TEXT), 5, '0') FROM 1 FOR 2) = '20' THEN '2B'\n            WHEN SUBSTRING(LPAD(CAST(code_postal AS TEXT), 5, '0') FROM 1 FOR 5) = '97133' THEN '977' -- Saint Barthelemy, code postal 97133, code dept insee 977\n\t\t\tWHEN SUBSTRING(LPAD(CAST(code_postal AS TEXT), 5, '0') FROM 1 FOR 5) = '97150' THEN '978' -- Saint Martin, code postal 97150, code dept insee 978\n\t\t\tWHEN SUBSTRING(LPAD(CAST(code_postal AS TEXT), 5, '0') FROM 1 FOR 5) = '98799' THEN '989' -- \u00cele de Clipperton, code postal 97150, code dept insee 978\n\t\t\tWHEN SUBSTRING(LPAD(CAST(code_postal AS TEXT), 5, '0') for 2) IN ('97', '98') THEN SUBSTRING(LPAD(CAST(code_postal AS TEXT), 5, '0') for 3)\n            \n            ELSE SUBSTRING(LPAD(CAST(code_postal AS TEXT), 5, '0') for 2)\n        \n        END as code_departement\n    from \"defaultdb\".\"sources\".\"cog_poste\" as cog_poste\n),\n\njoin_departements as (\n    select \n        format_cog_poste.*,\n        cog_departements.nom as nom_departement,\n        cog_departements.region as code_region\n    from format_cog_poste\n    left join \"defaultdb\".\"sources\".\"cog_departements\" cog_departements on format_cog_poste.code_departement = cog_departements.code\n),\n\njoin_regions as (\n    select \n        join_departements.*,\n        cog_regions.nom as nom_region\n    from join_departements\n    left join \"defaultdb\".\"sources\".\"cog_regions\" cog_regions on join_departements.code_region = cog_regions.code\n)\n\nselect *\nfrom join_regions", "relation_name": "\"defaultdb\".\"prepare\".\"infos_postes\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.462713Z", "completed_at": "2024-09-23T21:32:48.465883Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.467053Z", "completed_at": "2024-09-23T21:32:48.467058Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006535053253173828, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.postes_communes", "compiled": true, "compiled_code": "\n\nwith unique_codes_communes_postaux as (\n    select DISTINCT\n        LPAD(CAST(code_postal AS TEXT), 5, '0') as code_postal,\n        code_commune_insee\n    from \"defaultdb\".\"sources\".\"cog_poste\" as cog_poste\n)\n\nselect *\nfrom unique_codes_communes_postaux", "relation_name": "\"defaultdb\".\"intermediaires\".\"postes_communes\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.470522Z", "completed_at": "2024-09-23T21:32:48.471839Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.472988Z", "completed_at": "2024-09-23T21:32:48.472994Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.004662275314331055, "adapter_response": {}, "message": null, "failures": null, "unique_id": "seed.makeopendata.logement_2020_valeurs", "compiled": null, "compiled_code": null, "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.476535Z", "completed_at": "2024-09-23T21:32:48.479685Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.480844Z", "completed_at": "2024-09-23T21:32:48.480849Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006554365158081055, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_one_arr", "compiled": true, "compiled_code": "-- Test qu'il n'ya pas de doublons dans la table des codes g\u00e9ographiques des arrondissements\n\nWITH counts as (\n    select \n        cog_arrondissements.code,\n        count(*) as num_arr\n    from \"defaultdb\".\"sources\".\"cog_arrondissements\"  as cog_arrondissements \n    group by cog_arrondissements.code\n)\n\nselect *\nfrom counts\nwhere num_arr > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.484392Z", "completed_at": "2024-09-23T21:32:48.487211Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.488361Z", "completed_at": "2024-09-23T21:32:48.488366Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006102800369262695, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_one_com", "compiled": true, "compiled_code": "-- Une commune peut avoir plusieurs types\n-- COM\tCommune / COMA\tCommune associ\u00e9e / COMD\tCommune d\u00e9l\u00e9gu\u00e9e / ARM\tArrondissement municipal\n-- Les COM sont celles existantes, les autres types sont des legacy de fusions ou disparitions de communes\n\nWITH counts as (\n    select \n        cog_communes.code,\n        count(*) as num_com\n    from \"defaultdb\".\"sources\".\"cog_communes\"  as cog_communes\n    where cog_communes.type = 'commune-actuelle'\n    group by cog_communes.code\n)\n\nselect *\nfrom counts\nwhere num_com > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.491789Z", "completed_at": "2024-09-23T21:32:48.494618Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.495764Z", "completed_at": "2024-09-23T21:32:48.495769Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006122589111328125, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_one_dep", "compiled": true, "compiled_code": "-- Test qu'il n'ya pas de doublons dans la table des codes g\u00e9ographiques des departements\n\nWITH counts as (\n    select \n        cog_departements.code,\n        count(*) as num_dep\n    from \"defaultdb\".\"sources\".\"cog_departements\" as cog_departements\n    group by cog_departements.code\n)\n\nselect *\nfrom counts\nwhere num_dep > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.499197Z", "completed_at": "2024-09-23T21:32:48.502226Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.503374Z", "completed_at": "2024-09-23T21:32:48.503378Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0062983036041259766, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_one_gps_com", "compiled": true, "compiled_code": "-- https://www.data.gouv.fr/fr/datasets/base-officielle-des-codes-postaux/\n-- Mention que : contient en plus les coordonn\u00e9es des centro\u00efdes des communes est \u00e9galement disponible.\n-- V\u00e9rifions que les coordonn\u00e9es des centro\u00efdes sont bien uniques pour chaque commune\n\n\n\nwith source as (\n    SELECT code_commune_insee, COUNT(DISTINCT _geopoint) as geopoint_count\n    FROM \"defaultdb\".\"sources\".\"cog_poste\" as cog_poste\n    GROUP BY code_commune_insee\n)\n\nselect *\nfrom source\nwhere geopoint_count > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.506839Z", "completed_at": "2024-09-23T21:32:48.509784Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.510930Z", "completed_at": "2024-09-23T21:32:48.510936Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0063250064849853516, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_one_price_mutation", "compiled": true, "compiled_code": "-- Dans le fichier source de dvf, les mutations apparaissent sur plusieurs ligne\n-- Il s'agit des transactions multiventes (un appartement dans une ligne et une maison dans une autre)\n-- Il s'agit donc de v\u00e9rifier que chaque mutation, donc dans les lignes o\u00f9 elle apparait, il n'a qu'une seule valeur fonci\u00e8re\n\nWITH mutation_values AS (\n    SELECT \n        id_mutation,\n        code_commune,\n        code_postal,\n        latitude,\n        longitude,\n        valeur_fonciere\n    FROM \n        \"defaultdb\".\"sources\".\"dvf_2023\" as dvf_2023\n),\n\nmutation_value_counts AS (\n    SELECT \n        id_mutation,\n        COUNT(DISTINCT valeur_fonciere) AS distinct_fonciere_count\n    FROM \n        mutation_values\n    GROUP BY \n        id_mutation\n)\n\nSELECT \n    id_mutation,\n    distinct_fonciere_count\nFROM \n    mutation_value_counts\nWHERE \n    distinct_fonciere_count > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.514410Z", "completed_at": "2024-09-23T21:32:48.517196Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.518347Z", "completed_at": "2024-09-23T21:32:48.518351Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.006096363067626953, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_one_reg", "compiled": true, "compiled_code": "-- Test qu'il n'ya pas de doublons dans la table des codes g\u00e9ographiques des r\u00e9gions\n\nWITH counts as (\n    select \n        cog_regions.code,\n        count(*) as num_reg\n    from \"defaultdb\".\"sources\".\"cog_regions\" as cog_regions\n    group by cog_regions.code\n)\n\nselect *\nfrom counts\nwhere num_reg > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.521814Z", "completed_at": "2024-09-23T21:32:48.526686Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.527833Z", "completed_at": "2024-09-23T21:32:48.527838Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.008188009262084961, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.effectif_tout_departement_egal_some_region", "compiled": true, "compiled_code": "-- Teste que l'entr\u00e9e 'Tout d\u00e9partement' dans libelle de departement reporte le total des effectifs de tous les d\u00e9partements\n\n\nWITH sommes_par_departement AS (\n    SELECT \n        annee, \n        profession_sante, \n        libelle_region, \n        SUM(cast(effectif as numeric)) AS effectif_total_calcule\n    FROM \"defaultdb\".\"sources\".\"professionels_sante\"\n    WHERE libelle_departement != 'Tout departement'\n    GROUP BY annee, profession_sante, libelle_region\n),\n\t\ntout_departement AS (\n    SELECT \n        annee, \n        profession_sante, \n        libelle_region, \n        CAST(effectif as numeric) AS tout_departement_effectif\n    FROM \"defaultdb\".\"sources\".\"professionels_sante\"\n    WHERE libelle_departement = 'Tout departement'\n)\n\t\nSELECT \n    sommes_par_departement.effectif_total_calcule, \n    tout_departement.tout_departement_effectif\nFROM sommes_par_departement\nLEFT JOIN tout_departement \n    ON sommes_par_departement.annee = tout_departement.annee \n    AND sommes_par_departement.profession_sante = tout_departement.profession_sante \n    AND sommes_par_departement.libelle_region = tout_departement.libelle_region\nWHERE sommes_par_departement.effectif_total_calcule != tout_departement.tout_departement_effectif", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.531315Z", "completed_at": "2024-09-23T21:32:48.578564Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.579745Z", "completed_at": "2024-09-23T21:32:48.579751Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.05061650276184082, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.test_knn", "compiled": true, "compiled_code": "-- depends_on: \"defaultdb\".\"prepare\".\"fake_knn_data\"\n\n-- Define expected values\nWITH expected AS (\n    SELECT 1 AS id, 250 AS expected_valeur UNION ALL\n    SELECT 3,       200 UNION ALL\n    SELECT 2,       150 UNION ALL\n    SELECT 4,       300 UNION ALL\n    SELECT 6,       250\n),\n\n-- Calculate knn for each row in the fake table\ncomputed AS (\n    \nWITH knn AS (\n    SELECT \n        a.id AS id,\n        AVG(b.valeur) AS prix_m2_knn_2\n    FROM \n        \"defaultdb\".\"prepare\".\"fake_knn_data\" a\n        JOIN LATERAL (\n            SELECT valeur\n            FROM \"defaultdb\".\"prepare\".\"fake_knn_data\"\n            WHERE (id != a.id)\n            ORDER BY a.geopoint <-> geopoint\n            LIMIT 2\n        ) b ON TRUE\n    GROUP BY a.id\n)\n\nSELECT * FROM knn\n\n\n\n)\n\n-- Compare computed and expected values\nSELECT \n    computed.id, \n    computed.prix_m2_knn_2 AS computed_valeur, \n    expected.expected_valeur\nFROM \n    computed\n    JOIN expected ON computed.id = expected.id\nWHERE\n    computed.prix_m2_knn_2 != expected.expected_valeur", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.583309Z", "completed_at": "2024-09-23T21:32:48.587691Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.588867Z", "completed_at": "2024-09-23T21:32:48.588871Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007792472839355469, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.commune_centroid_poste", "compiled": true, "compiled_code": "\n\nWITH coordonnee_moyenne_par_code_postal AS (\n    SELECT \n        cog_poste.code_postal as code_postal,\n        AVG(infos_communes.commune_latitude) AS avg_lat,\n        AVG(infos_communes.commune_longitude) AS avg_lon\n    FROM \"defaultdb\".\"sources\".\"cog_poste\" cog_poste\n    LEFT JOIN \"defaultdb\".\"prepare\".\"infos_communes\" infos_communes \n    ON infos_communes.code_commune = cog_poste.code_commune_insee\n    GROUP BY cog_poste.code_postal\n),\ndistinct_code_postal AS (\n    SELECT DISTINCT \n        code_postal, \n        code_commune_insee\n    FROM \"defaultdb\".\"sources\".\"cog_poste\"\n),\ncog_postal_et_distance_moyenne AS (\n    SELECT \n        distinct_code_postal.*,\n        coordonnee_moyenne_par_code_postal.avg_lat,\n        coordonnee_moyenne_par_code_postal.avg_lon\n    FROM distinct_code_postal\n    LEFT JOIN coordonnee_moyenne_par_code_postal\n    ON distinct_code_postal.code_postal = coordonnee_moyenne_par_code_postal.code_postal\n),\ncode_postal_et_commune_et_distance AS (\n    SELECT \n        cog_postal_et_distance_moyenne.*,\n        infos_communes.*,\n        SQRT(POWER(infos_communes.commune_latitude - cog_postal_et_distance_moyenne.avg_lat, 2) + POWER(infos_communes.commune_longitude - cog_postal_et_distance_moyenne.avg_lon, 2)) AS distance\n    FROM cog_postal_et_distance_moyenne \n    LEFT JOIN \"defaultdb\".\"prepare\".\"infos_communes\" infos_communes\n    ON cog_postal_et_distance_moyenne.code_commune_insee = infos_communes.code_commune\n),\ncode_postal_et_commune_et_rang_distance_centre AS (\n    SELECT \n        *,\n    ROW_NUMBER() OVER (PARTITION BY code_postal ORDER BY distance, population DESC) AS rang_distance_puis_population \n    FROM code_postal_et_commune_et_distance\n),\ncode_postal_et_commune_centrale AS (\n    SELECT \n        code_postal,\n        code_commune as code_commune_centrale,\n        nom_commune as nom_commune_centrale,\n        code_departement,\n        avg_lat as latitude_centrale_code_postal,\n        avg_lon as longitude_centrale_code_postal\n    FROM code_postal_et_commune_et_rang_distance_centre\n    WHERE rang_distance_puis_population = 1\n),\njoin_departements as (\n    select \n        code_postal_et_commune_centrale.*,\n        cog_departements.nom as nom_departement,\n        cog_departements.region as code_region\n    from code_postal_et_commune_centrale\n    left join \"defaultdb\".\"sources\".\"cog_departements\" cog_departements \n    on code_postal_et_commune_centrale.code_departement = cog_departements.code\n),\n\njoin_regions as (\n    select \n        join_departements.*,\n        cog_regions.nom as nom_region\n    from join_departements\n    left join \"defaultdb\".\"sources\".\"cog_regions\" cog_regions \n    on join_departements.code_region = cog_regions.code\n)\n\nselect *\nfrom join_regions", "relation_name": "\"defaultdb\".\"prepare\".\"commune_centroid_poste\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.592372Z", "completed_at": "2024-09-23T21:32:48.598638Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:48.599871Z", "completed_at": "2024-09-23T21:32:48.599876Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009762048721313477, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.mutations_foncieres", "compiled": true, "compiled_code": "-- Filtres nature transaction et nature bien :\n-- Il convient aussi de garder que les vente (explure les VEFA et les \u00e9changes)\n-- Et que les transactions qui concernent au moins un appartement et les maisons\n\n-- Filtres sur les surfaces et trautement des pi\u00e8ces :\n-- Il convient de garder que les transactions qui concernent des biens de plus de 9m2 \n-- Le nombre de pi\u00e8ces est souvent mal renseign\u00e9, il convient de le corriger en fonction de la surface\n\n-- Filtres sur les prix :\n-- Il convient de garder que les transactions dont le prix au metre carr\u00e9 n'est pas 50% de plus que ses 10 plus proches voisins\n\n-- Donn\u00e9es par mutation : \n-- Les donn\u00e9es DVF sont initilement pr\u00e9sent\u00e9es sous forme d'une ligne par mutation (transaction)\n-- Une mutation peut concerner plusieurs biens\n-- Le prix est le prix total de la mutation, il apparait sur les biens concern\u00e9s\n\n\n\nWITH source_dvf AS (\n    select * from \"defaultdb\".\"sources\".\"dvf_2023\" as dvf_2023\n),\nfiltrer_dvf AS (\n    \n    SELECT \n        id_mutation,\n        CAST(valeur_fonciere AS FLOAT) as valeur_fonciere,\n        CAST(longitude AS FLOAT) as longitude,\n        CAST(latitude AS FLOAT) as latitude,\n        CAST(nombre_pieces_principales AS NUMERIC) as nombre_pieces_principales,\n        CAST(surface_reelle_bati AS NUMERIC) as surface_reelle_bati,\n        type_local,\n        LPAD(CAST(code_postal AS TEXT), 5, '0') as code_postal,\n        code_commune\n    FROM \n        source_dvf \n     WHERE \n        EXISTS (\n            SELECT 1\n            FROM source_dvf d1\n            WHERE d1.id_mutation = source_dvf.id_mutation AND d1.type_local IN ('Appartement', 'Maison')\n        ) AND\n        NOT EXISTS (\n            SELECT 1\n            FROM source_dvf d2\n            WHERE d2.id_mutation = source_dvf.id_mutation AND d2.nature_mutation != 'Vente'\n        )\n\n),\naggreger_dvf AS (\n    \n    SELECT \n        id_mutation,\n        SUM(CAST(surface_reelle_bati AS numeric)) AS total_surface,\n        SUM(CAST(nombre_pieces_principales AS numeric)) AS total_pieces\n    FROM \n        filtrer_dvf\n    GROUP BY \n        id_mutation\n\n),\nbien_principal_dvf AS (\n    \n    SELECT *\n    FROM (\n        SELECT \n            *,\n            ROW_NUMBER() OVER (\n                PARTITION BY id_mutation\n                ORDER BY \n                    CASE WHEN type_local = 'Maison' THEN 1\n                         WHEN type_local = 'Appartement' THEN 2\n                         ELSE 3\n                    END,\n                    surface_reelle_bati DESC\n            ) AS rang\n        FROM \n            filtrer_dvf\n    ) subquery\n    WHERE\n        rang = 1\n\n) \nSELECT \n    bien_principal_dvf.id_mutation,\n    bien_principal_dvf.valeur_fonciere,\n    bien_principal_dvf.longitude,\n    bien_principal_dvf.latitude,\n    aggreger_dvf.total_pieces,\n    aggreger_dvf.total_surface,\n    bien_principal_dvf.type_local,\n    bien_principal_dvf.code_postal,\n    bien_principal_dvf.code_commune,\n    ST_SetSRID(ST_MakePoint(bien_principal_dvf.latitude, bien_principal_dvf.longitude), 4326) as geopoint,\n    bien_principal_dvf.valeur_fonciere / aggreger_dvf.total_surface as prix_m2,\n    infos_communes.nom_commune,\n    infos_communes.code_arrondissement,\n    infos_communes.code_departement,\n    infos_communes.code_region,\n    infos_communes.nom_arrondissement,\n    infos_communes.nom_departement,\n    infos_communes.nom_region\nFROM \n    bien_principal_dvf\nJOIN \n    aggreger_dvf ON aggreger_dvf.id_mutation = bien_principal_dvf.id_mutation\nLEFT JOIN\n    \"defaultdb\".\"prepare\".\"infos_communes\" as infos_communes on infos_communes.code_commune = bien_principal_dvf.code_commune", "relation_name": "\"defaultdb\".\"intermediaires\".\"mutations_foncieres\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:48.603557Z", "completed_at": "2024-09-23T21:32:50.411917Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:50.413184Z", "completed_at": "2024-09-23T21:32:50.413192Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 1.9210522174835205, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.professionels_sante_departement", "compiled": true, "compiled_code": "\n\nwith aggreger_effectif_sante_unpivot as (\n\tselect \n\t\tregion,\n\t\tlibelle_region,\n\t\tdepartement,\n\t\tlibelle_departement,\n\t\tprofession_sante,\n\t\tsum(cast(effectif as numeric)) as effectif\n\tFROM \"defaultdb\".\"sources\".\"professionels_sante\"\n\twhere (annee = '2022') and (libelle_departement != 'Tout d\u00e9partement')  and (libelle_departement != 'FRANCE')\n\tgroup by region, departement, libelle_region, libelle_departement, profession_sante\n),\naggreger_effectif_sante_departements as (\n\tselect \n\t\tregion,\n\t\tlibelle_region,\n\t\tdepartement,\n\t\tlibelle_departement,\n\t\t\n  \n    sum(\n      \n      case\n      when profession_sante = 'Stomatologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Stomatologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Anesth\u00e9sistes-r\u00e9animateurs'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Anesth\u00e9sistes-r\u00e9animateurs\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Autres m\u00e9decins'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Autres m\u00e9decins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Cardiologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Cardiologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Chirurgiens'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Chirurgiens\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Chirurgiens-dentistes (hors sp\u00e9cialistes d''orthop\u00e9die dento-faciale - ODF)'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Chirurgiens-dentistes (hors sp\u00e9cialistes d'orthop\u00e9die dento-faciale - ODF)\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Chirurgiens-dentistes sp\u00e9cialistes d''orthop\u00e9die dento-faciale (ODF)'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Chirurgiens-dentistes sp\u00e9cialistes d'orthop\u00e9die dento-faciale (ODF)\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Dermatologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Dermatologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Endocrinologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Endocrinologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Ensemble des auxiliaires m\u00e9dicaux'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Ensemble des auxiliaires m\u00e9dicaux\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Ensemble des chirurgiens-dentistes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Ensemble des chirurgiens-dentistes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Ensemble des m\u00e9decins'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Ensemble des m\u00e9decins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Ensemble des m\u00e9decins g\u00e9n\u00e9ralistes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Ensemble des m\u00e9decins g\u00e9n\u00e9ralistes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Ensemble des m\u00e9decins sp\u00e9cialistes (hors g\u00e9n\u00e9ralistes)'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Ensemble des m\u00e9decins sp\u00e9cialistes (hors g\u00e9n\u00e9ralistes)\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Gyn\u00e9cologues m\u00e9dicaux et obst\u00e9triciens'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Gyn\u00e9cologues m\u00e9dicaux et obst\u00e9triciens\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'H\u00e9pato-gastro-ent\u00e9rologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"H\u00e9pato-gastro-ent\u00e9rologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Infirmiers'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Infirmiers\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Masseurs-kin\u00e9sith\u00e9rapeutes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Masseurs-kin\u00e9sith\u00e9rapeutes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'M\u00e9decins g\u00e9n\u00e9ralistes \u00e0 expertise particuli\u00e8re (MEP)'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"M\u00e9decins g\u00e9n\u00e9ralistes \u00e0 expertise particuli\u00e8re (MEP)\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'M\u00e9decins g\u00e9n\u00e9ralistes (hors m\u00e9decins \u00e0 expertise particuli\u00e8re - MEP)'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"M\u00e9decins g\u00e9n\u00e9ralistes (hors m\u00e9decins \u00e0 expertise particuli\u00e8re - MEP)\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'M\u00e9decins nucl\u00e9aires'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"M\u00e9decins nucl\u00e9aires\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'M\u00e9decins pathologistes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"M\u00e9decins pathologistes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Rhumatologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Rhumatologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Sages-femmes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Sages-femmes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'N\u00e9phrologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"N\u00e9phrologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Neurologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Neurologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Ophtalmologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Ophtalmologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Orthophonistes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Orthophonistes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Orthoptistes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Orthoptistes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Oto-rhino-laryngologistes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Oto-rhino-laryngologistes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'P\u00e9diatres'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"P\u00e9diatres\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'P\u00e9dicures-podologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"P\u00e9dicures-podologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Pneumologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Pneumologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Psychiatres'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Psychiatres\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Radiologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Radiologues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Radioth\u00e9rapeutes'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Radioth\u00e9rapeutes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'M\u00e9decins vasculaires'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"M\u00e9decins vasculaires\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when profession_sante = 'Allergologues'\n        then effectif\n      else 0\n      end\n    )\n    \n      \n            as \"Allergologues\"\n      \n    \n    \n  \n\n  \tFROM aggreger_effectif_sante_unpivot\n\tgroup by region, libelle_region, departement, libelle_departement\n),\ninfos_par_departement as (\n\tselect \n\t\tcode_departement,\n\t\tsum(cast(population as numeric)) as population_departement,\n\t\tavg(commune_latitude) as latitude_centre_departement,\n\t\tavg(commune_longitude) as longitude_centre_departement\n\tfrom \"defaultdb\".\"prepare\".\"infos_communes\"\n\tgroup by code_departement\n)\n\nselect \n\taggreger_effectif_sante_departements.*,\n\tinfos_par_departement.population_departement,\n\tinfos_par_departement.latitude_centre_departement,\n\tinfos_par_departement.longitude_centre_departement\nfrom aggreger_effectif_sante_departements\nleft join infos_par_departement \non aggreger_effectif_sante_departements.departement = infos_par_departement.code_departement", "relation_name": "\"defaultdb\".\"prepare\".\"professionels_sante_departement\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:50.525791Z", "completed_at": "2024-09-23T21:32:50.529691Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:50.530873Z", "completed_at": "2024-09-23T21:32:50.530879Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007227182388305664, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_geo_communes_number", "compiled": true, "compiled_code": "--- Le nombre officiel de communes est de 35029 soit\n--- zone = metro & drom est de 34935 en 2024\n--- i.e. france metropole et departement d'outre mer\n--- https://www.collectivites-locales.gouv.fr/bulletin-dinformation-statistique-bis-de-la-dgcl\n--- PLUS zone = com  est 94 \n--- i.e. collectivit\u00e9 d'outre mer\n--- Plus 45 communes municipales (Paris, Lyon, Marseille)\n\n\n\nwith source as (\n    SELECT COUNT(DISTINCT code_commune) as commune_count\n    FROM \"defaultdb\".\"prepare\".\"infos_communes\"\n)\n\nselect *\nfrom source\nwhere commune_count != 35074", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:50.534323Z", "completed_at": "2024-09-23T21:32:50.537343Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:50.538479Z", "completed_at": "2024-09-23T21:32:50.538483Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00634455680847168, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.asset_geo_communes_distinct", "compiled": true, "compiled_code": "--- V\u00e9rifie que les communes du mod\u00e8le sont distinctes\n\n\n\nwith counts as (\n    SELECT code_commune, COUNT(*) as num_com\n    FROM \"defaultdb\".\"prepare\".\"infos_communes\"\n    GROUP BY code_commune\n)\n\nselect *\nfrom counts\nwhere num_com > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:50.541923Z", "completed_at": "2024-09-23T21:32:50.554601Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:50.555774Z", "completed_at": "2024-09-23T21:32:50.555779Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.016063451766967773, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_infos_communes_code_commune.4e03754490", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect code_commune\nfrom \"defaultdb\".\"prepare\".\"infos_communes\"\nwhere code_commune is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:50.559313Z", "completed_at": "2024-09-23T21:32:50.565497Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:50.566652Z", "completed_at": "2024-09-23T21:32:50.566657Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009505748748779297, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_infos_communes_code_commune.9c66e801cd", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    code_commune as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prepare\".\"infos_communes\"\nwhere code_commune is not null\ngroup by code_commune\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:50.570118Z", "completed_at": "2024-09-23T21:32:50.573076Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:50.574208Z", "completed_at": "2024-09-23T21:32:50.574212Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0063288211822509766, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.assert_geo_postaux_distinct", "compiled": true, "compiled_code": "--- V\u00e9rifie que les codes postaux du mod\u00e8le sont distincts\n\n\n\nwith counts as (\n    SELECT code_postal, COUNT(*) as num_cp\n    FROM \"defaultdb\".\"prepare\".\"infos_postes\"\n    GROUP BY code_postal\n)\n\nselect *\nfrom counts\nwhere num_cp > 1", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:50.577714Z", "completed_at": "2024-09-23T21:32:50.581633Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:50.582812Z", "completed_at": "2024-09-23T21:32:50.582817Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007283210754394531, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_infos_postes_code_postal.95fe263c82", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect code_postal\nfrom \"defaultdb\".\"prepare\".\"infos_postes\"\nwhere code_postal is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:50.586327Z", "completed_at": "2024-09-23T21:32:50.590183Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:50.591354Z", "completed_at": "2024-09-23T21:32:50.591358Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007235527038574219, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_infos_postes_code_postal.ecffc082fd", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    code_postal as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prepare\".\"infos_postes\"\nwhere code_postal is not null\ngroup by code_postal\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:50.594816Z", "completed_at": "2024-09-23T21:32:54.024980Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:54.026243Z", "completed_at": "2024-09-23T21:32:54.026250Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.545316219329834, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.activite_communes", "compiled": true, "compiled_code": "--- depends_on: \"defaultdb\".\"prepare\".\"logement_2020_valeurs\"\n\n--- Agr\u00e8ge les donn\u00e9es de la base logement par commune\n--- Colonne par colonne pour ne pas saturer la m\u00e9moire\n--- L'agr\u00e9gration est faite par univot/pivot.\n\n\n\n\n\n\n\n\n\n\n\n\nwith communes as (\n    SELECT \n      \"COMMUNE\" as code_commune_insee,\n      CAST( SUM(CAST(\"IPONDL\" AS numeric)) AS INT) AS nombre_de_logements\n    FROM \n      \"defaultdb\".\"sources\".\"logement_2020\"\n    GROUP BY\n      code_commune_insee\n  ),\n  aggregated as (\n\n    SELECT * \n\n    FROM communes\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INEEM' as TEXT) as \"champs\",\n      cast(  \n           \"INEEM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INEEM_0'  , \n        \n            'INEEM_1'  , \n        \n            'INEEM_10'  , \n        \n            'INEEM_11'  , \n        \n            'INEEM_12'  , \n        \n            'INEEM_2'  , \n        \n            'INEEM_3'  , \n        \n            'INEEM_4'  , \n        \n            'INEEM_5'  , \n        \n            'INEEM_6'  , \n        \n            'INEEM_7'  , \n        \n            'INEEM_8'  , \n        \n            'INEEM_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INEEM_0' then 'menages_avec_0_eleve_etudiant_14_ans_et_plus'\n            \n                when 'INEEM_1' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_10' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_11' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_12' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_2' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_3' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_4' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_5' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_6' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_7' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_8' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_9' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_eleve_etudiant_14_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_eleve_etudiant_14_ans_et_plus\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('TPM' as TEXT) as \"champs\",\n      cast(  \n           \"TPM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'TPM_1'  , \n        \n            'TPM_2'  , \n        \n            'TPM_Z' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'TPM_1' then 'menages_pr_travail_temps_complet'\n            \n                when 'TPM_2' then 'menages_pr_travail_temps_partiel'\n            \n                when 'TPM_Z' then 'menages_pr_travail_temps_sans_objet_sans_emploi'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_travail_temps_complet'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_travail_temps_complet\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_travail_temps_partiel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_travail_temps_partiel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_travail_temps_sans_objet_sans_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_travail_temps_sans_objet_sans_emploi\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INPOM' as TEXT) as \"champs\",\n      cast(  \n           \"INPOM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INPOM_0'  , \n        \n            'INPOM_1'  , \n        \n            'INPOM_10'  , \n        \n            'INPOM_11'  , \n        \n            'INPOM_12'  , \n        \n            'INPOM_13'  , \n        \n            'INPOM_14'  , \n        \n            'INPOM_15'  , \n        \n            'INPOM_16'  , \n        \n            'INPOM_17'  , \n        \n            'INPOM_18'  , \n        \n            'INPOM_19'  , \n        \n            'INPOM_2'  , \n        \n            'INPOM_20'  , \n        \n            'INPOM_26'  , \n        \n            'INPOM_3'  , \n        \n            'INPOM_4'  , \n        \n            'INPOM_41'  , \n        \n            'INPOM_5'  , \n        \n            'INPOM_6'  , \n        \n            'INPOM_7'  , \n        \n            'INPOM_8'  , \n        \n            'INPOM_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INPOM_0' then 'menages_avec_0_personne_active_avec_emploi'\n            \n                when 'INPOM_1' then 'menages_avec_1_personne_active_avec_emploi'\n            \n                when 'INPOM_10' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_11' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_12' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_13' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_14' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_15' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_16' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_17' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_18' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_19' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_2' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_20' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_26' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_3' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_4' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_41' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_5' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_6' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_7' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_8' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_9' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_active_avec_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_active_avec_emploi\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_personne_active_avec_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_personne_active_avec_emploi\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_2_et_plus_personnes_actives_avec_emploi\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('DIPLM' as TEXT) as \"champs\",\n      cast(  \n           \"DIPLM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'DIPLM_1'  , \n        \n            'DIPLM_11'  , \n        \n            'DIPLM_12'  , \n        \n            'DIPLM_13'  , \n        \n            'DIPLM_14'  , \n        \n            'DIPLM_15'  , \n        \n            'DIPLM_16'  , \n        \n            'DIPLM_17'  , \n        \n            'DIPLM_18'  , \n        \n            'DIPLM_19'  , \n        \n            'DIPLM_2'  , \n        \n            'DIPLM_3' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'DIPLM_1' then 'pr_scolarite_avant_primaire'\n            \n                when 'DIPLM_11' then 'pr_scolarite_CEP'\n            \n                when 'DIPLM_12' then 'pr_scolarite_BEPC'\n            \n                when 'DIPLM_13' then 'pr_scolarite_CAP_BEP'\n            \n                when 'DIPLM_14' then 'pr_scolarite_bac_general_techno'\n            \n                when 'DIPLM_15' then 'pr_scolarite_bar_pr'\n            \n                when 'DIPLM_16' then 'pr_scolarite_bac_plus_2'\n            \n                when 'DIPLM_17' then 'pr_scolarite_bac_plus_3_ou_4'\n            \n                when 'DIPLM_18' then 'pr_scolarite_bac_plus_5'\n            \n                when 'DIPLM_19' then 'pr_scolarite_bac_plus_8'\n            \n                when 'DIPLM_2' then 'pr_scolarite_avant_college'\n            \n                when 'DIPLM_3' then 'pr_scolarite_fin_college'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_avant_primaire'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_avant_primaire\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_CEP'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_CEP\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_BEPC'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_BEPC\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_CAP_BEP'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_CAP_BEP\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_bac_general_techno'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_bac_general_techno\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_bar_pr'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_bar_pr\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_bac_plus_2'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_bac_plus_2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_bac_plus_3_ou_4'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_bac_plus_3_ou_4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_bac_plus_5'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_bac_plus_5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_bac_plus_8'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_bac_plus_8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_avant_college'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_avant_college\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_fin_college'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_fin_college\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INPAM' as TEXT) as \"champs\",\n      cast(  \n           \"INPAM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INPAM_0'  , \n        \n            'INPAM_1'  , \n        \n            'INPAM_10'  , \n        \n            'INPAM_11'  , \n        \n            'INPAM_12'  , \n        \n            'INPAM_13'  , \n        \n            'INPAM_14'  , \n        \n            'INPAM_15'  , \n        \n            'INPAM_16'  , \n        \n            'INPAM_17'  , \n        \n            'INPAM_18'  , \n        \n            'INPAM_19'  , \n        \n            'INPAM_2'  , \n        \n            'INPAM_20'  , \n        \n            'INPAM_26'  , \n        \n            'INPAM_3'  , \n        \n            'INPAM_4'  , \n        \n            'INPAM_41'  , \n        \n            'INPAM_5'  , \n        \n            'INPAM_6'  , \n        \n            'INPAM_7'  , \n        \n            'INPAM_8'  , \n        \n            'INPAM_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INPAM_0' then 'menages_avec_0_personne_active'\n            \n                when 'INPAM_1' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_10' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_11' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_12' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_13' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_14' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_15' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_16' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_17' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_18' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_19' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_2' then 'menages_avec_2_et_plus_personnes_actives'\n            \n                when 'INPAM_20' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_26' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_3' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_4' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_41' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_5' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_6' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_7' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_8' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_9' then 'menages_avec_1_personne_active'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_active'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_active\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_personne_active'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_personne_active\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_2_et_plus_personnes_actives'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_2_et_plus_personnes_actives\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('EMPLM' as TEXT) as \"champs\",\n      cast(  \n           \"EMPLM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'EMPLM_11'  , \n        \n            'EMPLM_12'  , \n        \n            'EMPLM_13'  , \n        \n            'EMPLM_14'  , \n        \n            'EMPLM_15'  , \n        \n            'EMPLM_16'  , \n        \n            'EMPLM_21'  , \n        \n            'EMPLM_22'  , \n        \n            'EMPLM_23'  , \n        \n            'EMPLM_ZZ' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'EMPLM_11' then 'pr_emploi_apprentissage'\n            \n                when 'EMPLM_12' then 'pr_emploi_interim'\n            \n                when 'EMPLM_13' then 'pr_emploi_contrat_aide'\n            \n                when 'EMPLM_14' then 'pr_emploi_stage_entreprise'\n            \n                when 'EMPLM_15' then 'pr_emploi_duree_limite'\n            \n                when 'EMPLM_16' then 'pr_emploi_sans_duree_limite'\n            \n                when 'EMPLM_21' then 'pr_emploi_independant'\n            \n                when 'EMPLM_22' then 'pr_emploi_employeur'\n            \n                when 'EMPLM_23' then 'pr_emploi_aides_familiaux'\n            \n                when 'EMPLM_ZZ' then 'pr_emploi_sans_objet'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_apprentissage'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_apprentissage\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_interim'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_interim\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_contrat_aide'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_contrat_aide\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_stage_entreprise'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_stage_entreprise\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_duree_limite'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_duree_limite\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_sans_duree_limite'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_sans_duree_limite\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_independant'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_independant\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_employeur'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_employeur\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_aides_familiaux'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_aides_familiaux\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_sans_objet'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_sans_objet\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('RECHM' as TEXT) as \"champs\",\n      cast(  \n           \"RECHM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'RECHM_0'  , \n        \n            'RECHM_1'  , \n        \n            'RECHM_2'  , \n        \n            'RECHM_9'  , \n        \n            'RECHM_Z' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'RECHM_0' then 'menages_pr_pas_de_recherche_emploi'\n            \n                when 'RECHM_1' then 'menages_pr_recherche_emploi_moins_un_an'\n            \n                when 'RECHM_2' then 'menages_pr_recherche_emploi_plus_un_an'\n            \n                when 'RECHM_9' then 'menages_pr_recherche_emploi_non_declaree'\n            \n                when 'RECHM_Z' then 'menages_pr_recherche_emploi_sans_objet_en_emploi'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_pas_de_recherche_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_pas_de_recherche_emploi\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_recherche_emploi_moins_un_an'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_recherche_emploi_moins_un_an\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_recherche_emploi_plus_un_an'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_recherche_emploi_plus_un_an\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_recherche_emploi_non_declaree'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_recherche_emploi_non_declaree\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_recherche_emploi_sans_objet_en_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_recherche_emploi_sans_objet_en_emploi\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('TACTM' as TEXT) as \"champs\",\n      cast(  \n           \"TACTM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'TACTM_11'  , \n        \n            'TACTM_12'  , \n        \n            'TACTM_21'  , \n        \n            'TACTM_22'  , \n        \n            'TACTM_24'  , \n        \n            'TACTM_25' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'TACTM_11' then 'menages_pr_activite_emploi'\n            \n                when 'TACTM_12' then 'menages_pr_activite_chomeurs'\n            \n                when 'TACTM_21' then 'menages_pr_activite_retraite_pre_retraite'\n            \n                when 'TACTM_22' then 'menages_pr_activite_eleve'\n            \n                when 'TACTM_24' then 'menages_pr_activite_au_foyer'\n            \n                when 'TACTM_25' then 'menages_pr_activite_autre'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_activite_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_activite_emploi\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_activite_chomeurs'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_activite_chomeurs\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_activite_retraite_pre_retraite'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_activite_retraite_pre_retraite\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_activite_eleve'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_activite_eleve\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_activite_au_foyer'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_activite_au_foyer\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_activite_autre'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_activite_autre\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INPSM' as TEXT) as \"champs\",\n      cast(  \n           \"INPSM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INPSM_0'  , \n        \n            'INPSM_1'  , \n        \n            'INPSM_10'  , \n        \n            'INPSM_11'  , \n        \n            'INPSM_12'  , \n        \n            'INPSM_13'  , \n        \n            'INPSM_14'  , \n        \n            'INPSM_15'  , \n        \n            'INPSM_16'  , \n        \n            'INPSM_2'  , \n        \n            'INPSM_25'  , \n        \n            'INPSM_3'  , \n        \n            'INPSM_4'  , \n        \n            'INPSM_5'  , \n        \n            'INPSM_6'  , \n        \n            'INPSM_7'  , \n        \n            'INPSM_8'  , \n        \n            'INPSM_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INPSM_0' then 'menages_avec_0_personne_scolarisee'\n            \n                when 'INPSM_1' then 'menages_avec_1_personne_scolarisee'\n            \n                when 'INPSM_10' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_11' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_12' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_13' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_14' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_15' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_16' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_2' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_25' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_3' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_4' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_5' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_6' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_7' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_8' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_9' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_scolarisee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_scolarisee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_personne_scolarisee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_personne_scolarisee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_2_et_plus_personnes_scolarisees'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_2_et_plus_personnes_scolarisees\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n  ),\n  aggregated_with_infos_communes as (\n    SELECT\n      *\n    FROM\n      aggregated\n    JOIN\n\t    \"defaultdb\".\"prepare\".\"infos_communes\" as infos_communes\n    ON\n      aggregated.code_commune_insee = infos_communes.code_commune\n  )\n\nSELECT \n    *  \nFROM\n    aggregated_with_infos_communes", "relation_name": "\"defaultdb\".\"prepare\".\"activite_communes\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:54.141770Z", "completed_at": "2024-09-23T21:32:57.462813Z"}, {"name": "execute", "started_at": "2024-09-23T21:32:57.464100Z", "completed_at": "2024-09-23T21:32:57.464107Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.4324748516082764, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.activite_iris", "compiled": true, "compiled_code": "--- depends_on: \"defaultdb\".\"prepare\".\"logement_2020_valeurs\"\n\n--- Agr\u00e8ge les donn\u00e9es de la base logement par commune\n--- Colonne par colonne pour ne pas saturer la m\u00e9moire\n--- L'agr\u00e9gration est faite par univot/pivot.\n\n\n\n\n\n\n\n\n\n\n\n\nwith iris as (\n    SELECT \n      \"IRIS\" as code_iris,\n      CAST( SUM(CAST(\"IPONDL\" AS numeric)) AS INT) AS nombre_de_logements\n    FROM \n      \"defaultdb\".\"sources\".\"logement_2020\"\n    GROUP BY\n      code_iris\n  ),\n  aggregated as (\n\n    SELECT * \n\n    FROM iris\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INEEM' as TEXT) as \"champs\",\n      cast(  \n           \"INEEM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INEEM_0'  , \n        \n            'INEEM_1'  , \n        \n            'INEEM_10'  , \n        \n            'INEEM_11'  , \n        \n            'INEEM_12'  , \n        \n            'INEEM_2'  , \n        \n            'INEEM_3'  , \n        \n            'INEEM_4'  , \n        \n            'INEEM_5'  , \n        \n            'INEEM_6'  , \n        \n            'INEEM_7'  , \n        \n            'INEEM_8'  , \n        \n            'INEEM_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INEEM_0' then 'menages_avec_0_eleve_etudiant_14_ans_et_plus'\n            \n                when 'INEEM_1' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_10' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_11' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_12' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_2' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_3' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_4' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_5' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_6' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_7' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_8' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n                when 'INEEM_9' then 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_eleve_etudiant_14_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_eleve_etudiant_14_ans_et_plus\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_eleves_etudiants_14_ans_et_plus\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('TPM' as TEXT) as \"champs\",\n      cast(  \n           \"TPM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'TPM_1'  , \n        \n            'TPM_2'  , \n        \n            'TPM_Z' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'TPM_1' then 'menages_pr_travail_temps_complet'\n            \n                when 'TPM_2' then 'menages_pr_travail_temps_partiel'\n            \n                when 'TPM_Z' then 'menages_pr_travail_temps_sans_objet_sans_emploi'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_travail_temps_complet'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_travail_temps_complet\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_travail_temps_partiel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_travail_temps_partiel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_travail_temps_sans_objet_sans_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_travail_temps_sans_objet_sans_emploi\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INPOM' as TEXT) as \"champs\",\n      cast(  \n           \"INPOM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INPOM_0'  , \n        \n            'INPOM_1'  , \n        \n            'INPOM_10'  , \n        \n            'INPOM_11'  , \n        \n            'INPOM_12'  , \n        \n            'INPOM_13'  , \n        \n            'INPOM_14'  , \n        \n            'INPOM_15'  , \n        \n            'INPOM_16'  , \n        \n            'INPOM_17'  , \n        \n            'INPOM_18'  , \n        \n            'INPOM_19'  , \n        \n            'INPOM_2'  , \n        \n            'INPOM_20'  , \n        \n            'INPOM_26'  , \n        \n            'INPOM_3'  , \n        \n            'INPOM_4'  , \n        \n            'INPOM_41'  , \n        \n            'INPOM_5'  , \n        \n            'INPOM_6'  , \n        \n            'INPOM_7'  , \n        \n            'INPOM_8'  , \n        \n            'INPOM_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INPOM_0' then 'menages_avec_0_personne_active_avec_emploi'\n            \n                when 'INPOM_1' then 'menages_avec_1_personne_active_avec_emploi'\n            \n                when 'INPOM_10' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_11' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_12' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_13' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_14' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_15' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_16' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_17' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_18' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_19' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_2' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_20' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_26' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_3' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_4' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_41' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_5' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_6' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_7' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_8' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n                when 'INPOM_9' then 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_active_avec_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_active_avec_emploi\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_personne_active_avec_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_personne_active_avec_emploi\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_2_et_plus_personnes_actives_avec_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_2_et_plus_personnes_actives_avec_emploi\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('DIPLM' as TEXT) as \"champs\",\n      cast(  \n           \"DIPLM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'DIPLM_1'  , \n        \n            'DIPLM_11'  , \n        \n            'DIPLM_12'  , \n        \n            'DIPLM_13'  , \n        \n            'DIPLM_14'  , \n        \n            'DIPLM_15'  , \n        \n            'DIPLM_16'  , \n        \n            'DIPLM_17'  , \n        \n            'DIPLM_18'  , \n        \n            'DIPLM_19'  , \n        \n            'DIPLM_2'  , \n        \n            'DIPLM_3' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'DIPLM_1' then 'pr_scolarite_avant_primaire'\n            \n                when 'DIPLM_11' then 'pr_scolarite_CEP'\n            \n                when 'DIPLM_12' then 'pr_scolarite_BEPC'\n            \n                when 'DIPLM_13' then 'pr_scolarite_CAP_BEP'\n            \n                when 'DIPLM_14' then 'pr_scolarite_bac_general_techno'\n            \n                when 'DIPLM_15' then 'pr_scolarite_bar_pr'\n            \n                when 'DIPLM_16' then 'pr_scolarite_bac_plus_2'\n            \n                when 'DIPLM_17' then 'pr_scolarite_bac_plus_3_ou_4'\n            \n                when 'DIPLM_18' then 'pr_scolarite_bac_plus_5'\n            \n                when 'DIPLM_19' then 'pr_scolarite_bac_plus_8'\n            \n                when 'DIPLM_2' then 'pr_scolarite_avant_college'\n            \n                when 'DIPLM_3' then 'pr_scolarite_fin_college'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_avant_primaire'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_avant_primaire\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_CEP'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_CEP\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_BEPC'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_BEPC\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_CAP_BEP'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_CAP_BEP\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_bac_general_techno'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_bac_general_techno\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_bar_pr'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_bar_pr\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_bac_plus_2'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_bac_plus_2\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_bac_plus_3_ou_4'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_bac_plus_3_ou_4\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_bac_plus_5'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_bac_plus_5\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_bac_plus_8'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_bac_plus_8\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_avant_college'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_avant_college\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_scolarite_fin_college'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_scolarite_fin_college\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INPAM' as TEXT) as \"champs\",\n      cast(  \n           \"INPAM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INPAM_0'  , \n        \n            'INPAM_1'  , \n        \n            'INPAM_10'  , \n        \n            'INPAM_11'  , \n        \n            'INPAM_12'  , \n        \n            'INPAM_13'  , \n        \n            'INPAM_14'  , \n        \n            'INPAM_15'  , \n        \n            'INPAM_16'  , \n        \n            'INPAM_17'  , \n        \n            'INPAM_18'  , \n        \n            'INPAM_19'  , \n        \n            'INPAM_2'  , \n        \n            'INPAM_20'  , \n        \n            'INPAM_26'  , \n        \n            'INPAM_3'  , \n        \n            'INPAM_4'  , \n        \n            'INPAM_41'  , \n        \n            'INPAM_5'  , \n        \n            'INPAM_6'  , \n        \n            'INPAM_7'  , \n        \n            'INPAM_8'  , \n        \n            'INPAM_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INPAM_0' then 'menages_avec_0_personne_active'\n            \n                when 'INPAM_1' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_10' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_11' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_12' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_13' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_14' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_15' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_16' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_17' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_18' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_19' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_2' then 'menages_avec_2_et_plus_personnes_actives'\n            \n                when 'INPAM_20' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_26' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_3' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_4' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_41' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_5' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_6' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_7' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_8' then 'menages_avec_1_personne_active'\n            \n                when 'INPAM_9' then 'menages_avec_1_personne_active'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_active'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_active\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_personne_active'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_personne_active\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_2_et_plus_personnes_actives'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_2_et_plus_personnes_actives\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('EMPLM' as TEXT) as \"champs\",\n      cast(  \n           \"EMPLM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'EMPLM_11'  , \n        \n            'EMPLM_12'  , \n        \n            'EMPLM_13'  , \n        \n            'EMPLM_14'  , \n        \n            'EMPLM_15'  , \n        \n            'EMPLM_16'  , \n        \n            'EMPLM_21'  , \n        \n            'EMPLM_22'  , \n        \n            'EMPLM_23'  , \n        \n            'EMPLM_ZZ' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'EMPLM_11' then 'pr_emploi_apprentissage'\n            \n                when 'EMPLM_12' then 'pr_emploi_interim'\n            \n                when 'EMPLM_13' then 'pr_emploi_contrat_aide'\n            \n                when 'EMPLM_14' then 'pr_emploi_stage_entreprise'\n            \n                when 'EMPLM_15' then 'pr_emploi_duree_limite'\n            \n                when 'EMPLM_16' then 'pr_emploi_sans_duree_limite'\n            \n                when 'EMPLM_21' then 'pr_emploi_independant'\n            \n                when 'EMPLM_22' then 'pr_emploi_employeur'\n            \n                when 'EMPLM_23' then 'pr_emploi_aides_familiaux'\n            \n                when 'EMPLM_ZZ' then 'pr_emploi_sans_objet'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_apprentissage'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_apprentissage\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_interim'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_interim\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_contrat_aide'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_contrat_aide\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_stage_entreprise'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_stage_entreprise\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_duree_limite'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_duree_limite\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_sans_duree_limite'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_sans_duree_limite\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_independant'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_independant\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_employeur'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_employeur\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_aides_familiaux'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_aides_familiaux\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_emploi_sans_objet'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_emploi_sans_objet\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('RECHM' as TEXT) as \"champs\",\n      cast(  \n           \"RECHM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'RECHM_0'  , \n        \n            'RECHM_1'  , \n        \n            'RECHM_2'  , \n        \n            'RECHM_9'  , \n        \n            'RECHM_Z' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'RECHM_0' then 'menages_pr_pas_de_recherche_emploi'\n            \n                when 'RECHM_1' then 'menages_pr_recherche_emploi_moins_un_an'\n            \n                when 'RECHM_2' then 'menages_pr_recherche_emploi_plus_un_an'\n            \n                when 'RECHM_9' then 'menages_pr_recherche_emploi_non_declaree'\n            \n                when 'RECHM_Z' then 'menages_pr_recherche_emploi_sans_objet_en_emploi'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_pas_de_recherche_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_pas_de_recherche_emploi\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_recherche_emploi_moins_un_an'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_recherche_emploi_moins_un_an\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_recherche_emploi_plus_un_an'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_recherche_emploi_plus_un_an\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_recherche_emploi_non_declaree'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_recherche_emploi_non_declaree\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_recherche_emploi_sans_objet_en_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_recherche_emploi_sans_objet_en_emploi\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('TACTM' as TEXT) as \"champs\",\n      cast(  \n           \"TACTM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'TACTM_11'  , \n        \n            'TACTM_12'  , \n        \n            'TACTM_21'  , \n        \n            'TACTM_22'  , \n        \n            'TACTM_24'  , \n        \n            'TACTM_25' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'TACTM_11' then 'menages_pr_activite_emploi'\n            \n                when 'TACTM_12' then 'menages_pr_activite_chomeurs'\n            \n                when 'TACTM_21' then 'menages_pr_activite_retraite_pre_retraite'\n            \n                when 'TACTM_22' then 'menages_pr_activite_eleve'\n            \n                when 'TACTM_24' then 'menages_pr_activite_au_foyer'\n            \n                when 'TACTM_25' then 'menages_pr_activite_autre'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_activite_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_activite_emploi\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_activite_chomeurs'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_activite_chomeurs\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_activite_retraite_pre_retraite'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_activite_retraite_pre_retraite\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_activite_eleve'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_activite_eleve\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_activite_au_foyer'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_activite_au_foyer\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_activite_autre'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_activite_autre\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INPSM' as TEXT) as \"champs\",\n      cast(  \n           \"INPSM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INPSM_0'  , \n        \n            'INPSM_1'  , \n        \n            'INPSM_10'  , \n        \n            'INPSM_11'  , \n        \n            'INPSM_12'  , \n        \n            'INPSM_13'  , \n        \n            'INPSM_14'  , \n        \n            'INPSM_15'  , \n        \n            'INPSM_16'  , \n        \n            'INPSM_2'  , \n        \n            'INPSM_25'  , \n        \n            'INPSM_3'  , \n        \n            'INPSM_4'  , \n        \n            'INPSM_5'  , \n        \n            'INPSM_6'  , \n        \n            'INPSM_7'  , \n        \n            'INPSM_8'  , \n        \n            'INPSM_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INPSM_0' then 'menages_avec_0_personne_scolarisee'\n            \n                when 'INPSM_1' then 'menages_avec_1_personne_scolarisee'\n            \n                when 'INPSM_10' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_11' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_12' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_13' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_14' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_15' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_16' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_2' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_25' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_3' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_4' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_5' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_6' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_7' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_8' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n                when 'INPSM_9' then 'menages_avec_2_et_plus_personnes_scolarisees'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_scolarisee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_scolarisee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_personne_scolarisee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_personne_scolarisee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_2_et_plus_personnes_scolarisees'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_2_et_plus_personnes_scolarisees\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n  )\n\nSELECT \n    *  \nFROM\n    aggregated", "relation_name": "\"defaultdb\".\"prepare\".\"activite_iris\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:32:57.575623Z", "completed_at": "2024-09-23T21:33:02.425366Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:02.426643Z", "completed_at": "2024-09-23T21:33:02.426652Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 4.963927745819092, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.demographie_communes", "compiled": true, "compiled_code": "--- depends_on: \"defaultdb\".\"prepare\".\"logement_2020_valeurs\"\n\n--- Agr\u00e8ge les donn\u00e9es de la base logement par commune\n--- Colonne par colonne pour ne pas saturer la m\u00e9moire\n--- L'agr\u00e9gration est faite par univot/pivot.\n\n\n\n\n\n\n\n\n\n\n\n\nwith communes as (\n    SELECT \n      \"COMMUNE\" as code_commune_insee,\n      CAST( SUM(CAST(\"IPONDL\" AS numeric)) AS INT) AS nombre_de_logements\n    FROM \n      \"defaultdb\".\"sources\".\"logement_2020\"\n    GROUP BY\n      code_commune_insee\n  ),\n  aggregated as (\n\n    SELECT * \n\n    FROM communes\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP15M' as TEXT) as \"champs\",\n      cast(  \n           \"INP15M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP15M_0'  , \n        \n            'INP15M_1'  , \n        \n            'INP15M_10'  , \n        \n            'INP15M_11'  , \n        \n            'INP15M_12'  , \n        \n            'INP15M_13'  , \n        \n            'INP15M_14'  , \n        \n            'INP15M_15'  , \n        \n            'INP15M_2'  , \n        \n            'INP15M_3'  , \n        \n            'INP15M_4'  , \n        \n            'INP15M_5'  , \n        \n            'INP15M_6'  , \n        \n            'INP15M_7'  , \n        \n            'INP15M_8'  , \n        \n            'INP15M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INP15M_0' then 'menages_avec_0_personne_15_ans_et_moins'\n            \n                when 'INP15M_1' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_10' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_11' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_12' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_13' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_14' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_15' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_2' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_3' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_4' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_5' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_6' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_7' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_8' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_9' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_15_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_15_ans_et_moins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_15_ans_et_moins\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INPER1' as TEXT) as \"champs\",\n      cast(  \n           \"INPER1\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INPER1_0'  , \n        \n            'INPER1_1'  , \n        \n            'INPER1_10'  , \n        \n            'INPER1_11'  , \n        \n            'INPER1_12'  , \n        \n            'INPER1_13'  , \n        \n            'INPER1_14'  , \n        \n            'INPER1_15'  , \n        \n            'INPER1_16'  , \n        \n            'INPER1_17'  , \n        \n            'INPER1_18'  , \n        \n            'INPER1_19'  , \n        \n            'INPER1_2'  , \n        \n            'INPER1_20'  , \n        \n            'INPER1_22'  , \n        \n            'INPER1_26'  , \n        \n            'INPER1_3'  , \n        \n            'INPER1_38'  , \n        \n            'INPER1_4'  , \n        \n            'INPER1_5'  , \n        \n            'INPER1_6'  , \n        \n            'INPER1_7'  , \n        \n            'INPER1_8'  , \n        \n            'INPER1_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INPER1_0' then 'menages_avec_0_personne_masculin'\n            \n                when 'INPER1_1' then 'menages_avec_1_personne_masculin'\n            \n                when 'INPER1_10' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_11' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_12' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_13' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_14' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_15' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_16' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_17' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_18' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_19' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_2' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_20' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_22' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_26' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_3' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_38' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_4' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_5' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_6' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_7' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_8' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_9' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_masculin'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_masculin\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_personne_masculin'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_personne_masculin\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_2_et_plus_personnes_masculin'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_2_et_plus_personnes_masculin\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('SEXEM' as TEXT) as \"champs\",\n      cast(  \n           \"SEXEM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'SEXEM_1'  , \n        \n            'SEXEM_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'SEXEM_1' then 'menages_pr_homme'\n            \n                when 'SEXEM_2' then 'menages_pr_femmes'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_homme'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_homme\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_femmes'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_femmes\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INPER2' as TEXT) as \"champs\",\n      cast(  \n           \"INPER2\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INPER2_0'  , \n        \n            'INPER2_1'  , \n        \n            'INPER2_10'  , \n        \n            'INPER2_11'  , \n        \n            'INPER2_12'  , \n        \n            'INPER2_13'  , \n        \n            'INPER2_14'  , \n        \n            'INPER2_15'  , \n        \n            'INPER2_16'  , \n        \n            'INPER2_17'  , \n        \n            'INPER2_19'  , \n        \n            'INPER2_2'  , \n        \n            'INPER2_20'  , \n        \n            'INPER2_3'  , \n        \n            'INPER2_39'  , \n        \n            'INPER2_4'  , \n        \n            'INPER2_5'  , \n        \n            'INPER2_6'  , \n        \n            'INPER2_7'  , \n        \n            'INPER2_8'  , \n        \n            'INPER2_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INPER2_0' then 'menages_avec_0_personne_feminin'\n            \n                when 'INPER2_1' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_10' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_11' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_12' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_13' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_14' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_15' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_16' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_17' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_19' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_2' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_20' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_3' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_39' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_4' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_5' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_6' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_7' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_8' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_9' then 'menages_avec_1_personne_feminin'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_feminin'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_feminin\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_personne_feminin'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_personne_feminin\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP3M' as TEXT) as \"champs\",\n      cast(  \n           \"INP3M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP3M_0'  , \n        \n            'INP3M_1'  , \n        \n            'INP3M_2'  , \n        \n            'INP3M_3'  , \n        \n            'INP3M_4'  , \n        \n            'INP3M_5'  , \n        \n            'INP3M_6'  , \n        \n            'INP3M_7'  , \n        \n            'INP3M_8' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INP3M_0' then 'menages_avec_0_personne_3_ans_et_moins'\n            \n                when 'INP3M_1' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n                when 'INP3M_2' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n                when 'INP3M_3' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n                when 'INP3M_4' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n                when 'INP3M_5' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n                when 'INP3M_6' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n                when 'INP3M_7' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n                when 'INP3M_8' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_3_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_3_ans_et_moins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_3_ans_et_moins\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP65M' as TEXT) as \"champs\",\n      cast(  \n           \"INP65M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP65M_0'  , \n        \n            'INP65M_1'  , \n        \n            'INP65M_11'  , \n        \n            'INP65M_12'  , \n        \n            'INP65M_16'  , \n        \n            'INP65M_18'  , \n        \n            'INP65M_2'  , \n        \n            'INP65M_3'  , \n        \n            'INP65M_4'  , \n        \n            'INP65M_5'  , \n        \n            'INP65M_55'  , \n        \n            'INP65M_6'  , \n        \n            'INP65M_7'  , \n        \n            'INP65M_8'  , \n        \n            'INP65M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INP65M_0' then 'menages_avec_0_personne_65_ans_et_plus'\n            \n                when 'INP65M_1' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_11' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_12' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_16' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_18' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_2' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_3' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_4' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_5' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_55' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_6' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_7' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_8' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_9' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_65_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_65_ans_et_plus\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_65_ans_et_plus\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP11M' as TEXT) as \"champs\",\n      cast(  \n           \"INP11M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP11M_0'  , \n        \n            'INP11M_1'  , \n        \n            'INP11M_10'  , \n        \n            'INP11M_11'  , \n        \n            'INP11M_12'  , \n        \n            'INP11M_13'  , \n        \n            'INP11M_14'  , \n        \n            'INP11M_2'  , \n        \n            'INP11M_3'  , \n        \n            'INP11M_4'  , \n        \n            'INP11M_5'  , \n        \n            'INP11M_6'  , \n        \n            'INP11M_7'  , \n        \n            'INP11M_8'  , \n        \n            'INP11M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INP11M_0' then 'menages_avec_0_personne_11_ans_et_moins'\n            \n                when 'INP11M_1' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_10' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_11' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_12' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_13' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_14' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_2' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_3' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_4' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_5' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_6' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_7' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_8' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_9' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_11_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_11_ans_et_moins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_11_ans_et_moins\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INPER' as TEXT) as \"champs\",\n      cast(  \n           \"INPER\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INPER_1'  , \n        \n            'INPER_10'  , \n        \n            'INPER_11'  , \n        \n            'INPER_12'  , \n        \n            'INPER_13'  , \n        \n            'INPER_14'  , \n        \n            'INPER_15'  , \n        \n            'INPER_16'  , \n        \n            'INPER_17'  , \n        \n            'INPER_18'  , \n        \n            'INPER_19'  , \n        \n            'INPER_2'  , \n        \n            'INPER_20'  , \n        \n            'INPER_21'  , \n        \n            'INPER_22'  , \n        \n            'INPER_23'  , \n        \n            'INPER_24'  , \n        \n            'INPER_25'  , \n        \n            'INPER_26'  , \n        \n            'INPER_28'  , \n        \n            'INPER_3'  , \n        \n            'INPER_34'  , \n        \n            'INPER_4'  , \n        \n            'INPER_41'  , \n        \n            'INPER_5'  , \n        \n            'INPER_55'  , \n        \n            'INPER_6'  , \n        \n            'INPER_7'  , \n        \n            'INPER_8'  , \n        \n            'INPER_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INPER_1' then 'menages_avec_1_personne'\n            \n                when 'INPER_10' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_11' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_12' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_13' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_14' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_15' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_16' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_17' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_18' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_19' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_2' then 'menages_avec_2_personnes'\n            \n                when 'INPER_20' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_21' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_22' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_23' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_24' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_25' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_26' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_28' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_3' then 'menages_avec_3_personnes'\n            \n                when 'INPER_34' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_4' then 'menages_avec_4_personnes'\n            \n                when 'INPER_41' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_5' then 'menages_avec_5_personnes'\n            \n                when 'INPER_55' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_6' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_7' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_8' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_9' then 'menages_avec_6_et_plus_personnes'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n            \n        \n      \n        \n      \n        \n            \n        \n      \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_personne'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_personne\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_6_et_plus_personnes'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_6_et_plus_personnes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_2_personnes'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_2_personnes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_3_personnes'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_3_personnes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_4_personnes'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_4_personnes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_5_personnes'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_5_personnes\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP24M' as TEXT) as \"champs\",\n      cast(  \n           \"INP24M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP24M_0'  , \n        \n            'INP24M_1'  , \n        \n            'INP24M_10'  , \n        \n            'INP24M_11'  , \n        \n            'INP24M_12'  , \n        \n            'INP24M_13'  , \n        \n            'INP24M_14'  , \n        \n            'INP24M_15'  , \n        \n            'INP24M_16'  , \n        \n            'INP24M_17'  , \n        \n            'INP24M_18'  , \n        \n            'INP24M_19'  , \n        \n            'INP24M_2'  , \n        \n            'INP24M_20'  , \n        \n            'INP24M_21'  , \n        \n            'INP24M_25'  , \n        \n            'INP24M_3'  , \n        \n            'INP24M_4'  , \n        \n            'INP24M_5'  , \n        \n            'INP24M_6'  , \n        \n            'INP24M_7'  , \n        \n            'INP24M_8'  , \n        \n            'INP24M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INP24M_0' then 'menages_avec_0_personne_24_ans_et_moins'\n            \n                when 'INP24M_1' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_10' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_11' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_12' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_13' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_14' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_15' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_16' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_17' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_18' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_19' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_2' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_20' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_21' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_25' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_3' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_4' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_5' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_6' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_7' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_8' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_9' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_24_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_24_ans_et_moins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_24_ans_et_moins\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP60M' as TEXT) as \"champs\",\n      cast(  \n           \"INP60M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP60M_0'  , \n        \n            'INP60M_1'  , \n        \n            'INP60M_10'  , \n        \n            'INP60M_11'  , \n        \n            'INP60M_12'  , \n        \n            'INP60M_17'  , \n        \n            'INP60M_19'  , \n        \n            'INP60M_2'  , \n        \n            'INP60M_3'  , \n        \n            'INP60M_4'  , \n        \n            'INP60M_5'  , \n        \n            'INP60M_55'  , \n        \n            'INP60M_6'  , \n        \n            'INP60M_7'  , \n        \n            'INP60M_8' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INP60M_0' then 'menages_avec_0_personne_60_ans_et_plus'\n            \n                when 'INP60M_1' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_10' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_11' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_12' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_17' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_19' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_2' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_3' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_4' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_5' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_55' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_6' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_7' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_8' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_60_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_60_ans_et_plus\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_60_ans_et_plus\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP19M' as TEXT) as \"champs\",\n      cast(  \n           \"INP19M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP19M_0'  , \n        \n            'INP19M_1'  , \n        \n            'INP19M_10'  , \n        \n            'INP19M_11'  , \n        \n            'INP19M_12'  , \n        \n            'INP19M_13'  , \n        \n            'INP19M_14'  , \n        \n            'INP19M_15'  , \n        \n            'INP19M_16'  , \n        \n            'INP19M_17'  , \n        \n            'INP19M_18'  , \n        \n            'INP19M_19'  , \n        \n            'INP19M_2'  , \n        \n            'INP19M_20'  , \n        \n            'INP19M_21'  , \n        \n            'INP19M_22'  , \n        \n            'INP19M_23'  , \n        \n            'INP19M_25'  , \n        \n            'INP19M_3'  , \n        \n            'INP19M_4'  , \n        \n            'INP19M_41'  , \n        \n            'INP19M_5'  , \n        \n            'INP19M_55'  , \n        \n            'INP19M_6'  , \n        \n            'INP19M_7'  , \n        \n            'INP19M_8'  , \n        \n            'INP19M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INP19M_0' then 'menages_avec_0_personne_19_ans_et_moins'\n            \n                when 'INP19M_1' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_10' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_11' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_12' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_13' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_14' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_15' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_16' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_17' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_18' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_19' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_2' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_20' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_21' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_22' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_23' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_25' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_3' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_4' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_41' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_5' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_55' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_6' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_7' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_8' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_9' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_19_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_19_ans_et_moins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_19_ans_et_moins\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP75M' as TEXT) as \"champs\",\n      cast(  \n           \"INP75M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP75M_0'  , \n        \n            'INP75M_1'  , \n        \n            'INP75M_11'  , \n        \n            'INP75M_18'  , \n        \n            'INP75M_2'  , \n        \n            'INP75M_3'  , \n        \n            'INP75M_4'  , \n        \n            'INP75M_48'  , \n        \n            'INP75M_5'  , \n        \n            'INP75M_6'  , \n        \n            'INP75M_7'  , \n        \n            'INP75M_8'  , \n        \n            'INP75M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INP75M_0' then 'menages_avec_0_personne_75_ans_et_plus'\n            \n                when 'INP75M_1' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_11' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_18' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_2' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_3' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_4' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_48' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_5' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_6' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_7' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_8' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_9' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_75_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_75_ans_et_plus\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_75_ans_et_plus\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP17M' as TEXT) as \"champs\",\n      cast(  \n           \"INP17M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP17M_0'  , \n        \n            'INP17M_1'  , \n        \n            'INP17M_10'  , \n        \n            'INP17M_11'  , \n        \n            'INP17M_12'  , \n        \n            'INP17M_13'  , \n        \n            'INP17M_14'  , \n        \n            'INP17M_15'  , \n        \n            'INP17M_16'  , \n        \n            'INP17M_17'  , \n        \n            'INP17M_2'  , \n        \n            'INP17M_24'  , \n        \n            'INP17M_3'  , \n        \n            'INP17M_4'  , \n        \n            'INP17M_5'  , \n        \n            'INP17M_6'  , \n        \n            'INP17M_7'  , \n        \n            'INP17M_8'  , \n        \n            'INP17M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INP17M_0' then 'menages_avec_0_personne_17_ans_et_moins'\n            \n                when 'INP17M_1' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_10' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_11' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_12' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_13' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_14' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_15' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_16' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_17' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_2' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_24' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_3' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_4' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_5' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_6' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_7' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_8' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_9' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_17_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_17_ans_et_moins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_17_ans_et_moins\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('STAT_CONJM' as TEXT) as \"champs\",\n      cast(  \n           \"STAT_CONJM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'STAT_CONJM_1'  , \n        \n            'STAT_CONJM_2'  , \n        \n            'STAT_CONJM_3'  , \n        \n            'STAT_CONJM_4'  , \n        \n            'STAT_CONJM_5'  , \n        \n            'STAT_CONJM_6' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'STAT_CONJM_1' then 'menages_pr_mariee'\n            \n                when 'STAT_CONJM_2' then 'menages_pr_pacsee'\n            \n                when 'STAT_CONJM_3' then 'menages_pr_concubinage_union_libre'\n            \n                when 'STAT_CONJM_4' then 'menages_pr_veuve'\n            \n                when 'STAT_CONJM_5' then 'menages_pr_divorcee'\n            \n                when 'STAT_CONJM_6' then 'menages_pr_celibataire'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_mariee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_mariee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_pacsee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_pacsee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_concubinage_union_libre'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_concubinage_union_libre\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_veuve'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_veuve\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_divorcee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_divorcee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_celibataire'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_celibataire\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP5M' as TEXT) as \"champs\",\n      cast(  \n           \"INP5M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP5M_0'  , \n        \n            'INP5M_1'  , \n        \n            'INP5M_10'  , \n        \n            'INP5M_2'  , \n        \n            'INP5M_3'  , \n        \n            'INP5M_4'  , \n        \n            'INP5M_5'  , \n        \n            'INP5M_6'  , \n        \n            'INP5M_7'  , \n        \n            'INP5M_8'  , \n        \n            'INP5M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INP5M_0' then 'menages_avec_0_personne_5_ans_et_moins'\n            \n                when 'INP5M_1' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_10' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_2' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_3' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_4' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_5' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_6' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_7' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_8' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_9' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_5_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_5_ans_et_moins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_5_ans_et_moins\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n  ),\n  aggregated_with_infos_communes as (\n    SELECT\n      *\n    FROM\n      aggregated\n    JOIN\n\t    \"defaultdb\".\"prepare\".\"infos_communes\" as infos_communes\n    ON\n      aggregated.code_commune_insee = infos_communes.code_commune\n  )\n\nSELECT \n    *  \nFROM\n    aggregated_with_infos_communes", "relation_name": "\"defaultdb\".\"prepare\".\"demographie_communes\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:02.540985Z", "completed_at": "2024-09-23T21:33:07.332728Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:07.333976Z", "completed_at": "2024-09-23T21:33:07.333983Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 4.904361963272095, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.demographie_iris", "compiled": true, "compiled_code": "--- depends_on: \"defaultdb\".\"prepare\".\"logement_2020_valeurs\"\n\n--- Agr\u00e8ge les donn\u00e9es de la base logement par commune\n--- Colonne par colonne pour ne pas saturer la m\u00e9moire\n--- L'agr\u00e9gration est faite par univot/pivot.\n\n\n\n\n\n\n\n\n\n\n\n\nwith iris as (\n    SELECT \n      \"IRIS\" as code_iris,\n      CAST( SUM(CAST(\"IPONDL\" AS numeric)) AS INT) AS nombre_de_logements\n    FROM \n      \"defaultdb\".\"sources\".\"logement_2020\"\n    GROUP BY\n      code_iris\n  ),\n  aggregated as (\n\n    SELECT * \n\n    FROM iris\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP15M' as TEXT) as \"champs\",\n      cast(  \n           \"INP15M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP15M_0'  , \n        \n            'INP15M_1'  , \n        \n            'INP15M_10'  , \n        \n            'INP15M_11'  , \n        \n            'INP15M_12'  , \n        \n            'INP15M_13'  , \n        \n            'INP15M_14'  , \n        \n            'INP15M_15'  , \n        \n            'INP15M_2'  , \n        \n            'INP15M_3'  , \n        \n            'INP15M_4'  , \n        \n            'INP15M_5'  , \n        \n            'INP15M_6'  , \n        \n            'INP15M_7'  , \n        \n            'INP15M_8'  , \n        \n            'INP15M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INP15M_0' then 'menages_avec_0_personne_15_ans_et_moins'\n            \n                when 'INP15M_1' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_10' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_11' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_12' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_13' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_14' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_15' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_2' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_3' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_4' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_5' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_6' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_7' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_8' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n                when 'INP15M_9' then 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_15_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_15_ans_et_moins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_15_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_15_ans_et_moins\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INPER1' as TEXT) as \"champs\",\n      cast(  \n           \"INPER1\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INPER1_0'  , \n        \n            'INPER1_1'  , \n        \n            'INPER1_10'  , \n        \n            'INPER1_11'  , \n        \n            'INPER1_12'  , \n        \n            'INPER1_13'  , \n        \n            'INPER1_14'  , \n        \n            'INPER1_15'  , \n        \n            'INPER1_16'  , \n        \n            'INPER1_17'  , \n        \n            'INPER1_18'  , \n        \n            'INPER1_19'  , \n        \n            'INPER1_2'  , \n        \n            'INPER1_20'  , \n        \n            'INPER1_22'  , \n        \n            'INPER1_26'  , \n        \n            'INPER1_3'  , \n        \n            'INPER1_38'  , \n        \n            'INPER1_4'  , \n        \n            'INPER1_5'  , \n        \n            'INPER1_6'  , \n        \n            'INPER1_7'  , \n        \n            'INPER1_8'  , \n        \n            'INPER1_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INPER1_0' then 'menages_avec_0_personne_masculin'\n            \n                when 'INPER1_1' then 'menages_avec_1_personne_masculin'\n            \n                when 'INPER1_10' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_11' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_12' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_13' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_14' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_15' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_16' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_17' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_18' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_19' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_2' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_20' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_22' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_26' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_3' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_38' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_4' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_5' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_6' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_7' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_8' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n                when 'INPER1_9' then 'menages_avec_2_et_plus_personnes_masculin'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_masculin'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_masculin\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_personne_masculin'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_personne_masculin\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_2_et_plus_personnes_masculin'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_2_et_plus_personnes_masculin\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('SEXEM' as TEXT) as \"champs\",\n      cast(  \n           \"SEXEM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'SEXEM_1'  , \n        \n            'SEXEM_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'SEXEM_1' then 'menages_pr_homme'\n            \n                when 'SEXEM_2' then 'menages_pr_femmes'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_homme'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_homme\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_femmes'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_femmes\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INPER2' as TEXT) as \"champs\",\n      cast(  \n           \"INPER2\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INPER2_0'  , \n        \n            'INPER2_1'  , \n        \n            'INPER2_10'  , \n        \n            'INPER2_11'  , \n        \n            'INPER2_12'  , \n        \n            'INPER2_13'  , \n        \n            'INPER2_14'  , \n        \n            'INPER2_15'  , \n        \n            'INPER2_16'  , \n        \n            'INPER2_17'  , \n        \n            'INPER2_19'  , \n        \n            'INPER2_2'  , \n        \n            'INPER2_20'  , \n        \n            'INPER2_3'  , \n        \n            'INPER2_39'  , \n        \n            'INPER2_4'  , \n        \n            'INPER2_5'  , \n        \n            'INPER2_6'  , \n        \n            'INPER2_7'  , \n        \n            'INPER2_8'  , \n        \n            'INPER2_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INPER2_0' then 'menages_avec_0_personne_feminin'\n            \n                when 'INPER2_1' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_10' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_11' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_12' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_13' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_14' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_15' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_16' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_17' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_19' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_2' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_20' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_3' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_39' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_4' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_5' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_6' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_7' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_8' then 'menages_avec_1_personne_feminin'\n            \n                when 'INPER2_9' then 'menages_avec_1_personne_feminin'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_feminin'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_feminin\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_personne_feminin'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_personne_feminin\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP3M' as TEXT) as \"champs\",\n      cast(  \n           \"INP3M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP3M_0'  , \n        \n            'INP3M_1'  , \n        \n            'INP3M_2'  , \n        \n            'INP3M_3'  , \n        \n            'INP3M_4'  , \n        \n            'INP3M_5'  , \n        \n            'INP3M_6'  , \n        \n            'INP3M_7'  , \n        \n            'INP3M_8' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INP3M_0' then 'menages_avec_0_personne_3_ans_et_moins'\n            \n                when 'INP3M_1' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n                when 'INP3M_2' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n                when 'INP3M_3' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n                when 'INP3M_4' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n                when 'INP3M_5' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n                when 'INP3M_6' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n                when 'INP3M_7' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n                when 'INP3M_8' then 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_3_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_3_ans_et_moins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_3_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_3_ans_et_moins\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP65M' as TEXT) as \"champs\",\n      cast(  \n           \"INP65M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP65M_0'  , \n        \n            'INP65M_1'  , \n        \n            'INP65M_11'  , \n        \n            'INP65M_12'  , \n        \n            'INP65M_16'  , \n        \n            'INP65M_18'  , \n        \n            'INP65M_2'  , \n        \n            'INP65M_3'  , \n        \n            'INP65M_4'  , \n        \n            'INP65M_5'  , \n        \n            'INP65M_55'  , \n        \n            'INP65M_6'  , \n        \n            'INP65M_7'  , \n        \n            'INP65M_8'  , \n        \n            'INP65M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INP65M_0' then 'menages_avec_0_personne_65_ans_et_plus'\n            \n                when 'INP65M_1' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_11' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_12' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_16' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_18' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_2' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_3' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_4' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_5' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_55' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_6' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_7' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_8' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n                when 'INP65M_9' then 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_65_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_65_ans_et_plus\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_65_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_65_ans_et_plus\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP11M' as TEXT) as \"champs\",\n      cast(  \n           \"INP11M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP11M_0'  , \n        \n            'INP11M_1'  , \n        \n            'INP11M_10'  , \n        \n            'INP11M_11'  , \n        \n            'INP11M_12'  , \n        \n            'INP11M_13'  , \n        \n            'INP11M_14'  , \n        \n            'INP11M_2'  , \n        \n            'INP11M_3'  , \n        \n            'INP11M_4'  , \n        \n            'INP11M_5'  , \n        \n            'INP11M_6'  , \n        \n            'INP11M_7'  , \n        \n            'INP11M_8'  , \n        \n            'INP11M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INP11M_0' then 'menages_avec_0_personne_11_ans_et_moins'\n            \n                when 'INP11M_1' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_10' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_11' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_12' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_13' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_14' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_2' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_3' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_4' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_5' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_6' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_7' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_8' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n                when 'INP11M_9' then 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_11_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_11_ans_et_moins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_11_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_11_ans_et_moins\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INPER' as TEXT) as \"champs\",\n      cast(  \n           \"INPER\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INPER_1'  , \n        \n            'INPER_10'  , \n        \n            'INPER_11'  , \n        \n            'INPER_12'  , \n        \n            'INPER_13'  , \n        \n            'INPER_14'  , \n        \n            'INPER_15'  , \n        \n            'INPER_16'  , \n        \n            'INPER_17'  , \n        \n            'INPER_18'  , \n        \n            'INPER_19'  , \n        \n            'INPER_2'  , \n        \n            'INPER_20'  , \n        \n            'INPER_21'  , \n        \n            'INPER_22'  , \n        \n            'INPER_23'  , \n        \n            'INPER_24'  , \n        \n            'INPER_25'  , \n        \n            'INPER_26'  , \n        \n            'INPER_28'  , \n        \n            'INPER_3'  , \n        \n            'INPER_34'  , \n        \n            'INPER_4'  , \n        \n            'INPER_41'  , \n        \n            'INPER_5'  , \n        \n            'INPER_55'  , \n        \n            'INPER_6'  , \n        \n            'INPER_7'  , \n        \n            'INPER_8'  , \n        \n            'INPER_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INPER_1' then 'menages_avec_1_personne'\n            \n                when 'INPER_10' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_11' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_12' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_13' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_14' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_15' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_16' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_17' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_18' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_19' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_2' then 'menages_avec_2_personnes'\n            \n                when 'INPER_20' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_21' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_22' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_23' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_24' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_25' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_26' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_28' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_3' then 'menages_avec_3_personnes'\n            \n                when 'INPER_34' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_4' then 'menages_avec_4_personnes'\n            \n                when 'INPER_41' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_5' then 'menages_avec_5_personnes'\n            \n                when 'INPER_55' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_6' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_7' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_8' then 'menages_avec_6_et_plus_personnes'\n            \n                when 'INPER_9' then 'menages_avec_6_et_plus_personnes'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n            \n        \n      \n        \n      \n        \n            \n        \n      \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_personne'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_personne\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_6_et_plus_personnes'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_6_et_plus_personnes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_2_personnes'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_2_personnes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_3_personnes'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_3_personnes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_4_personnes'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_4_personnes\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_5_personnes'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_5_personnes\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP24M' as TEXT) as \"champs\",\n      cast(  \n           \"INP24M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP24M_0'  , \n        \n            'INP24M_1'  , \n        \n            'INP24M_10'  , \n        \n            'INP24M_11'  , \n        \n            'INP24M_12'  , \n        \n            'INP24M_13'  , \n        \n            'INP24M_14'  , \n        \n            'INP24M_15'  , \n        \n            'INP24M_16'  , \n        \n            'INP24M_17'  , \n        \n            'INP24M_18'  , \n        \n            'INP24M_19'  , \n        \n            'INP24M_2'  , \n        \n            'INP24M_20'  , \n        \n            'INP24M_21'  , \n        \n            'INP24M_25'  , \n        \n            'INP24M_3'  , \n        \n            'INP24M_4'  , \n        \n            'INP24M_5'  , \n        \n            'INP24M_6'  , \n        \n            'INP24M_7'  , \n        \n            'INP24M_8'  , \n        \n            'INP24M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INP24M_0' then 'menages_avec_0_personne_24_ans_et_moins'\n            \n                when 'INP24M_1' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_10' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_11' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_12' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_13' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_14' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_15' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_16' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_17' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_18' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_19' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_2' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_20' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_21' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_25' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_3' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_4' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_5' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_6' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_7' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_8' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n                when 'INP24M_9' then 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_24_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_24_ans_et_moins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_24_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_24_ans_et_moins\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP60M' as TEXT) as \"champs\",\n      cast(  \n           \"INP60M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP60M_0'  , \n        \n            'INP60M_1'  , \n        \n            'INP60M_10'  , \n        \n            'INP60M_11'  , \n        \n            'INP60M_12'  , \n        \n            'INP60M_17'  , \n        \n            'INP60M_19'  , \n        \n            'INP60M_2'  , \n        \n            'INP60M_3'  , \n        \n            'INP60M_4'  , \n        \n            'INP60M_5'  , \n        \n            'INP60M_55'  , \n        \n            'INP60M_6'  , \n        \n            'INP60M_7'  , \n        \n            'INP60M_8' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INP60M_0' then 'menages_avec_0_personne_60_ans_et_plus'\n            \n                when 'INP60M_1' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_10' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_11' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_12' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_17' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_19' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_2' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_3' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_4' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_5' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_55' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_6' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_7' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n                when 'INP60M_8' then 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_60_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_60_ans_et_plus\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_60_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_60_ans_et_plus\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP19M' as TEXT) as \"champs\",\n      cast(  \n           \"INP19M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP19M_0'  , \n        \n            'INP19M_1'  , \n        \n            'INP19M_10'  , \n        \n            'INP19M_11'  , \n        \n            'INP19M_12'  , \n        \n            'INP19M_13'  , \n        \n            'INP19M_14'  , \n        \n            'INP19M_15'  , \n        \n            'INP19M_16'  , \n        \n            'INP19M_17'  , \n        \n            'INP19M_18'  , \n        \n            'INP19M_19'  , \n        \n            'INP19M_2'  , \n        \n            'INP19M_20'  , \n        \n            'INP19M_21'  , \n        \n            'INP19M_22'  , \n        \n            'INP19M_23'  , \n        \n            'INP19M_25'  , \n        \n            'INP19M_3'  , \n        \n            'INP19M_4'  , \n        \n            'INP19M_41'  , \n        \n            'INP19M_5'  , \n        \n            'INP19M_55'  , \n        \n            'INP19M_6'  , \n        \n            'INP19M_7'  , \n        \n            'INP19M_8'  , \n        \n            'INP19M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INP19M_0' then 'menages_avec_0_personne_19_ans_et_moins'\n            \n                when 'INP19M_1' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_10' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_11' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_12' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_13' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_14' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_15' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_16' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_17' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_18' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_19' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_2' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_20' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_21' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_22' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_23' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_25' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_3' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_4' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_41' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_5' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_55' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_6' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_7' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_8' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n                when 'INP19M_9' then 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_19_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_19_ans_et_moins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_19_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_19_ans_et_moins\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP75M' as TEXT) as \"champs\",\n      cast(  \n           \"INP75M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP75M_0'  , \n        \n            'INP75M_1'  , \n        \n            'INP75M_11'  , \n        \n            'INP75M_18'  , \n        \n            'INP75M_2'  , \n        \n            'INP75M_3'  , \n        \n            'INP75M_4'  , \n        \n            'INP75M_48'  , \n        \n            'INP75M_5'  , \n        \n            'INP75M_6'  , \n        \n            'INP75M_7'  , \n        \n            'INP75M_8'  , \n        \n            'INP75M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INP75M_0' then 'menages_avec_0_personne_75_ans_et_plus'\n            \n                when 'INP75M_1' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_11' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_18' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_2' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_3' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_4' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_48' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_5' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_6' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_7' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_8' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n                when 'INP75M_9' then 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_75_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_75_ans_et_plus\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_75_ans_et_plus'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_75_ans_et_plus\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP17M' as TEXT) as \"champs\",\n      cast(  \n           \"INP17M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP17M_0'  , \n        \n            'INP17M_1'  , \n        \n            'INP17M_10'  , \n        \n            'INP17M_11'  , \n        \n            'INP17M_12'  , \n        \n            'INP17M_13'  , \n        \n            'INP17M_14'  , \n        \n            'INP17M_15'  , \n        \n            'INP17M_16'  , \n        \n            'INP17M_17'  , \n        \n            'INP17M_2'  , \n        \n            'INP17M_24'  , \n        \n            'INP17M_3'  , \n        \n            'INP17M_4'  , \n        \n            'INP17M_5'  , \n        \n            'INP17M_6'  , \n        \n            'INP17M_7'  , \n        \n            'INP17M_8'  , \n        \n            'INP17M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INP17M_0' then 'menages_avec_0_personne_17_ans_et_moins'\n            \n                when 'INP17M_1' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_10' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_11' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_12' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_13' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_14' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_15' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_16' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_17' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_2' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_24' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_3' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_4' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_5' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_6' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_7' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_8' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n                when 'INP17M_9' then 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_17_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_17_ans_et_moins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_17_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_17_ans_et_moins\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('STAT_CONJM' as TEXT) as \"champs\",\n      cast(  \n           \"STAT_CONJM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'STAT_CONJM_1'  , \n        \n            'STAT_CONJM_2'  , \n        \n            'STAT_CONJM_3'  , \n        \n            'STAT_CONJM_4'  , \n        \n            'STAT_CONJM_5'  , \n        \n            'STAT_CONJM_6' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'STAT_CONJM_1' then 'menages_pr_mariee'\n            \n                when 'STAT_CONJM_2' then 'menages_pr_pacsee'\n            \n                when 'STAT_CONJM_3' then 'menages_pr_concubinage_union_libre'\n            \n                when 'STAT_CONJM_4' then 'menages_pr_veuve'\n            \n                when 'STAT_CONJM_5' then 'menages_pr_divorcee'\n            \n                when 'STAT_CONJM_6' then 'menages_pr_celibataire'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_mariee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_mariee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_pacsee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_pacsee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_concubinage_union_libre'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_concubinage_union_libre\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_veuve'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_veuve\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_divorcee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_divorcee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_celibataire'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_celibataire\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INP5M' as TEXT) as \"champs\",\n      cast(  \n           \"INP5M\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INP5M_0'  , \n        \n            'INP5M_1'  , \n        \n            'INP5M_10'  , \n        \n            'INP5M_2'  , \n        \n            'INP5M_3'  , \n        \n            'INP5M_4'  , \n        \n            'INP5M_5'  , \n        \n            'INP5M_6'  , \n        \n            'INP5M_7'  , \n        \n            'INP5M_8'  , \n        \n            'INP5M_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INP5M_0' then 'menages_avec_0_personne_5_ans_et_moins'\n            \n                when 'INP5M_1' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_10' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_2' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_3' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_4' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_5' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_6' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_7' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_8' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n                when 'INP5M_9' then 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_0_personne_5_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_0_personne_5_ans_et_moins\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_1_et_plus_personnes_5_ans_et_moins'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_1_et_plus_personnes_5_ans_et_moins\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n  )\n\nSELECT \n    *  \nFROM\n    aggregated", "relation_name": "\"defaultdb\".\"prepare\".\"demographie_iris\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:07.446971Z", "completed_at": "2024-09-23T21:33:14.804200Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:14.805454Z", "completed_at": "2024-09-23T21:33:14.805462Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 7.468445062637329, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.habitat_communes", "compiled": true, "compiled_code": "--- depends_on: \"defaultdb\".\"prepare\".\"logement_2020_valeurs\"\n\n--- Agr\u00e8ge les donn\u00e9es de la base logement par commune\n--- Colonne par colonne pour ne pas saturer la m\u00e9moire\n--- L'agr\u00e9gration est faite par univot/pivot.\n\n\n\n\n\n\n\n\n\n\n\n\nwith communes as (\n    SELECT \n      \"COMMUNE\" as code_commune_insee,\n      CAST( SUM(CAST(\"IPONDL\" AS numeric)) AS INT) AS nombre_de_logements\n    FROM \n      \"defaultdb\".\"sources\".\"logement_2020\"\n    GROUP BY\n      code_commune_insee\n  ),\n  aggregated as (\n\n    SELECT * \n\n    FROM communes\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('AEMMR' as TEXT) as \"champs\",\n      cast(  \n           \"AEMMR\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'AEMMR_2'  , \n        \n            'AEMMR_3'  , \n        \n            'AEMMR_4'  , \n        \n            'AEMMR_5'  , \n        \n            'AEMMR_6'  , \n        \n            'AEMMR_7'  , \n        \n            'AEMMR_8'  , \n        \n            'AEMMR_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'AEMMR_2' then 'emmenagement_1900_1919'\n            \n                when 'AEMMR_3' then 'emmenagement_1920_1939'\n            \n                when 'AEMMR_4' then 'emmenagement_1940_1959'\n            \n                when 'AEMMR_5' then 'emmenagement_1940_1969'\n            \n                when 'AEMMR_6' then 'emmenagement_1970_1979'\n            \n                when 'AEMMR_7' then 'emmenagement_1980_1989'\n            \n                when 'AEMMR_8' then 'emmenagement_1990_1999'\n            \n                when 'AEMMR_9' then 'emmenagement_apres_1999'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_1900_1919'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_1900_1919\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_1920_1939'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_1920_1939\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_1940_1959'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_1940_1959\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_1940_1969'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_1940_1969\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_1970_1979'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_1970_1979\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_1980_1989'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_1980_1989\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_1990_1999'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_1990_1999\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_apres_1999'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_apres_1999\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('ACHL' as TEXT) as \"champs\",\n      cast(  \n           \"ACHL\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'ACHL_A11'  , \n        \n            'ACHL_A12'  , \n        \n            'ACHL_B11'  , \n        \n            'ACHL_B12'  , \n        \n            'ACHL_C100'  , \n        \n            'ACHL_C106'  , \n        \n            'ACHL_C107'  , \n        \n            'ACHL_C108'  , \n        \n            'ACHL_C109'  , \n        \n            'ACHL_C110'  , \n        \n            'ACHL_C111'  , \n        \n            'ACHL_C112'  , \n        \n            'ACHL_C113'  , \n        \n            'ACHL_C114'  , \n        \n            'ACHL_C115'  , \n        \n            'ACHL_C116'  , \n        \n            'ACHL_C117'  , \n        \n            'ACHL_C2018'  , \n        \n            'ACHL_C2019'  , \n        \n            'ACHL_C2020'  , \n        \n            'ACHL_C2021'  , \n        \n            'ACHL_C2022' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'ACHL_A11' then 'construction_avant_1919'\n            \n                when 'ACHL_A12' then 'construction_1919_1945'\n            \n                when 'ACHL_B11' then 'construction_1916_1970'\n            \n                when 'ACHL_B12' then 'construction_1971_1990'\n            \n                when 'ACHL_C100' then 'construction_1991_2025'\n            \n                when 'ACHL_C106' then 'construction_2006'\n            \n                when 'ACHL_C107' then 'construction_2007'\n            \n                when 'ACHL_C108' then 'construction_2008'\n            \n                when 'ACHL_C109' then 'construction_2009'\n            \n                when 'ACHL_C110' then 'construction_2010'\n            \n                when 'ACHL_C111' then 'construction_2011'\n            \n                when 'ACHL_C112' then 'construction_2012'\n            \n                when 'ACHL_C113' then 'construction_2013'\n            \n                when 'ACHL_C114' then 'construction_2014'\n            \n                when 'ACHL_C115' then 'construction_2015'\n            \n                when 'ACHL_C116' then 'construction_2016'\n            \n                when 'ACHL_C117' then 'construction_2017'\n            \n                when 'ACHL_C2018' then 'construction_2018'\n            \n                when 'ACHL_C2019' then 'construction_2019'\n            \n                when 'ACHL_C2020' then 'construction_2020'\n            \n                when 'ACHL_C2021' then 'construction_2021'\n            \n                when 'ACHL_C2022' then 'construction_2022'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_avant_1919'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_avant_1919\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_1919_1945'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_1919_1945\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_1916_1970'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_1916_1970\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_1971_1990'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_1971_1990\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_1991_2025'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_1991_2025\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2006'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2006\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2007'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2007\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2008'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2008\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2009'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2009\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2010'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2010\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2011'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2011\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2012'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2012\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2013'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2013\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2014'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2014\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2015'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2015\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2016'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2016\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2017'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2017\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2018'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2018\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2019'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2019\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2020'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2020\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2021'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2021\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2022'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2022\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('STOCD' as TEXT) as \"champs\",\n      cast(  \n           \"STOCD\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'STOCD_10'  , \n        \n            'STOCD_21'  , \n        \n            'STOCD_22'  , \n        \n            'STOCD_23'  , \n        \n            'STOCD_30' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'STOCD_10' then 'logements_occupes_par_proprietaires'\n            \n                when 'STOCD_21' then 'logements_occupes_par_locataire_sous_locataire_vide_non_hlm'\n            \n                when 'STOCD_22' then 'logements_occupes_par_locataire_sous_locataire_vide_hlm'\n            \n                when 'STOCD_23' then 'logements_occupes_par_locataire_meuble_hotel'\n            \n                when 'STOCD_30' then 'logements_occupes_par_loge_gratuitemenent'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_occupes_par_proprietaires'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_occupes_par_proprietaires\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_occupes_par_locataire_sous_locataire_vide_non_hlm'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_occupes_par_locataire_sous_locataire_vide_non_hlm\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_occupes_par_locataire_sous_locataire_vide_hlm'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_occupes_par_locataire_sous_locataire_vide_hlm\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_occupes_par_locataire_meuble_hotel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_occupes_par_locataire_meuble_hotel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_occupes_par_loge_gratuitemenent'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_occupes_par_loge_gratuitemenent\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('AGEMEN8' as TEXT) as \"champs\",\n      cast(  \n           \"AGEMEN8\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'AGEMEN8_0'  , \n        \n            'AGEMEN8_15'  , \n        \n            'AGEMEN8_20'  , \n        \n            'AGEMEN8_25'  , \n        \n            'AGEMEN8_40'  , \n        \n            'AGEMEN8_55'  , \n        \n            'AGEMEN8_65'  , \n        \n            'AGEMEN8_80' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'AGEMEN8_0' then 'pr_moins_15'\n            \n                when 'AGEMEN8_15' then 'pr_15_19'\n            \n                when 'AGEMEN8_20' then 'pr_20_24'\n            \n                when 'AGEMEN8_25' then 'pr_25_39'\n            \n                when 'AGEMEN8_40' then 'pr_40_54'\n            \n                when 'AGEMEN8_55' then 'pr_55_64'\n            \n                when 'AGEMEN8_65' then 'pr_64_79'\n            \n                when 'AGEMEN8_80' then 'pr_plus_80'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_moins_15'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_moins_15\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_15_19'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_15_19\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_20_24'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_20_24\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_25_39'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_25_39\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_40_54'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_40_54\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_55_64'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_55_64\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_64_79'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_64_79\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_plus_80'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_plus_80\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('TYPC' as TEXT) as \"champs\",\n      cast(  \n           \"TYPC\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'TYPC_1'  , \n        \n            'TYPC_2'  , \n        \n            'TYPC_3'  , \n        \n            'TYPC_4'  , \n        \n            'TYPC_5' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'TYPC_1' then 'logement_type_contruction_un_logement_isole'\n            \n                when 'TYPC_2' then 'logement_type_contruction_un_logement_groupe'\n            \n                when 'TYPC_3' then 'logement_type_contruction_plusieurs_logements'\n            \n                when 'TYPC_4' then 'logement_type_contruction_autre_logement'\n            \n                when 'TYPC_5' then 'logement_type_construction_provisoire'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_contruction_un_logement_isole'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_contruction_un_logement_isole\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_contruction_un_logement_groupe'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_contruction_un_logement_groupe\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_contruction_plusieurs_logements'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_contruction_plusieurs_logements\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_contruction_autre_logement'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_contruction_autre_logement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_construction_provisoire'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_construction_provisoire\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('CMBL' as TEXT) as \"champs\",\n      cast(  \n           \"CMBL\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'CMBL_1'  , \n        \n            'CMBL_2'  , \n        \n            'CMBL_3'  , \n        \n            'CMBL_4'  , \n        \n            'CMBL_5'  , \n        \n            'CMBL_6' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'CMBL_1' then 'metro__combustible_chauffage_urbain'\n            \n                when 'CMBL_2' then 'metro__combustible_gaz_de_ville_ou_reseau'\n            \n                when 'CMBL_3' then 'metro__combustible_fioul'\n            \n                when 'CMBL_4' then 'metro__combustible_electricte'\n            \n                when 'CMBL_5' then 'metro__combustible_gaz_bouteille_ou_citerne'\n            \n                when 'CMBL_6' then 'metro__combustible_autre'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__combustible_chauffage_urbain'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__combustible_chauffage_urbain\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__combustible_gaz_de_ville_ou_reseau'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__combustible_gaz_de_ville_ou_reseau\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__combustible_fioul'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__combustible_fioul\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__combustible_electricte'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__combustible_electricte\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__combustible_gaz_bouteille_ou_citerne'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__combustible_gaz_bouteille_ou_citerne\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__combustible_autre'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__combustible_autre\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('CLIM' as TEXT) as \"champs\",\n      cast(  \n           \"CLIM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'CLIM_1'  , \n        \n            'CLIM_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'CLIM_1' then 'dom__avec_piece_climatisee'\n            \n                when 'CLIM_2' then 'dom__sans_piece_climatisee'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__avec_piece_climatisee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__avec_piece_climatisee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__sans_piece_climatisee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__sans_piece_climatisee\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('ANEMR' as TEXT) as \"champs\",\n      cast(  \n           \"ANEMR\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'ANEMR_0'  , \n        \n            'ANEMR_1'  , \n        \n            'ANEMR_2'  , \n        \n            'ANEMR_3'  , \n        \n            'ANEMR_4'  , \n        \n            'ANEMR_5'  , \n        \n            'ANEMR_6'  , \n        \n            'ANEMR_7'  , \n        \n            'ANEMR_8'  , \n        \n            'ANEMR_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'ANEMR_0' then 'emmenagement_moins_2_ans'\n            \n                when 'ANEMR_1' then 'emmenagement_2_4_ans'\n            \n                when 'ANEMR_2' then 'emmenagement_5_9_ans'\n            \n                when 'ANEMR_3' then 'emmenagement_10_19_ans'\n            \n                when 'ANEMR_4' then 'emmenagement_20_29_ans'\n            \n                when 'ANEMR_5' then 'emmenagement_30_39_ans'\n            \n                when 'ANEMR_6' then 'emmenagement_40_49_ans'\n            \n                when 'ANEMR_7' then 'emmenagement_50_59_ans'\n            \n                when 'ANEMR_8' then 'emmenagement_60_69_ans'\n            \n                when 'ANEMR_9' then 'emmenagement_plus_70_ans'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_moins_2_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_moins_2_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_2_4_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_2_4_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_5_9_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_5_9_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_10_19_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_10_19_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_20_29_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_20_29_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_30_39_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_30_39_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_40_49_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_40_49_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_50_59_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_50_59_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_60_69_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_60_69_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_plus_70_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_plus_70_ans\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('EGOUL' as TEXT) as \"champs\",\n      cast(  \n           \"EGOUL\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'EGOUL_1'  , \n        \n            'EGOUL_2'  , \n        \n            'EGOUL_3'  , \n        \n            'EGOUL_4' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'EGOUL_1' then 'dom__raccordement_egouts'\n            \n                when 'EGOUL_2' then 'dom__raccordement_fosse_septique'\n            \n                when 'EGOUL_3' then 'dom__raccordement_puisard'\n            \n                when 'EGOUL_4' then 'dom__evacuation_sol'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__raccordement_egouts'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__raccordement_egouts\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__raccordement_fosse_septique'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__raccordement_fosse_septique\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__raccordement_puisard'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__raccordement_puisard\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__evacuation_sol'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__evacuation_sol\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('GARL' as TEXT) as \"champs\",\n      cast(  \n           \"GARL\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'GARL_1'  , \n        \n            'GARL_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'GARL_1' then 'avec_emplacement_stationnement'\n            \n                when 'GARL_2' then 'sans_emplacement_stationnement'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'avec_emplacement_stationnement'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"avec_emplacement_stationnement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'sans_emplacement_stationnement'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"sans_emplacement_stationnement\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('CUIS' as TEXT) as \"champs\",\n      cast(  \n           \"CUIS\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'CUIS_1'  , \n        \n            'CUIS_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'CUIS_1' then 'dom__avec_cuisine_interieure_evier'\n            \n                when 'CUIS_2' then 'dom__sans_cuisine_interieure_evier'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__avec_cuisine_interieure_evier'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__avec_cuisine_interieure_evier\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__sans_cuisine_interieure_evier'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__sans_cuisine_interieure_evier\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('NBPI' as TEXT) as \"champs\",\n      cast(  \n           \"NBPI\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'NBPI_1'  , \n        \n            'NBPI_10'  , \n        \n            'NBPI_11'  , \n        \n            'NBPI_12'  , \n        \n            'NBPI_13'  , \n        \n            'NBPI_14'  , \n        \n            'NBPI_15'  , \n        \n            'NBPI_16'  , \n        \n            'NBPI_17'  , \n        \n            'NBPI_18'  , \n        \n            'NBPI_19'  , \n        \n            'NBPI_2'  , \n        \n            'NBPI_20'  , \n        \n            'NBPI_3'  , \n        \n            'NBPI_4'  , \n        \n            'NBPI_5'  , \n        \n            'NBPI_6'  , \n        \n            'NBPI_7'  , \n        \n            'NBPI_8'  , \n        \n            'NBPI_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'NBPI_1' then 'logements_avec_1_piece'\n            \n                when 'NBPI_10' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_11' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_12' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_13' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_14' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_15' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_16' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_17' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_18' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_19' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_2' then 'logements_avec_2_pieces'\n            \n                when 'NBPI_20' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_3' then 'logements_avec_3_pieces'\n            \n                when 'NBPI_4' then 'logements_avec_4_pieces'\n            \n                when 'NBPI_5' then 'logements_avec_5_pieces'\n            \n                when 'NBPI_6' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_7' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_8' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_9' then 'logements_avec_6_et_plus_pieces'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n            \n        \n      \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_avec_1_piece'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_avec_1_piece\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_avec_6_et_plus_pieces'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_avec_6_et_plus_pieces\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_avec_2_pieces'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_avec_2_pieces\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_avec_3_pieces'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_avec_3_pieces\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_avec_4_pieces'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_avec_4_pieces\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_avec_5_pieces'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_avec_5_pieces\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('SURF' as TEXT) as \"champs\",\n      cast(  \n           \"SURF\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'SURF_1'  , \n        \n            'SURF_2'  , \n        \n            'SURF_3'  , \n        \n            'SURF_4'  , \n        \n            'SURF_5'  , \n        \n            'SURF_6'  , \n        \n            'SURF_7' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'SURF_1' then 'logements_moins_30_mc'\n            \n                when 'SURF_2' then 'logements_30_40_mc'\n            \n                when 'SURF_3' then 'logements_40_60_mc'\n            \n                when 'SURF_4' then 'logements_60_80_mc'\n            \n                when 'SURF_5' then 'logements_80_100_mc'\n            \n                when 'SURF_6' then 'logements_100_120_mc'\n            \n                when 'SURF_7' then 'logements_plus_120_mc'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_moins_30_mc'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_moins_30_mc\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_30_40_mc'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_30_40_mc\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_40_60_mc'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_40_60_mc\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_60_80_mc'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_60_80_mc\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_80_100_mc'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_80_100_mc\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_100_120_mc'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_100_120_mc\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_plus_120_mc'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_plus_120_mc\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('SANIDOM' as TEXT) as \"champs\",\n      cast(  \n           \"SANIDOM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'SANIDOM_11'  , \n        \n            'SANIDOM_12'  , \n        \n            'SANIDOM_21'  , \n        \n            'SANIDOM_22' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'SANIDOM_11' then 'dom__logement_avec_baignoire_ou_douche_avec_toilettes_interieures'\n            \n                when 'SANIDOM_12' then 'dom__logement_avec_baignoire_ou_douche_sans_toilettes_interieures'\n            \n                when 'SANIDOM_21' then 'dom__logement_ni_baignoire_ni_douche_avec_toilettes_interieures'\n            \n                when 'SANIDOM_22' then 'dom__logement_ni_baignoire_ni_douche'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__logement_avec_baignoire_ou_douche_avec_toilettes_interieures'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__logement_avec_baignoire_ou_douche_avec_toilettes_interieures\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__logement_avec_baignoire_ou_douche_sans_toilettes_interieures'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__logement_avec_baignoire_ou_douche_sans_toilettes_interieures\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__logement_ni_baignoire_ni_douche_avec_toilettes_interieures'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__logement_ni_baignoire_ni_douche_avec_toilettes_interieures\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__logement_ni_baignoire_ni_douche'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__logement_ni_baignoire_ni_douche\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('BATI' as TEXT) as \"champs\",\n      cast(  \n           \"BATI\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'BATI_1'  , \n        \n            'BATI_2'  , \n        \n            'BATI_3'  , \n        \n            'BATI_4' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'BATI_1' then 'dom__habitation_de_fortune'\n            \n                when 'BATI_2' then 'dom__cases_traditionnelles'\n            \n                when 'BATI_3' then 'dom__habitation_en_bois'\n            \n                when 'BATI_4' then 'dom__habitation_en_dur'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__habitation_de_fortune'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__habitation_de_fortune\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__cases_traditionnelles'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__cases_traditionnelles\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__habitation_en_bois'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__habitation_en_bois\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__habitation_en_dur'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__habitation_en_dur\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('CHAU' as TEXT) as \"champs\",\n      cast(  \n           \"CHAU\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'CHAU_1'  , \n        \n            'CHAU_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'CHAU_1' then 'dom__presence_chauffage'\n            \n                when 'CHAU_2' then 'dom__abscence_chauffage'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__presence_chauffage'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__presence_chauffage\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__abscence_chauffage'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__abscence_chauffage\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('CHOS' as TEXT) as \"champs\",\n      cast(  \n           \"CHOS\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'CHOS_1'  , \n        \n            'CHOS_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'CHOS_1' then 'dom__presence_chauffe_eau_solaire'\n            \n                when 'CHOS_2' then 'dom__abscence_chauffe_eau_solaire'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__presence_chauffe_eau_solaire'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__presence_chauffe_eau_solaire\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__abscence_chauffe_eau_solaire'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__abscence_chauffe_eau_solaire\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('HLML' as TEXT) as \"champs\",\n      cast(  \n           \"HLML\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'HLML_1'  , \n        \n            'HLML_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'HLML_1' then 'appartient_hlm'\n            \n                when 'HLML_2' then 'appartient_pas_hlm'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'appartient_hlm'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"appartient_hlm\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'appartient_pas_hlm'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"appartient_pas_hlm\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('TYPL' as TEXT) as \"champs\",\n      cast(  \n           \"TYPL\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'TYPL_1'  , \n        \n            'TYPL_2'  , \n        \n            'TYPL_3'  , \n        \n            'TYPL_4'  , \n        \n            'TYPL_5'  , \n        \n            'TYPL_6' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'TYPL_1' then 'logement_type_maison'\n            \n                when 'TYPL_2' then 'logement_type_appartement'\n            \n                when 'TYPL_3' then 'logement_type_appartement_foyer'\n            \n                when 'TYPL_4' then 'logement_type_chambre_hotel'\n            \n                when 'TYPL_5' then 'logement_type_habitation_fortune'\n            \n                when 'TYPL_6' then 'logement_type_piece_independante'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_maison'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_maison\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_appartement'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_appartement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_appartement_foyer'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_appartement_foyer\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_chambre_hotel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_chambre_hotel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_habitation_fortune'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_habitation_fortune\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_piece_independante'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_piece_independante\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('WC' as TEXT) as \"champs\",\n      cast(  \n           \"WC\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'WC_1'  , \n        \n            'WC_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'WC_1' then 'dom__logements_avec_wc_interieurs'\n            \n                when 'WC_2' then 'dom__logements_sans_wc_interieurs'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__logements_avec_wc_interieurs'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__logements_avec_wc_interieurs\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__logements_sans_wc_interieurs'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__logements_sans_wc_interieurs\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('SANI' as TEXT) as \"champs\",\n      cast(  \n           \"SANI\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'SANI_0'  , \n        \n            'SANI_1'  , \n        \n            'SANI_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'SANI_0' then 'metro__logement_ni_baignoire_ni_douche'\n            \n                when 'SANI_1' then 'metro__logement_avec_baignoire_ou_douche_hors_piece_reservee'\n            \n                when 'SANI_2' then 'metro__logement_salle_de_bain'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__logement_ni_baignoire_ni_douche'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__logement_ni_baignoire_ni_douche\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__logement_avec_baignoire_ou_douche_hors_piece_reservee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__logement_avec_baignoire_ou_douche_hors_piece_reservee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__logement_salle_de_bain'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__logement_salle_de_bain\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('BAIN' as TEXT) as \"champs\",\n      cast(  \n           \"BAIN\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'BAIN_1'  , \n        \n            'BAIN_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'BAIN_1' then 'dom__beignoire_ou_douche'\n            \n                when 'BAIN_2' then 'dom__ni_beignoire_ni_douche'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__beignoire_ou_douche'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__beignoire_ou_douche\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__ni_beignoire_ni_douche'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__ni_beignoire_ni_douche\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('ASCEN' as TEXT) as \"champs\",\n      cast(  \n           \"ASCEN\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'ASCEN_1'  , \n        \n            'ASCEN_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'ASCEN_1' then 'avec_ascensseur'\n            \n                when 'ASCEN_2' then 'sans_ascensseur'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'avec_ascensseur'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"avec_ascensseur\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'sans_ascensseur'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"sans_ascensseur\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('CATL' as TEXT) as \"champs\",\n      cast(  \n           \"CATL\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'CATL_1'  , \n        \n            'CATL_2'  , \n        \n            'CATL_3'  , \n        \n            'CATL_4' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'CATL_1' then 'residence_principale'\n            \n                when 'CATL_2' then 'logement_occasionnel'\n            \n                when 'CATL_3' then 'residence_secondaire'\n            \n                when 'CATL_4' then 'logement_vacant'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'residence_principale'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_occasionnel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_occasionnel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'residence_secondaire'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_secondaire\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_vacant'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_vacant\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('ELEC' as TEXT) as \"champs\",\n      cast(  \n           \"ELEC\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'ELEC_1'  , \n        \n            'ELEC_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'ELEC_1' then 'dom__avec_electricite'\n            \n                when 'ELEC_2' then 'dom__sans_electricite'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__avec_electricite'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__avec_electricite\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__sans_electricite'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__sans_electricite\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('EAU' as TEXT) as \"champs\",\n      cast(  \n           \"EAU\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'EAU_1'  , \n        \n            'EAU_2'  , \n        \n            'EAU_3' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'EAU_1' then 'dom__eau_froide_seulement'\n            \n                when 'EAU_2' then 'dom__eau_froide_et_chaude'\n            \n                when 'EAU_3' then 'dom__aucun_point_eau'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__eau_froide_seulement'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__eau_froide_seulement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__eau_froide_et_chaude'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__eau_froide_et_chaude\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__aucun_point_eau'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__aucun_point_eau\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n  ),\n  aggregated_with_infos_communes as (\n    SELECT\n      *\n    FROM\n      aggregated\n    JOIN\n\t    \"defaultdb\".\"prepare\".\"infos_communes\" as infos_communes\n    ON\n      aggregated.code_commune_insee = infos_communes.code_commune\n  )\n\nSELECT \n    *  \nFROM\n    aggregated_with_infos_communes", "relation_name": "\"defaultdb\".\"prepare\".\"habitat_communes\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:14.916813Z", "completed_at": "2024-09-23T21:33:22.329538Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:22.330789Z", "completed_at": "2024-09-23T21:33:22.330798Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 7.525595664978027, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.habitat_iris", "compiled": true, "compiled_code": "--- depends_on: \"defaultdb\".\"prepare\".\"logement_2020_valeurs\"\n\n--- Agr\u00e8ge les donn\u00e9es de la base logement par commune\n--- Colonne par colonne pour ne pas saturer la m\u00e9moire\n--- L'agr\u00e9gration est faite par univot/pivot.\n\n\n\n\n\n\n\n\n\n\n\n\nwith iris as (\n    SELECT \n      \"IRIS\" as code_iris,\n      CAST( SUM(CAST(\"IPONDL\" AS numeric)) AS INT) AS nombre_de_logements\n    FROM \n      \"defaultdb\".\"sources\".\"logement_2020\"\n    GROUP BY\n      code_iris\n  ),\n  aggregated as (\n\n    SELECT * \n\n    FROM iris\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('AEMMR' as TEXT) as \"champs\",\n      cast(  \n           \"AEMMR\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'AEMMR_2'  , \n        \n            'AEMMR_3'  , \n        \n            'AEMMR_4'  , \n        \n            'AEMMR_5'  , \n        \n            'AEMMR_6'  , \n        \n            'AEMMR_7'  , \n        \n            'AEMMR_8'  , \n        \n            'AEMMR_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'AEMMR_2' then 'emmenagement_1900_1919'\n            \n                when 'AEMMR_3' then 'emmenagement_1920_1939'\n            \n                when 'AEMMR_4' then 'emmenagement_1940_1959'\n            \n                when 'AEMMR_5' then 'emmenagement_1940_1969'\n            \n                when 'AEMMR_6' then 'emmenagement_1970_1979'\n            \n                when 'AEMMR_7' then 'emmenagement_1980_1989'\n            \n                when 'AEMMR_8' then 'emmenagement_1990_1999'\n            \n                when 'AEMMR_9' then 'emmenagement_apres_1999'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_1900_1919'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_1900_1919\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_1920_1939'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_1920_1939\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_1940_1959'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_1940_1959\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_1940_1969'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_1940_1969\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_1970_1979'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_1970_1979\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_1980_1989'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_1980_1989\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_1990_1999'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_1990_1999\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_apres_1999'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_apres_1999\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('ACHL' as TEXT) as \"champs\",\n      cast(  \n           \"ACHL\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'ACHL_A11'  , \n        \n            'ACHL_A12'  , \n        \n            'ACHL_B11'  , \n        \n            'ACHL_B12'  , \n        \n            'ACHL_C100'  , \n        \n            'ACHL_C106'  , \n        \n            'ACHL_C107'  , \n        \n            'ACHL_C108'  , \n        \n            'ACHL_C109'  , \n        \n            'ACHL_C110'  , \n        \n            'ACHL_C111'  , \n        \n            'ACHL_C112'  , \n        \n            'ACHL_C113'  , \n        \n            'ACHL_C114'  , \n        \n            'ACHL_C115'  , \n        \n            'ACHL_C116'  , \n        \n            'ACHL_C117'  , \n        \n            'ACHL_C2018'  , \n        \n            'ACHL_C2019'  , \n        \n            'ACHL_C2020'  , \n        \n            'ACHL_C2021'  , \n        \n            'ACHL_C2022' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'ACHL_A11' then 'construction_avant_1919'\n            \n                when 'ACHL_A12' then 'construction_1919_1945'\n            \n                when 'ACHL_B11' then 'construction_1916_1970'\n            \n                when 'ACHL_B12' then 'construction_1971_1990'\n            \n                when 'ACHL_C100' then 'construction_1991_2025'\n            \n                when 'ACHL_C106' then 'construction_2006'\n            \n                when 'ACHL_C107' then 'construction_2007'\n            \n                when 'ACHL_C108' then 'construction_2008'\n            \n                when 'ACHL_C109' then 'construction_2009'\n            \n                when 'ACHL_C110' then 'construction_2010'\n            \n                when 'ACHL_C111' then 'construction_2011'\n            \n                when 'ACHL_C112' then 'construction_2012'\n            \n                when 'ACHL_C113' then 'construction_2013'\n            \n                when 'ACHL_C114' then 'construction_2014'\n            \n                when 'ACHL_C115' then 'construction_2015'\n            \n                when 'ACHL_C116' then 'construction_2016'\n            \n                when 'ACHL_C117' then 'construction_2017'\n            \n                when 'ACHL_C2018' then 'construction_2018'\n            \n                when 'ACHL_C2019' then 'construction_2019'\n            \n                when 'ACHL_C2020' then 'construction_2020'\n            \n                when 'ACHL_C2021' then 'construction_2021'\n            \n                when 'ACHL_C2022' then 'construction_2022'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_avant_1919'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_avant_1919\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_1919_1945'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_1919_1945\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_1916_1970'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_1916_1970\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_1971_1990'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_1971_1990\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_1991_2025'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_1991_2025\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2006'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2006\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2007'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2007\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2008'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2008\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2009'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2009\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2010'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2010\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2011'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2011\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2012'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2012\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2013'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2013\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2014'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2014\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2015'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2015\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2016'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2016\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2017'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2017\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2018'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2018\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2019'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2019\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2020'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2020\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2021'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2021\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'construction_2022'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"construction_2022\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('STOCD' as TEXT) as \"champs\",\n      cast(  \n           \"STOCD\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'STOCD_10'  , \n        \n            'STOCD_21'  , \n        \n            'STOCD_22'  , \n        \n            'STOCD_23'  , \n        \n            'STOCD_30' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'STOCD_10' then 'logements_occupes_par_proprietaires'\n            \n                when 'STOCD_21' then 'logements_occupes_par_locataire_sous_locataire_vide_non_hlm'\n            \n                when 'STOCD_22' then 'logements_occupes_par_locataire_sous_locataire_vide_hlm'\n            \n                when 'STOCD_23' then 'logements_occupes_par_locataire_meuble_hotel'\n            \n                when 'STOCD_30' then 'logements_occupes_par_loge_gratuitemenent'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_occupes_par_proprietaires'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_occupes_par_proprietaires\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_occupes_par_locataire_sous_locataire_vide_non_hlm'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_occupes_par_locataire_sous_locataire_vide_non_hlm\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_occupes_par_locataire_sous_locataire_vide_hlm'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_occupes_par_locataire_sous_locataire_vide_hlm\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_occupes_par_locataire_meuble_hotel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_occupes_par_locataire_meuble_hotel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_occupes_par_loge_gratuitemenent'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_occupes_par_loge_gratuitemenent\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('AGEMEN8' as TEXT) as \"champs\",\n      cast(  \n           \"AGEMEN8\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'AGEMEN8_0'  , \n        \n            'AGEMEN8_15'  , \n        \n            'AGEMEN8_20'  , \n        \n            'AGEMEN8_25'  , \n        \n            'AGEMEN8_40'  , \n        \n            'AGEMEN8_55'  , \n        \n            'AGEMEN8_65'  , \n        \n            'AGEMEN8_80' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'AGEMEN8_0' then 'pr_moins_15'\n            \n                when 'AGEMEN8_15' then 'pr_15_19'\n            \n                when 'AGEMEN8_20' then 'pr_20_24'\n            \n                when 'AGEMEN8_25' then 'pr_25_39'\n            \n                when 'AGEMEN8_40' then 'pr_40_54'\n            \n                when 'AGEMEN8_55' then 'pr_55_64'\n            \n                when 'AGEMEN8_65' then 'pr_64_79'\n            \n                when 'AGEMEN8_80' then 'pr_plus_80'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_moins_15'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_moins_15\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_15_19'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_15_19\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_20_24'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_20_24\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_25_39'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_25_39\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_40_54'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_40_54\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_55_64'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_55_64\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_64_79'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_64_79\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_plus_80'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_plus_80\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('TYPC' as TEXT) as \"champs\",\n      cast(  \n           \"TYPC\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'TYPC_1'  , \n        \n            'TYPC_2'  , \n        \n            'TYPC_3'  , \n        \n            'TYPC_4'  , \n        \n            'TYPC_5' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'TYPC_1' then 'logement_type_contruction_un_logement_isole'\n            \n                when 'TYPC_2' then 'logement_type_contruction_un_logement_groupe'\n            \n                when 'TYPC_3' then 'logement_type_contruction_plusieurs_logements'\n            \n                when 'TYPC_4' then 'logement_type_contruction_autre_logement'\n            \n                when 'TYPC_5' then 'logement_type_construction_provisoire'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_contruction_un_logement_isole'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_contruction_un_logement_isole\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_contruction_un_logement_groupe'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_contruction_un_logement_groupe\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_contruction_plusieurs_logements'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_contruction_plusieurs_logements\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_contruction_autre_logement'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_contruction_autre_logement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_construction_provisoire'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_construction_provisoire\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('CMBL' as TEXT) as \"champs\",\n      cast(  \n           \"CMBL\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'CMBL_1'  , \n        \n            'CMBL_2'  , \n        \n            'CMBL_3'  , \n        \n            'CMBL_4'  , \n        \n            'CMBL_5'  , \n        \n            'CMBL_6' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'CMBL_1' then 'metro__combustible_chauffage_urbain'\n            \n                when 'CMBL_2' then 'metro__combustible_gaz_de_ville_ou_reseau'\n            \n                when 'CMBL_3' then 'metro__combustible_fioul'\n            \n                when 'CMBL_4' then 'metro__combustible_electricte'\n            \n                when 'CMBL_5' then 'metro__combustible_gaz_bouteille_ou_citerne'\n            \n                when 'CMBL_6' then 'metro__combustible_autre'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__combustible_chauffage_urbain'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__combustible_chauffage_urbain\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__combustible_gaz_de_ville_ou_reseau'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__combustible_gaz_de_ville_ou_reseau\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__combustible_fioul'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__combustible_fioul\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__combustible_electricte'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__combustible_electricte\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__combustible_gaz_bouteille_ou_citerne'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__combustible_gaz_bouteille_ou_citerne\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__combustible_autre'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__combustible_autre\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('CLIM' as TEXT) as \"champs\",\n      cast(  \n           \"CLIM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'CLIM_1'  , \n        \n            'CLIM_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'CLIM_1' then 'dom__avec_piece_climatisee'\n            \n                when 'CLIM_2' then 'dom__sans_piece_climatisee'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__avec_piece_climatisee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__avec_piece_climatisee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__sans_piece_climatisee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__sans_piece_climatisee\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('ANEMR' as TEXT) as \"champs\",\n      cast(  \n           \"ANEMR\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'ANEMR_0'  , \n        \n            'ANEMR_1'  , \n        \n            'ANEMR_2'  , \n        \n            'ANEMR_3'  , \n        \n            'ANEMR_4'  , \n        \n            'ANEMR_5'  , \n        \n            'ANEMR_6'  , \n        \n            'ANEMR_7'  , \n        \n            'ANEMR_8'  , \n        \n            'ANEMR_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'ANEMR_0' then 'emmenagement_moins_2_ans'\n            \n                when 'ANEMR_1' then 'emmenagement_2_4_ans'\n            \n                when 'ANEMR_2' then 'emmenagement_5_9_ans'\n            \n                when 'ANEMR_3' then 'emmenagement_10_19_ans'\n            \n                when 'ANEMR_4' then 'emmenagement_20_29_ans'\n            \n                when 'ANEMR_5' then 'emmenagement_30_39_ans'\n            \n                when 'ANEMR_6' then 'emmenagement_40_49_ans'\n            \n                when 'ANEMR_7' then 'emmenagement_50_59_ans'\n            \n                when 'ANEMR_8' then 'emmenagement_60_69_ans'\n            \n                when 'ANEMR_9' then 'emmenagement_plus_70_ans'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_moins_2_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_moins_2_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_2_4_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_2_4_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_5_9_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_5_9_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_10_19_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_10_19_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_20_29_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_20_29_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_30_39_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_30_39_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_40_49_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_40_49_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_50_59_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_50_59_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_60_69_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_60_69_ans\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'emmenagement_plus_70_ans'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"emmenagement_plus_70_ans\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('EGOUL' as TEXT) as \"champs\",\n      cast(  \n           \"EGOUL\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'EGOUL_1'  , \n        \n            'EGOUL_2'  , \n        \n            'EGOUL_3'  , \n        \n            'EGOUL_4' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'EGOUL_1' then 'dom__raccordement_egouts'\n            \n                when 'EGOUL_2' then 'dom__raccordement_fosse_septique'\n            \n                when 'EGOUL_3' then 'dom__raccordement_puisard'\n            \n                when 'EGOUL_4' then 'dom__evacuation_sol'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__raccordement_egouts'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__raccordement_egouts\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__raccordement_fosse_septique'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__raccordement_fosse_septique\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__raccordement_puisard'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__raccordement_puisard\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__evacuation_sol'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__evacuation_sol\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('GARL' as TEXT) as \"champs\",\n      cast(  \n           \"GARL\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'GARL_1'  , \n        \n            'GARL_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'GARL_1' then 'avec_emplacement_stationnement'\n            \n                when 'GARL_2' then 'sans_emplacement_stationnement'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'avec_emplacement_stationnement'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"avec_emplacement_stationnement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'sans_emplacement_stationnement'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"sans_emplacement_stationnement\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('CUIS' as TEXT) as \"champs\",\n      cast(  \n           \"CUIS\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'CUIS_1'  , \n        \n            'CUIS_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'CUIS_1' then 'dom__avec_cuisine_interieure_evier'\n            \n                when 'CUIS_2' then 'dom__sans_cuisine_interieure_evier'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__avec_cuisine_interieure_evier'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__avec_cuisine_interieure_evier\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__sans_cuisine_interieure_evier'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__sans_cuisine_interieure_evier\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('NBPI' as TEXT) as \"champs\",\n      cast(  \n           \"NBPI\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'NBPI_1'  , \n        \n            'NBPI_10'  , \n        \n            'NBPI_11'  , \n        \n            'NBPI_12'  , \n        \n            'NBPI_13'  , \n        \n            'NBPI_14'  , \n        \n            'NBPI_15'  , \n        \n            'NBPI_16'  , \n        \n            'NBPI_17'  , \n        \n            'NBPI_18'  , \n        \n            'NBPI_19'  , \n        \n            'NBPI_2'  , \n        \n            'NBPI_20'  , \n        \n            'NBPI_3'  , \n        \n            'NBPI_4'  , \n        \n            'NBPI_5'  , \n        \n            'NBPI_6'  , \n        \n            'NBPI_7'  , \n        \n            'NBPI_8'  , \n        \n            'NBPI_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'NBPI_1' then 'logements_avec_1_piece'\n            \n                when 'NBPI_10' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_11' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_12' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_13' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_14' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_15' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_16' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_17' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_18' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_19' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_2' then 'logements_avec_2_pieces'\n            \n                when 'NBPI_20' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_3' then 'logements_avec_3_pieces'\n            \n                when 'NBPI_4' then 'logements_avec_4_pieces'\n            \n                when 'NBPI_5' then 'logements_avec_5_pieces'\n            \n                when 'NBPI_6' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_7' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_8' then 'logements_avec_6_et_plus_pieces'\n            \n                when 'NBPI_9' then 'logements_avec_6_et_plus_pieces'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n        \n            \n        \n      \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n      \n        \n      \n        \n      \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_avec_1_piece'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_avec_1_piece\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_avec_6_et_plus_pieces'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_avec_6_et_plus_pieces\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_avec_2_pieces'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_avec_2_pieces\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_avec_3_pieces'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_avec_3_pieces\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_avec_4_pieces'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_avec_4_pieces\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_avec_5_pieces'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_avec_5_pieces\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('SURF' as TEXT) as \"champs\",\n      cast(  \n           \"SURF\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'SURF_1'  , \n        \n            'SURF_2'  , \n        \n            'SURF_3'  , \n        \n            'SURF_4'  , \n        \n            'SURF_5'  , \n        \n            'SURF_6'  , \n        \n            'SURF_7' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'SURF_1' then 'logements_moins_30_mc'\n            \n                when 'SURF_2' then 'logements_30_40_mc'\n            \n                when 'SURF_3' then 'logements_40_60_mc'\n            \n                when 'SURF_4' then 'logements_60_80_mc'\n            \n                when 'SURF_5' then 'logements_80_100_mc'\n            \n                when 'SURF_6' then 'logements_100_120_mc'\n            \n                when 'SURF_7' then 'logements_plus_120_mc'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_moins_30_mc'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_moins_30_mc\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_30_40_mc'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_30_40_mc\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_40_60_mc'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_40_60_mc\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_60_80_mc'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_60_80_mc\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_80_100_mc'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_80_100_mc\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_100_120_mc'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_100_120_mc\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logements_plus_120_mc'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logements_plus_120_mc\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('SANIDOM' as TEXT) as \"champs\",\n      cast(  \n           \"SANIDOM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'SANIDOM_11'  , \n        \n            'SANIDOM_12'  , \n        \n            'SANIDOM_21'  , \n        \n            'SANIDOM_22' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'SANIDOM_11' then 'dom__logement_avec_baignoire_ou_douche_avec_toilettes_interieures'\n            \n                when 'SANIDOM_12' then 'dom__logement_avec_baignoire_ou_douche_sans_toilettes_interieures'\n            \n                when 'SANIDOM_21' then 'dom__logement_ni_baignoire_ni_douche_avec_toilettes_interieures'\n            \n                when 'SANIDOM_22' then 'dom__logement_ni_baignoire_ni_douche'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__logement_avec_baignoire_ou_douche_avec_toilettes_interieures'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__logement_avec_baignoire_ou_douche_avec_toilettes_interieures\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__logement_avec_baignoire_ou_douche_sans_toilettes_interieures'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__logement_avec_baignoire_ou_douche_sans_toilettes_interieures\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__logement_ni_baignoire_ni_douche_avec_toilettes_interieures'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__logement_ni_baignoire_ni_douche_avec_toilettes_interieures\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__logement_ni_baignoire_ni_douche'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__logement_ni_baignoire_ni_douche\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('BATI' as TEXT) as \"champs\",\n      cast(  \n           \"BATI\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'BATI_1'  , \n        \n            'BATI_2'  , \n        \n            'BATI_3'  , \n        \n            'BATI_4' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'BATI_1' then 'dom__habitation_de_fortune'\n            \n                when 'BATI_2' then 'dom__cases_traditionnelles'\n            \n                when 'BATI_3' then 'dom__habitation_en_bois'\n            \n                when 'BATI_4' then 'dom__habitation_en_dur'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__habitation_de_fortune'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__habitation_de_fortune\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__cases_traditionnelles'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__cases_traditionnelles\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__habitation_en_bois'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__habitation_en_bois\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__habitation_en_dur'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__habitation_en_dur\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('CHAU' as TEXT) as \"champs\",\n      cast(  \n           \"CHAU\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'CHAU_1'  , \n        \n            'CHAU_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'CHAU_1' then 'dom__presence_chauffage'\n            \n                when 'CHAU_2' then 'dom__abscence_chauffage'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__presence_chauffage'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__presence_chauffage\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__abscence_chauffage'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__abscence_chauffage\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('CHOS' as TEXT) as \"champs\",\n      cast(  \n           \"CHOS\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'CHOS_1'  , \n        \n            'CHOS_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'CHOS_1' then 'dom__presence_chauffe_eau_solaire'\n            \n                when 'CHOS_2' then 'dom__abscence_chauffe_eau_solaire'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__presence_chauffe_eau_solaire'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__presence_chauffe_eau_solaire\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__abscence_chauffe_eau_solaire'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__abscence_chauffe_eau_solaire\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('HLML' as TEXT) as \"champs\",\n      cast(  \n           \"HLML\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'HLML_1'  , \n        \n            'HLML_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'HLML_1' then 'appartient_hlm'\n            \n                when 'HLML_2' then 'appartient_pas_hlm'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'appartient_hlm'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"appartient_hlm\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'appartient_pas_hlm'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"appartient_pas_hlm\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('TYPL' as TEXT) as \"champs\",\n      cast(  \n           \"TYPL\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'TYPL_1'  , \n        \n            'TYPL_2'  , \n        \n            'TYPL_3'  , \n        \n            'TYPL_4'  , \n        \n            'TYPL_5'  , \n        \n            'TYPL_6' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'TYPL_1' then 'logement_type_maison'\n            \n                when 'TYPL_2' then 'logement_type_appartement'\n            \n                when 'TYPL_3' then 'logement_type_appartement_foyer'\n            \n                when 'TYPL_4' then 'logement_type_chambre_hotel'\n            \n                when 'TYPL_5' then 'logement_type_habitation_fortune'\n            \n                when 'TYPL_6' then 'logement_type_piece_independante'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_maison'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_maison\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_appartement'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_appartement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_appartement_foyer'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_appartement_foyer\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_chambre_hotel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_chambre_hotel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_habitation_fortune'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_habitation_fortune\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_type_piece_independante'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_type_piece_independante\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('WC' as TEXT) as \"champs\",\n      cast(  \n           \"WC\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'WC_1'  , \n        \n            'WC_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'WC_1' then 'dom__logements_avec_wc_interieurs'\n            \n                when 'WC_2' then 'dom__logements_sans_wc_interieurs'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__logements_avec_wc_interieurs'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__logements_avec_wc_interieurs\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__logements_sans_wc_interieurs'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__logements_sans_wc_interieurs\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('SANI' as TEXT) as \"champs\",\n      cast(  \n           \"SANI\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'SANI_0'  , \n        \n            'SANI_1'  , \n        \n            'SANI_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'SANI_0' then 'metro__logement_ni_baignoire_ni_douche'\n            \n                when 'SANI_1' then 'metro__logement_avec_baignoire_ou_douche_hors_piece_reservee'\n            \n                when 'SANI_2' then 'metro__logement_salle_de_bain'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__logement_ni_baignoire_ni_douche'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__logement_ni_baignoire_ni_douche\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__logement_avec_baignoire_ou_douche_hors_piece_reservee'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__logement_avec_baignoire_ou_douche_hors_piece_reservee\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'metro__logement_salle_de_bain'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"metro__logement_salle_de_bain\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('BAIN' as TEXT) as \"champs\",\n      cast(  \n           \"BAIN\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'BAIN_1'  , \n        \n            'BAIN_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'BAIN_1' then 'dom__beignoire_ou_douche'\n            \n                when 'BAIN_2' then 'dom__ni_beignoire_ni_douche'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__beignoire_ou_douche'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__beignoire_ou_douche\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__ni_beignoire_ni_douche'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__ni_beignoire_ni_douche\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('ASCEN' as TEXT) as \"champs\",\n      cast(  \n           \"ASCEN\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'ASCEN_1'  , \n        \n            'ASCEN_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'ASCEN_1' then 'avec_ascensseur'\n            \n                when 'ASCEN_2' then 'sans_ascensseur'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'avec_ascensseur'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"avec_ascensseur\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'sans_ascensseur'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"sans_ascensseur\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('CATL' as TEXT) as \"champs\",\n      cast(  \n           \"CATL\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'CATL_1'  , \n        \n            'CATL_2'  , \n        \n            'CATL_3'  , \n        \n            'CATL_4' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'CATL_1' then 'residence_principale'\n            \n                when 'CATL_2' then 'logement_occasionnel'\n            \n                when 'CATL_3' then 'residence_secondaire'\n            \n                when 'CATL_4' then 'logement_vacant'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'residence_principale'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_principale\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_occasionnel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_occasionnel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'residence_secondaire'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"residence_secondaire\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'logement_vacant'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"logement_vacant\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('ELEC' as TEXT) as \"champs\",\n      cast(  \n           \"ELEC\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'ELEC_1'  , \n        \n            'ELEC_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'ELEC_1' then 'dom__avec_electricite'\n            \n                when 'ELEC_2' then 'dom__sans_electricite'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__avec_electricite'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__avec_electricite\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__sans_electricite'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__sans_electricite\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('EAU' as TEXT) as \"champs\",\n      cast(  \n           \"EAU\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'EAU_1'  , \n        \n            'EAU_2'  , \n        \n            'EAU_3' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'EAU_1' then 'dom__eau_froide_seulement'\n            \n                when 'EAU_2' then 'dom__eau_froide_et_chaude'\n            \n                when 'EAU_3' then 'dom__aucun_point_eau'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__eau_froide_seulement'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__eau_froide_seulement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__eau_froide_et_chaude'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__eau_froide_et_chaude\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__aucun_point_eau'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__aucun_point_eau\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n  )\n\nSELECT \n    *  \nFROM\n    aggregated", "relation_name": "\"defaultdb\".\"prepare\".\"habitat_iris\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:22.443967Z", "completed_at": "2024-09-23T21:33:25.555608Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:25.556856Z", "completed_at": "2024-09-23T21:33:25.556863Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.2227847576141357, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.mobilite_communes", "compiled": true, "compiled_code": "--- depends_on: \"defaultdb\".\"prepare\".\"logement_2020_valeurs\"\n\n--- Agr\u00e8ge les donn\u00e9es de la base logement par commune\n--- Colonne par colonne pour ne pas saturer la m\u00e9moire\n--- L'agr\u00e9gration est faite par univot/pivot.\n\n\n\n\n\n\n\n\n\n\n\n\nwith communes as (\n    SELECT \n      \"COMMUNE\" as code_commune_insee,\n      CAST( SUM(CAST(\"IPONDL\" AS numeric)) AS INT) AS nombre_de_logements\n    FROM \n      \"defaultdb\".\"sources\".\"logement_2020\"\n    GROUP BY\n      code_commune_insee\n  ),\n  aggregated as (\n\n    SELECT * \n\n    FROM communes\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('IMMIM' as TEXT) as \"champs\",\n      cast(  \n           \"IMMIM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'IMMIM_1'  , \n        \n            'IMMIM_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'IMMIM_1' then 'pr_immigration_immigre'\n            \n                when 'IMMIM_2' then 'pr_immigration_non_immigre'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_immigration_immigre'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_immigration_immigre\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_immigration_non_immigre'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_immigration_non_immigre\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('ILETUDM' as TEXT) as \"champs\",\n      cast(  \n           \"ILETUDM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'ILETUDM_1'  , \n        \n            'ILETUDM_2'  , \n        \n            'ILETUDM_3'  , \n        \n            'ILETUDM_4'  , \n        \n            'ILETUDM_5'  , \n        \n            'ILETUDM_6'  , \n        \n            'ILETUDM_7'  , \n        \n            'ILETUDM_Z' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'ILETUDM_1' then 'pr_etudes_commune_actuelle'\n            \n                when 'ILETUDM_2' then 'pr_etudes_commune_departement_actuel'\n            \n                when 'ILETUDM_3' then 'pr_etudes_department_region_actuel'\n            \n                when 'ILETUDM_4' then 'pr_etudes_hors_region_actuelle_metropole'\n            \n                when 'ILETUDM_5' then 'pr_etudes_hors_region_actuelle_dom'\n            \n                when 'ILETUDM_6' then 'pr_etudes_hors_region_actuelle_com'\n            \n                when 'ILETUDM_7' then 'pr_etudes_etranger'\n            \n                when 'ILETUDM_Z' then 'pr_etudes_sans_objet_non_inscrit'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_commune_actuelle'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_commune_actuelle\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_commune_departement_actuel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_commune_departement_actuel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_department_region_actuel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_department_region_actuel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_hors_region_actuelle_metropole'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_hors_region_actuelle_metropole\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_hors_region_actuelle_dom'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_hors_region_actuelle_dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_hors_region_actuelle_com'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_hors_region_actuelle_com\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_etranger'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_etranger\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_sans_objet_non_inscrit'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_sans_objet_non_inscrit\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('VOIT' as TEXT) as \"champs\",\n      cast(  \n           \"VOIT\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'VOIT_0'  , \n        \n            'VOIT_1'  , \n        \n            'VOIT_2'  , \n        \n            'VOIT_3' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'VOIT_0' then 'menages_0_voiture'\n            \n                when 'VOIT_1' then 'menages_1_voiture'\n            \n                when 'VOIT_2' then 'menages_2_voitures'\n            \n                when 'VOIT_3' then 'menages_3_et_plus_voitures'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_0_voiture'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_0_voiture\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_1_voiture'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_1_voiture\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_2_voitures'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_2_voitures\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_3_et_plus_voitures'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_3_et_plus_voitures\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('ILTM' as TEXT) as \"champs\",\n      cast(  \n           \"ILTM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'ILTM_1'  , \n        \n            'ILTM_2'  , \n        \n            'ILTM_3'  , \n        \n            'ILTM_4'  , \n        \n            'ILTM_5'  , \n        \n            'ILTM_6'  , \n        \n            'ILTM_7'  , \n        \n            'ILTM_Z' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'ILTM_1' then 'pr_travail_commune_actuelle'\n            \n                when 'ILTM_2' then 'pr_travail_commune_departement_actuel'\n            \n                when 'ILTM_3' then 'pr_travail_department_region_actuel'\n            \n                when 'ILTM_4' then 'pr_travail_hors_region_actuelle_metropole'\n            \n                when 'ILTM_5' then 'pr_travail_hors_region_actuelle_dom'\n            \n                when 'ILTM_6' then 'pr_travail_hors_region_actuelle_com'\n            \n                when 'ILTM_7' then 'pr_travail_etranger'\n            \n                when 'ILTM_Z' then 'pr_travail_sans_objet_sans_emploi'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_commune_actuelle'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_commune_actuelle\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_commune_departement_actuel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_commune_departement_actuel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_department_region_actuel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_department_region_actuel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_hors_region_actuelle_metropole'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_hors_region_actuelle_metropole\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_hors_region_actuelle_dom'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_hors_region_actuelle_dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_hors_region_actuelle_com'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_hors_region_actuelle_com\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_etranger'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_etranger\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_sans_objet_sans_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_sans_objet_sans_emploi\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('TRANSM' as TEXT) as \"champs\",\n      cast(  \n           \"TRANSM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'TRANSM_2'  , \n        \n            'TRANSM_3'  , \n        \n            'TRANSM_4'  , \n        \n            'TRANSM_5'  , \n        \n            'TRANSM_6' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'TRANSM_2' then 'menages_pr_transport_travail_pieds'\n            \n                when 'TRANSM_3' then 'menages_pr_transport_travail_velo'\n            \n                when 'TRANSM_4' then 'menages_pr_transport_travail_deux_roues'\n            \n                when 'TRANSM_5' then 'menages_pr_transport_travail_voiture'\n            \n                when 'TRANSM_6' then 'menages_pr_transport_travail_transport_commune'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_transport_travail_pieds'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_transport_travail_pieds\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_transport_travail_velo'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_transport_travail_velo\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_transport_travail_deux_roues'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_transport_travail_deux_roues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_transport_travail_voiture'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_transport_travail_voiture\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_transport_travail_transport_commune'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_transport_travail_transport_commune\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('DEROU' as TEXT) as \"champs\",\n      cast(  \n           \"DEROU\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'DEROU_0'  , \n        \n            'DEROU_1'  , \n        \n            'DEROU_2'  , \n        \n            'DEROU_3' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'DEROU_0' then 'dom__aucun_deux_roues'\n            \n                when 'DEROU_1' then 'dom__un_deux_roues'\n            \n                when 'DEROU_2' then 'dom__deux_deux_roues'\n            \n                when 'DEROU_3' then 'dom__trois_ou_plus_deux_roues'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__aucun_deux_roues'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__aucun_deux_roues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__un_deux_roues'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__un_deux_roues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__deux_deux_roues'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__deux_deux_roues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__trois_ou_plus_deux_roues'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__trois_ou_plus_deux_roues\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('IRANM' as TEXT) as \"champs\",\n      cast(  \n           \"IRANM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'IRANM_1'  , \n        \n            'IRANM_2'  , \n        \n            'IRANM_3'  , \n        \n            'IRANM_4'  , \n        \n            'IRANM_5'  , \n        \n            'IRANM_6'  , \n        \n            'IRANM_7'  , \n        \n            'IRANM_8'  , \n        \n            'IRANM_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'IRANM_1' then 'menages_avec_pr_annee_avant_meme_logement'\n            \n                when 'IRANM_2' then 'menages_avec_pr_annee_avant_meme_commune'\n            \n                when 'IRANM_3' then 'menages_avec_pr_annee_avant_meme_departement'\n            \n                when 'IRANM_4' then 'menages_avec_pr_annee_avant_meme_region'\n            \n                when 'IRANM_5' then 'menages_avec_pr_annee_avant_autre_region_metro'\n            \n                when 'IRANM_6' then 'menages_avec_pr_annee_avant_autre_region_dom'\n            \n                when 'IRANM_7' then 'menages_avec_pr_annee_avant_autre_region_com'\n            \n                when 'IRANM_8' then 'menages_avec_pr_annee_avant_union_europeenne'\n            \n                when 'IRANM_9' then 'menages_avec_pr_annee_avant_etranger'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_meme_logement'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_meme_logement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_meme_commune'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_meme_commune\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_meme_departement'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_meme_departement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_meme_region'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_meme_region\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_autre_region_metro'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_autre_region_metro\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_autre_region_dom'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_autre_region_dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_autre_region_com'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_autre_region_com\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_union_europeenne'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_union_europeenne\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_etranger'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_etranger\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INAIM' as TEXT) as \"champs\",\n      cast(  \n           \"INAIM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"COMMUNE\" as  code_commune_insee, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INAIM_1'  , \n        \n            'INAIM_2'  , \n        \n            'INAIM_3'  , \n        \n            'INAIM_4'  , \n        \n            'INAIM_5'  , \n        \n            'INAIM_6' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_commune_insee,\n        CASE champs_valeur\n            \n                when 'INAIM_1' then 'pr_naissance_department_actuelle'\n            \n                when 'INAIM_2' then 'pr_naissance_department_region_actuelle'\n            \n                when 'INAIM_3' then 'pr_naissance_hors_region_actuelle_metropole'\n            \n                when 'INAIM_4' then 'pr_naissance_hors_region_actuelle_dom'\n            \n                when 'INAIM_5' then 'pr_naissance_hors_region_actuelle_com'\n            \n                when 'INAIM_6' then 'pr_naissance_etranger'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_commune_insee,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_commune_insee,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_naissance_department_actuelle'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_naissance_department_actuelle\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_naissance_department_region_actuelle'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_naissance_department_region_actuelle\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_naissance_hors_region_actuelle_metropole'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_naissance_hors_region_actuelle_metropole\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_naissance_hors_region_actuelle_dom'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_naissance_hors_region_actuelle_dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_naissance_hors_region_actuelle_com'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_naissance_hors_region_actuelle_com\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_naissance_etranger'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_naissance_etranger\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_commune_insee\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_commune_insee)\n\n    \n\n  ),\n  aggregated_with_infos_communes as (\n    SELECT\n      *\n    FROM\n      aggregated\n    JOIN\n\t    \"defaultdb\".\"prepare\".\"infos_communes\" as infos_communes\n    ON\n      aggregated.code_commune_insee = infos_communes.code_commune\n  )\n\nSELECT \n    *  \nFROM\n    aggregated_with_infos_communes", "relation_name": "\"defaultdb\".\"prepare\".\"mobilite_communes\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:25.668273Z", "completed_at": "2024-09-23T21:33:28.796779Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:28.797997Z", "completed_at": "2024-09-23T21:33:28.798005Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.2412660121917725, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.mobilite_iris", "compiled": true, "compiled_code": "--- depends_on: \"defaultdb\".\"prepare\".\"logement_2020_valeurs\"\n\n--- Agr\u00e8ge les donn\u00e9es de la base logement par commune\n--- Colonne par colonne pour ne pas saturer la m\u00e9moire\n--- L'agr\u00e9gration est faite par univot/pivot.\n\n\n\n\n\n\n\n\n\n\n\n\nwith iris as (\n    SELECT \n      \"IRIS\" as code_iris,\n      CAST( SUM(CAST(\"IPONDL\" AS numeric)) AS INT) AS nombre_de_logements\n    FROM \n      \"defaultdb\".\"sources\".\"logement_2020\"\n    GROUP BY\n      code_iris\n  ),\n  aggregated as (\n\n    SELECT * \n\n    FROM iris\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('IMMIM' as TEXT) as \"champs\",\n      cast(  \n           \"IMMIM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'IMMIM_1'  , \n        \n            'IMMIM_2' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'IMMIM_1' then 'pr_immigration_immigre'\n            \n                when 'IMMIM_2' then 'pr_immigration_non_immigre'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_immigration_immigre'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_immigration_immigre\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_immigration_non_immigre'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_immigration_non_immigre\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('ILETUDM' as TEXT) as \"champs\",\n      cast(  \n           \"ILETUDM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'ILETUDM_1'  , \n        \n            'ILETUDM_2'  , \n        \n            'ILETUDM_3'  , \n        \n            'ILETUDM_4'  , \n        \n            'ILETUDM_5'  , \n        \n            'ILETUDM_6'  , \n        \n            'ILETUDM_7'  , \n        \n            'ILETUDM_Z' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'ILETUDM_1' then 'pr_etudes_commune_actuelle'\n            \n                when 'ILETUDM_2' then 'pr_etudes_commune_departement_actuel'\n            \n                when 'ILETUDM_3' then 'pr_etudes_department_region_actuel'\n            \n                when 'ILETUDM_4' then 'pr_etudes_hors_region_actuelle_metropole'\n            \n                when 'ILETUDM_5' then 'pr_etudes_hors_region_actuelle_dom'\n            \n                when 'ILETUDM_6' then 'pr_etudes_hors_region_actuelle_com'\n            \n                when 'ILETUDM_7' then 'pr_etudes_etranger'\n            \n                when 'ILETUDM_Z' then 'pr_etudes_sans_objet_non_inscrit'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_commune_actuelle'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_commune_actuelle\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_commune_departement_actuel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_commune_departement_actuel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_department_region_actuel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_department_region_actuel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_hors_region_actuelle_metropole'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_hors_region_actuelle_metropole\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_hors_region_actuelle_dom'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_hors_region_actuelle_dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_hors_region_actuelle_com'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_hors_region_actuelle_com\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_etranger'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_etranger\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_etudes_sans_objet_non_inscrit'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_etudes_sans_objet_non_inscrit\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('VOIT' as TEXT) as \"champs\",\n      cast(  \n           \"VOIT\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'VOIT_0'  , \n        \n            'VOIT_1'  , \n        \n            'VOIT_2'  , \n        \n            'VOIT_3' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'VOIT_0' then 'menages_0_voiture'\n            \n                when 'VOIT_1' then 'menages_1_voiture'\n            \n                when 'VOIT_2' then 'menages_2_voitures'\n            \n                when 'VOIT_3' then 'menages_3_et_plus_voitures'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_0_voiture'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_0_voiture\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_1_voiture'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_1_voiture\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_2_voitures'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_2_voitures\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_3_et_plus_voitures'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_3_et_plus_voitures\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('ILTM' as TEXT) as \"champs\",\n      cast(  \n           \"ILTM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'ILTM_1'  , \n        \n            'ILTM_2'  , \n        \n            'ILTM_3'  , \n        \n            'ILTM_4'  , \n        \n            'ILTM_5'  , \n        \n            'ILTM_6'  , \n        \n            'ILTM_7'  , \n        \n            'ILTM_Z' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'ILTM_1' then 'pr_travail_commune_actuelle'\n            \n                when 'ILTM_2' then 'pr_travail_commune_departement_actuel'\n            \n                when 'ILTM_3' then 'pr_travail_department_region_actuel'\n            \n                when 'ILTM_4' then 'pr_travail_hors_region_actuelle_metropole'\n            \n                when 'ILTM_5' then 'pr_travail_hors_region_actuelle_dom'\n            \n                when 'ILTM_6' then 'pr_travail_hors_region_actuelle_com'\n            \n                when 'ILTM_7' then 'pr_travail_etranger'\n            \n                when 'ILTM_Z' then 'pr_travail_sans_objet_sans_emploi'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_commune_actuelle'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_commune_actuelle\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_commune_departement_actuel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_commune_departement_actuel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_department_region_actuel'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_department_region_actuel\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_hors_region_actuelle_metropole'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_hors_region_actuelle_metropole\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_hors_region_actuelle_dom'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_hors_region_actuelle_dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_hors_region_actuelle_com'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_hors_region_actuelle_com\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_etranger'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_etranger\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_travail_sans_objet_sans_emploi'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_travail_sans_objet_sans_emploi\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('TRANSM' as TEXT) as \"champs\",\n      cast(  \n           \"TRANSM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'TRANSM_2'  , \n        \n            'TRANSM_3'  , \n        \n            'TRANSM_4'  , \n        \n            'TRANSM_5'  , \n        \n            'TRANSM_6' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'TRANSM_2' then 'menages_pr_transport_travail_pieds'\n            \n                when 'TRANSM_3' then 'menages_pr_transport_travail_velo'\n            \n                when 'TRANSM_4' then 'menages_pr_transport_travail_deux_roues'\n            \n                when 'TRANSM_5' then 'menages_pr_transport_travail_voiture'\n            \n                when 'TRANSM_6' then 'menages_pr_transport_travail_transport_commune'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_transport_travail_pieds'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_transport_travail_pieds\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_transport_travail_velo'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_transport_travail_velo\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_transport_travail_deux_roues'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_transport_travail_deux_roues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_transport_travail_voiture'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_transport_travail_voiture\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_pr_transport_travail_transport_commune'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_pr_transport_travail_transport_commune\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('DEROU' as TEXT) as \"champs\",\n      cast(  \n           \"DEROU\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'DEROU_0'  , \n        \n            'DEROU_1'  , \n        \n            'DEROU_2'  , \n        \n            'DEROU_3' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'DEROU_0' then 'dom__aucun_deux_roues'\n            \n                when 'DEROU_1' then 'dom__un_deux_roues'\n            \n                when 'DEROU_2' then 'dom__deux_deux_roues'\n            \n                when 'DEROU_3' then 'dom__trois_ou_plus_deux_roues'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__aucun_deux_roues'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__aucun_deux_roues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__un_deux_roues'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__un_deux_roues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__deux_deux_roues'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__deux_deux_roues\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'dom__trois_ou_plus_deux_roues'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"dom__trois_ou_plus_deux_roues\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('IRANM' as TEXT) as \"champs\",\n      cast(  \n           \"IRANM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'IRANM_1'  , \n        \n            'IRANM_2'  , \n        \n            'IRANM_3'  , \n        \n            'IRANM_4'  , \n        \n            'IRANM_5'  , \n        \n            'IRANM_6'  , \n        \n            'IRANM_7'  , \n        \n            'IRANM_8'  , \n        \n            'IRANM_9' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'IRANM_1' then 'menages_avec_pr_annee_avant_meme_logement'\n            \n                when 'IRANM_2' then 'menages_avec_pr_annee_avant_meme_commune'\n            \n                when 'IRANM_3' then 'menages_avec_pr_annee_avant_meme_departement'\n            \n                when 'IRANM_4' then 'menages_avec_pr_annee_avant_meme_region'\n            \n                when 'IRANM_5' then 'menages_avec_pr_annee_avant_autre_region_metro'\n            \n                when 'IRANM_6' then 'menages_avec_pr_annee_avant_autre_region_dom'\n            \n                when 'IRANM_7' then 'menages_avec_pr_annee_avant_autre_region_com'\n            \n                when 'IRANM_8' then 'menages_avec_pr_annee_avant_union_europeenne'\n            \n                when 'IRANM_9' then 'menages_avec_pr_annee_avant_etranger'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_meme_logement'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_meme_logement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_meme_commune'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_meme_commune\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_meme_departement'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_meme_departement\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_meme_region'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_meme_region\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_autre_region_metro'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_autre_region_metro\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_autre_region_dom'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_autre_region_dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_autre_region_com'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_autre_region_com\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_union_europeenne'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_union_europeenne\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'menages_avec_pr_annee_avant_etranger'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"menages_avec_pr_annee_avant_etranger\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n      LEFT JOIN ( \n\n\n\n\n\n\n\nwith unpivoted as (\n      \n\n\n-- Prends toutes les colonnes sauf la colonne \u00e0 consid\u00e9rer, pour donne en param\u00e8tre \u00e0 unpivot\n  \n\n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n    \n      \n    \n  \n\n\n    select\n        \"COMMUNE\",\n        \"IPONDL\",\n        \"IRIS\",\n\n      cast('INAIM' as TEXT) as \"champs\",\n      cast(  \n           \"INAIM\"\n             \n           as varchar) as \"valeur\"\n\n    from \"defaultdb\".\"sources\".\"logement_2020\"\n\n    \n\n), \nunpivot_filtree as (\n        \n\n    SELECT\n        \"IRIS\" as  code_iris, \n        CAST(\"IPONDL\" as NUMERIC) as poids_du_logement,\n        champs || '_' || valeur AS champs_valeur\n    FROM\n        unpivoted\n    WHERE\n        champs || '_' || valeur in (\n        \n            'INAIM_1'  , \n        \n            'INAIM_2'  , \n        \n            'INAIM_3'  , \n        \n            'INAIM_4'  , \n        \n            'INAIM_5'  , \n        \n            'INAIM_6' \n        )\n\n\n),\nrenommee as (\n        \n    SELECT\n        code_iris,\n        CASE champs_valeur\n            \n                when 'INAIM_1' then 'pr_naissance_department_actuelle'\n            \n                when 'INAIM_2' then 'pr_naissance_department_region_actuelle'\n            \n                when 'INAIM_3' then 'pr_naissance_hors_region_actuelle_metropole'\n            \n                when 'INAIM_4' then 'pr_naissance_hors_region_actuelle_dom'\n            \n                when 'INAIM_5' then 'pr_naissance_hors_region_actuelle_com'\n            \n                when 'INAIM_6' then 'pr_naissance_etranger'\n            \n        END AS champs_valeur_renomme,\n        CAST(SUM(CAST(poids_du_logement as NUMERIC)) AS INT) as population_par_champs_valeur\n    FROM\n        unpivot_filtree\n    GROUP BY\n        code_iris,\n        champs_valeur_renomme\n\n),\npivoted as (\n        \n\n    \n    \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n        \n            \n        \n      \n\n    select \n\n    code_iris,\n    \n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_naissance_department_actuelle'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_naissance_department_actuelle\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_naissance_department_region_actuelle'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_naissance_department_region_actuelle\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_naissance_hors_region_actuelle_metropole'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_naissance_hors_region_actuelle_metropole\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_naissance_hors_region_actuelle_dom'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_naissance_hors_region_actuelle_dom\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_naissance_hors_region_actuelle_com'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_naissance_hors_region_actuelle_com\"\n      \n    \n    ,\n  \n    sum(\n      \n      case\n      when champs_valeur_renomme = 'pr_naissance_etranger'\n        then population_par_champs_valeur\n      else 0\n      end\n    )\n    \n      \n            as \"pr_naissance_etranger\"\n      \n    \n    \n  \n\n    from \n        renommee\n    group by\n        code_iris\n\n\n)\n\nselect * from pivoted\n  )\n      USING (code_iris)\n\n    \n\n  )\n\nSELECT \n    *  \nFROM\n    aggregated", "relation_name": "\"defaultdb\".\"prepare\".\"mobilite_iris\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:28.910907Z", "completed_at": "2024-09-23T21:33:28.915164Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:28.916407Z", "completed_at": "2024-09-23T21:33:28.916412Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007783651351928711, "adapter_response": {}, "message": null, "failures": null, "unique_id": "model.makeopendata.mutations_foncieres_enrichies", "compiled": true, "compiled_code": "-- Enrichie la base dvf group\u00e9e par mutation\n-- Ajoute le knn des prix au m2\n\n\n\nWITH dvf_knn_5 as(\n    \nWITH knn AS (\n    SELECT \n        a.id_mutation AS id,\n        AVG(b.prix_m2) AS prix_m2_knn_5\n    FROM \n        \"defaultdb\".\"intermediaires\".\"mutations_foncieres\" a\n        JOIN LATERAL (\n            SELECT prix_m2\n            FROM \"defaultdb\".\"intermediaires\".\"mutations_foncieres\"\n            WHERE (id_mutation != a.id_mutation)\n            ORDER BY a.geopoint <-> geopoint\n            LIMIT 5\n        ) b ON TRUE\n    GROUP BY a.id_mutation\n)\n\nSELECT * FROM knn\n\n\n\n)\n\nselect mutations_foncieres.*, \n       dvf_knn_5.prix_m2_knn_5 \nfrom \"defaultdb\".\"intermediaires\".\"mutations_foncieres\" mutations_foncieres\nleft join dvf_knn_5 on dvf_knn_5.id = mutations_foncieres.id_mutation", "relation_name": "\"defaultdb\".\"prepare\".\"mutations_foncieres_enrichies\""}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:28.919988Z", "completed_at": "2024-09-23T21:33:28.924352Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:28.925521Z", "completed_at": "2024-09-23T21:33:28.925525Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00778508186340332, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_mutations_foncieres_id_mutation.7653319336", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect id_mutation\nfrom \"defaultdb\".\"intermediaires\".\"mutations_foncieres\"\nwhere id_mutation is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:28.929073Z", "completed_at": "2024-09-23T21:33:28.933085Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:28.934283Z", "completed_at": "2024-09-23T21:33:28.934287Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007382869720458984, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_mutations_foncieres_id_mutation.5f27073ab2", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    id_mutation as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"intermediaires\".\"mutations_foncieres\"\nwhere id_mutation is not null\ngroup by id_mutation\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:28.937789Z", "completed_at": "2024-09-23T21:33:28.941986Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:28.943150Z", "completed_at": "2024-09-23T21:33:28.943155Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007514238357543945, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_professionels_sante_departement_departement.2b0d9839bd", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect departement\nfrom \"defaultdb\".\"prepare\".\"professionels_sante_departement\"\nwhere departement is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:28.946725Z", "completed_at": "2024-09-23T21:33:28.950716Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:28.951885Z", "completed_at": "2024-09-23T21:33:28.951890Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007398366928100586, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_professionels_sante_departement_libelle_departement.3f71960534", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect libelle_departement\nfrom \"defaultdb\".\"prepare\".\"professionels_sante_departement\"\nwhere libelle_departement is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:28.955440Z", "completed_at": "2024-09-23T21:33:28.959480Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:28.960662Z", "completed_at": "2024-09-23T21:33:28.960667Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007437705993652344, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_professionels_sante_departement_libelle_region.350a716b1b", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect libelle_region\nfrom \"defaultdb\".\"prepare\".\"professionels_sante_departement\"\nwhere libelle_region is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:28.964159Z", "completed_at": "2024-09-23T21:33:28.968146Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:28.969327Z", "completed_at": "2024-09-23T21:33:28.969332Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007292985916137695, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_professionels_sante_departement_region.204f3127e8", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect region\nfrom \"defaultdb\".\"prepare\".\"professionels_sante_departement\"\nwhere region is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:28.972842Z", "completed_at": "2024-09-23T21:33:28.976730Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:28.977881Z", "completed_at": "2024-09-23T21:33:28.977886Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007188081741333008, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_professionels_sante_departement_departement.075a531ca0", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    departement as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prepare\".\"professionels_sante_departement\"\nwhere departement is not null\ngroup by departement\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:28.981408Z", "completed_at": "2024-09-23T21:33:28.985362Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:28.986519Z", "completed_at": "2024-09-23T21:33:28.986524Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007284402847290039, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_professionels_sante_departement_libelle_departement.ca5b280ea3", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    libelle_departement as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prepare\".\"professionels_sante_departement\"\nwhere libelle_departement is not null\ngroup by libelle_departement\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:28.990037Z", "completed_at": "2024-09-23T21:33:28.995850Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:28.996997Z", "completed_at": "2024-09-23T21:33:28.997002Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009163379669189453, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_activite_communes_code_commune_insee.705d4ded03", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect code_commune_insee\nfrom \"defaultdb\".\"prepare\".\"activite_communes\"\nwhere code_commune_insee is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.000546Z", "completed_at": "2024-09-23T21:33:29.004364Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.005494Z", "completed_at": "2024-09-23T21:33:29.005499Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007179975509643555, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_activite_communes_code_commune_insee.a16d20ff24", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    code_commune_insee as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prepare\".\"activite_communes\"\nwhere code_commune_insee is not null\ngroup by code_commune_insee\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.009017Z", "completed_at": "2024-09-23T21:33:29.012993Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.014146Z", "completed_at": "2024-09-23T21:33:29.014150Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007339000701904297, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_activite_iris_code_iris.d48378cef2", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect code_iris\nfrom \"defaultdb\".\"prepare\".\"activite_iris\"\nwhere code_iris is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.017651Z", "completed_at": "2024-09-23T21:33:29.021537Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.022716Z", "completed_at": "2024-09-23T21:33:29.022720Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007234811782836914, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_activite_iris_code_iris.a827b233ce", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    code_iris as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prepare\".\"activite_iris\"\nwhere code_iris is not null\ngroup by code_iris\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.026305Z", "completed_at": "2024-09-23T21:33:29.030588Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.031764Z", "completed_at": "2024-09-23T21:33:29.031768Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007712364196777344, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_demographie_communes_code_commune_insee.a06d1c158d", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect code_commune_insee\nfrom \"defaultdb\".\"prepare\".\"demographie_communes\"\nwhere code_commune_insee is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.035293Z", "completed_at": "2024-09-23T21:33:29.039154Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.040328Z", "completed_at": "2024-09-23T21:33:29.040333Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0071697235107421875, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_demographie_communes_code_commune_insee.99a323b9a8", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    code_commune_insee as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prepare\".\"demographie_communes\"\nwhere code_commune_insee is not null\ngroup by code_commune_insee\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.043851Z", "completed_at": "2024-09-23T21:33:29.047803Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.048953Z", "completed_at": "2024-09-23T21:33:29.048958Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0073125362396240234, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_demographie_iris_code_iris.5e934d266a", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect code_iris\nfrom \"defaultdb\".\"prepare\".\"demographie_iris\"\nwhere code_iris is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.052471Z", "completed_at": "2024-09-23T21:33:29.056412Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.057583Z", "completed_at": "2024-09-23T21:33:29.057588Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007266521453857422, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_demographie_iris_code_iris.6f4a6d41ff", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    code_iris as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prepare\".\"demographie_iris\"\nwhere code_iris is not null\ngroup by code_iris\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.061068Z", "completed_at": "2024-09-23T21:33:29.065087Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.066249Z", "completed_at": "2024-09-23T21:33:29.066269Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.0073125362396240234, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_habitat_communes_code_commune_insee.4bfaea56ce", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect code_commune_insee\nfrom \"defaultdb\".\"prepare\".\"habitat_communes\"\nwhere code_commune_insee is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.069774Z", "completed_at": "2024-09-23T21:33:29.073635Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.074778Z", "completed_at": "2024-09-23T21:33:29.074783Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007141590118408203, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_habitat_communes_code_commune_insee.31652939ba", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    code_commune_insee as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prepare\".\"habitat_communes\"\nwhere code_commune_insee is not null\ngroup by code_commune_insee\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.078429Z", "completed_at": "2024-09-23T21:33:29.084123Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.085288Z", "completed_at": "2024-09-23T21:33:29.085293Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.009156227111816406, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_habitat_iris_code_iris.f403285d90", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect code_iris\nfrom \"defaultdb\".\"prepare\".\"habitat_iris\"\nwhere code_iris is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.088790Z", "completed_at": "2024-09-23T21:33:29.092609Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.093765Z", "completed_at": "2024-09-23T21:33:29.093770Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.00712895393371582, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_habitat_iris_code_iris.e938aeede9", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    code_iris as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prepare\".\"habitat_iris\"\nwhere code_iris is not null\ngroup by code_iris\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.097283Z", "completed_at": "2024-09-23T21:33:29.101397Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.102568Z", "completed_at": "2024-09-23T21:33:29.102573Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007443428039550781, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_mobilite_communes_code_commune_insee.3ff1215dfa", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect code_commune_insee\nfrom \"defaultdb\".\"prepare\".\"mobilite_communes\"\nwhere code_commune_insee is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.106124Z", "completed_at": "2024-09-23T21:33:29.110117Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.111297Z", "completed_at": "2024-09-23T21:33:29.111303Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007395029067993164, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_mobilite_communes_code_commune_insee.0bb420935f", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    code_commune_insee as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prepare\".\"mobilite_communes\"\nwhere code_commune_insee is not null\ngroup by code_commune_insee\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.114876Z", "completed_at": "2024-09-23T21:33:29.118967Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.120111Z", "completed_at": "2024-09-23T21:33:29.120115Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007474660873413086, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_mobilite_iris_code_iris.3dccdfc834", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect code_iris\nfrom \"defaultdb\".\"prepare\".\"mobilite_iris\"\nwhere code_iris is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.123652Z", "completed_at": "2024-09-23T21:33:29.127867Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.129051Z", "completed_at": "2024-09-23T21:33:29.129056Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007607936859130859, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_mobilite_iris_code_iris.1d6c4aa554", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    code_iris as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prepare\".\"mobilite_iris\"\nwhere code_iris is not null\ngroup by code_iris\nhaving count(*) > 1\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.132629Z", "completed_at": "2024-09-23T21:33:29.136765Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.137925Z", "completed_at": "2024-09-23T21:33:29.137930Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007546424865722656, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.not_null_mutations_foncieres_enrichies_id_mutation.69469c1753", "compiled": true, "compiled_code": "\n    \n    \n\n\n\nselect id_mutation\nfrom \"defaultdb\".\"prepare\".\"mutations_foncieres_enrichies\"\nwhere id_mutation is null\n\n\n", "relation_name": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-09-23T21:33:29.141477Z", "completed_at": "2024-09-23T21:33:29.145389Z"}, {"name": "execute", "started_at": "2024-09-23T21:33:29.146554Z", "completed_at": "2024-09-23T21:33:29.146559Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.007278919219970703, "adapter_response": {}, "message": null, "failures": null, "unique_id": "test.makeopendata.unique_mutations_foncieres_enrichies_id_mutation.eaae35cfca", "compiled": true, "compiled_code": "\n    \n    \n\nselect\n    id_mutation as unique_field,\n    count(*) as n_records\n\nfrom \"defaultdb\".\"prepare\".\"mutations_foncieres_enrichies\"\nwhere id_mutation is not null\ngroup by id_mutation\nhaving count(*) > 1\n\n\n", "relation_name": null}], "elapsed_time": 44.12705063819885, "args": {"log_path": "/home/runner/work/make-open-data/make-open-data/logs", "select": [], "defer": false, "vars": {}, "invocation_command": "dbt docs generate", "log_file_max_bytes": 10485760, "quiet": false, "strict_mode": false, "write_json": true, "introspect": true, "show_resource_report": false, "macro_debugging": false, "cache_selected_only": false, "partial_parse_file_diff": true, "indirect_selection": "eager", "log_level_file": "debug", "log_level": "info", "exclude": [], "version_check": true, "warn_error_options": {"include": [], "exclude": []}, "print": true, "static": false, "profiles_dir": ".", "log_format": "default", "log_format_file": "debug", "which": "generate", "printer_width": 80, "use_colors": true, "empty_catalog": false, "send_anonymous_usage_stats": true, "favor_state": false, "enable_legacy_logger": false, "use_colors_file": true, "compile": true, "populate_cache": true, "project_dir": "/home/runner/work/make-open-data/make-open-data", "static_parser": true, "partial_parse": true}}